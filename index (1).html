<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Conduit Investors ‚Äî London CRE Intelligence</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400;1,600&family=DM+Sans:wght@300;400;500;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<style>
:root{
  --navy:#1C3355;--navy2:#254470;--navy3:#0F1F35;
  --gold:#B8922A;--gold2:#D4A843;--gold3:#7A5C0A;
  --cream:#F9F6F0;--paper:#F0EBE1;--warm:#FAF8F4;
  --white:#FFFFFF;--rule:#E2D9CC;--rule2:#C8BCA8;
  --mid:#5A6E82;--dark:#1A2230;--text:#1A2230;
  --green:#1A5C3A;--gbg:#EBF5EF;--gbdr:#A8D8B8;
  --amber:#7A4A00;--abg:#FFF4E0;--abdr:#D4A843;
  --red:#8A1C1C;--rbg:#FDF0F0;
  --blue:#1A3C6A;--bbg:#EBF0F8;
}
*{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{background:var(--cream);color:var(--text);font-family:'DM Sans',sans-serif;font-size:16px;font-weight:400;line-height:1.7;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
p{color:var(--text);line-height:1.8}
.dnil{color:var(--mid)}
/* MASTHEAD */
.mast{background:var(--navy3);border-bottom:3px solid var(--gold)}
.mast-i{max-width:1380px;margin:0 auto;padding:0 36px;display:flex;align-items:center;justify-content:space-between;height:72px}
.logo{display:flex;align-items:center;gap:14px}
.logo-mark{width:34px;height:34px;background:var(--gold);border-radius:3px;display:flex;align-items:center;justify-content:center;font-family:'Cormorant Garamond',serif;font-size:19px;font-weight:700;color:var(--navy3)}
.logo-name{font-family:'Cormorant Garamond',serif;font-size:21px;font-weight:600;color:#fff;letter-spacing:.03em}
.logo-pipe{width:1px;height:16px;background:rgba(255,255,255,.18);margin:0 2px}
.logo-sub{font-size:11px;font-weight:500;letter-spacing:.16em;text-transform:uppercase;color:var(--gold2)}
.mast-r{display:flex;align-items:center;gap:12px}
.mast-date{font-size:12px;color:rgba(255,255,255,.65);letter-spacing:.04em}
.btn-key{background:none;border:1.5px solid rgba(255,255,255,.18);border-radius:6px;padding:7px 14px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;color:rgba(255,255,255,.55);cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-key:hover{border-color:var(--gold);color:var(--gold)}
.btn-key.set{border-color:#3dd68c;color:#3dd68c;background:rgba(26,92,58,.12)}
.btn-share{background:var(--gold);border:none;border-radius:6px;padding:8px 16px;font-family:'DM Sans',sans-serif;font-size:13px;font-weight:700;color:#fff;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn-share:hover{background:var(--gold2);transform:translateY(-1px)}
/* NAV */
.nav{background:var(--white);border-bottom:1.5px solid var(--rule);box-shadow:0 1px 10px rgba(28,51,85,.05);position:sticky;top:0;z-index:200}
.nav-i{max-width:1380px;margin:0 auto;padding:0 36px;display:flex;overflow-x:auto}
.nb{font-family:'DM Sans',sans-serif;font-size:13px;font-weight:500;color:var(--mid);background:none;border:none;border-bottom:3px solid transparent;padding:17px 18px 14px;cursor:pointer;letter-spacing:.02em;transition:color .18s,border-color .18s;white-space:nowrap;display:flex;align-items:center;gap:6px}
.nb:hover{color:var(--navy)}
.nb.on{color:var(--navy);border-bottom-color:var(--gold);font-weight:700}
.nb .ic{font-size:15px}
.nbct{display:none;min-width:18px;height:18px;background:var(--gold);color:#fff;border-radius:9px;font-size:10px;font-weight:700;padding:0 5px;align-items:center;justify-content:center;margin-left:3px}
.nbct.on{display:inline-flex}
/* PAGES */
.pg{max-width:1380px;margin:0 auto;padding:40px 36px 100px;display:none}
.pg.on{display:block}
/* TYPE */
.eyebrow{font-size:11px;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:var(--gold3);margin-bottom:6px}
.pg-title{font-family:'Cormorant Garamond',serif;font-size:40px;font-weight:600;color:var(--navy3);line-height:1.1;margin-bottom:8px}
.pg-sub{font-size:16px;color:#4a5e6e;margin-bottom:32px;font-weight:300}
.sh{font-family:'Cormorant Garamond',serif;font-size:24px;font-weight:600;color:var(--navy);border-bottom:1.5px solid var(--rule);padding-bottom:9px;margin:36px 0 18px}
.sh-sm{font-family:'Cormorant Garamond',serif;font-size:19px;font-weight:600;color:var(--navy);margin-bottom:10px}
/* CARDS */
.card{background:var(--white);border:1px solid var(--rule);border-radius:12px;padding:26px 30px;box-shadow:0 1px 14px rgba(28,51,85,.05);margin-bottom:22px}
.card-gold{border-left:4px solid var(--gold)}
.card-navy{background:var(--navy3);color:#fff;border:none}
/* INSTR */
.instr{background:var(--paper);border-left:4px solid var(--gold);border-radius:0 8px 8px 0;padding:18px 24px;margin-bottom:22px;font-size:15px;line-height:1.75}
.instr strong{color:var(--navy);font-weight:700}
/* STAT STRIP */
.stat-strip{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:1px;background:var(--rule);border:1px solid var(--rule);border-radius:12px;overflow:hidden;margin-bottom:24px}
.stat-cell{background:var(--white);padding:18px 20px}
.stat-label{font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:5px}
.stat-val{font-family:'Cormorant Garamond',serif;font-size:30px;font-weight:700;color:var(--navy3);line-height:1;margin-bottom:2px}
.stat-val.nil{font-size:16px;color:var(--rule2);font-style:italic;font-family:'DM Sans',sans-serif;font-weight:300}
.stat-src{font-size:11px;color:var(--mid)}
/* FORM */
.fl{display:block;font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--navy);margin-bottom:6px}
.fh{font-size:13px;color:var(--mid);margin-top:4px}
.fg{margin-bottom:20px}
textarea,input[type=text],input[type=date],input[type=number],select{width:100%;font-family:'DM Sans',sans-serif;font-size:15px;color:var(--text);background:var(--warm);border:1.5px solid var(--rule);border-radius:8px;padding:11px 15px;outline:none;transition:border-color .2s,box-shadow .2s;line-height:1.6}
textarea:focus,input:focus,select:focus{border-color:var(--navy);box-shadow:0 0 0 3px rgba(28,51,85,.08);background:var(--white)}
textarea{resize:vertical}
/* BUTTONS */
.btn{display:inline-flex;align-items:center;gap:7px;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:700;padding:11px 22px;border-radius:8px;border:none;cursor:pointer;transition:all .18s;white-space:nowrap}
.bn{background:var(--navy);color:#fff;box-shadow:0 3px 12px rgba(28,51,85,.18)}
.bn:hover:not(:disabled){background:var(--navy2);transform:translateY(-1px)}
.bn:disabled{background:#8A9BB0;cursor:not-allowed}
.bg_{background:var(--gold);color:#fff}
.bg_:hover{background:var(--gold2);transform:translateY(-1px)}
.bo{background:transparent;color:var(--navy);border:1.5px solid var(--navy)}
.bo:hover{background:var(--navy);color:#fff}
.br_{background:transparent;color:var(--red);border:1.5px solid rgba(138,28,28,.25);font-size:12px;padding:7px 14px}
.br_:hover{background:var(--rbg)}
.bsm{font-size:12px;padding:8px 16px;border-radius:7px}
.blg{font-size:17px;padding:16px 40px;border-radius:10px;box-shadow:0 4px 18px rgba(28,51,85,.22)}
/* BADGE */
.badge{display:inline-block;font-size:10px;font-weight:700;letter-spacing:.06em;text-transform:uppercase;padding:3px 8px;border-radius:4px}
.bg2{background:var(--gbg);color:var(--green);border:1px solid var(--gbdr)}
.ba2{background:var(--abg);color:var(--amber);border:1px solid var(--abdr)}
.bb2{background:var(--bbg);color:var(--blue);border:1px solid #b8ccec}
.br2{background:var(--rbg);color:var(--red)}
/* TABLE */
.tw{overflow-x:auto;border-radius:10px;border:1px solid var(--rule)}
table{width:100%;border-collapse:collapse;font-size:13px}
thead tr{background:var(--navy3)}
thead th{color:rgba(255,255,255,.8);font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:12px 13px;text-align:left;white-space:nowrap}
tbody tr{border-bottom:1px solid var(--rule);transition:background .12s}
tbody tr:last-child{border-bottom:none}
tbody tr:hover{background:var(--warm)}
tbody tr:nth-child(even){background:#faf8f4}
td{padding:10px 13px;vertical-align:top;line-height:1.45}
.es{padding:48px;text-align:center;color:var(--mid);font-size:15px;font-style:italic}
/* STATUS */
.xstat{padding:14px 18px;border-radius:9px;font-size:14px;font-weight:600;margin:16px 0;display:none;align-items:center;gap:11px;line-height:1.5}
.xstat.on{display:flex}
.xstat.load{background:var(--bbg);color:var(--blue);border:1px solid #b0c8e8}
.xstat.good{background:var(--gbg);color:var(--green);border:1px solid var(--gbdr)}
.xstat.bad{background:var(--rbg);color:var(--red);border:1px solid #f0b8b8}
.spin{width:20px;height:20px;border:2.5px solid rgba(26,60,106,.18);border-top-color:var(--blue);border-radius:50%;animation:spin .7s linear infinite;flex-shrink:0}
@keyframes spin{to{transform:rotate(360deg)}}
/* TOAST */
#toast{position:fixed;bottom:28px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--navy3);color:#fff;font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;padding:13px 28px;border-radius:40px;box-shadow:0 8px 32px rgba(0,0,0,.2);border-left:4px solid var(--gold);z-index:9999;transition:transform .35s cubic-bezier(.34,1.56,.64,1);pointer-events:none;white-space:nowrap}
#toast.on{transform:translateX(-50%) translateY(0)}
#toast.ok{border-left-color:#3dd68c}
#toast.err{border-left-color:#f87171;background:var(--red)}
/* MODAL */
.ov{display:none;position:fixed;inset:0;background:rgba(10,20,40,.55);backdrop-filter:blur(3px);z-index:500;align-items:center;justify-content:center}
.ov.on{display:flex}
.modal{background:var(--white);border-radius:14px;padding:34px;max-width:700px;width:94%;box-shadow:0 20px 60px rgba(0,0,0,.22);max-height:90vh;overflow-y:auto}
.modal-title{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:600;color:var(--navy3);margin-bottom:18px}
.ma{display:flex;gap:11px;margin-top:22px;flex-wrap:wrap}
/* DOC */
.dsec{margin-bottom:26px}
.dtitle{font-family:'Cormorant Garamond',serif;font-size:20px;font-weight:600;color:var(--navy);border-bottom:1.5px solid var(--rule);padding-bottom:8px;margin-bottom:11px}
.dbody{font-size:15px;line-height:1.85;color:var(--text);white-space:pre-wrap;min-height:30px;border-radius:6px;padding:4px 6px;transition:background .12s}
.dbody[contenteditable]:hover{background:rgba(184,146,42,.07)}
.dbody[contenteditable]:focus{outline:2px solid var(--gold);background:rgba(184,146,42,.05)}
.dnil{color:#bbb;font-style:italic;font-size:14px}
hr.dv{border:none;border-top:1.5px solid var(--rule);margin:26px 0}
/* PREVIEW */
.rp{background:var(--gbg);border:1px solid var(--gbdr);border-radius:11px;padding:24px;margin-top:20px;animation:fadeIn .3s ease}
.rp-row{background:var(--white);border-radius:7px;padding:11px 16px;margin-bottom:8px;font-size:13px;line-height:1.6;border-left:3px solid var(--gold)}
@keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
/* WEEK HEADER */
.week-hdr{background:linear-gradient(135deg,var(--navy3) 0%,var(--navy2) 100%);border-radius:12px;padding:30px 34px;margin-bottom:24px;color:#fff;position:relative;overflow:hidden}
.week-hdr::after{content:'';position:absolute;right:-30px;top:-30px;width:180px;height:180px;background:rgba(184,146,42,.08);border-radius:50%}
.week-range{font-size:11px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--gold2);margin-bottom:7px}
.week-headline{font-family:'Cormorant Garamond',serif;font-size:30px;font-weight:600;line-height:1.2;margin-bottom:10px}
.week-summary{font-size:14px;line-height:1.75;color:rgba(255,255,255,.72);max-width:700px}
.pill-row{display:flex;flex-wrap:wrap;gap:7px;margin-top:14px}
.pill{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.14);border-radius:20px;padding:4px 13px;font-size:12px;color:rgba(255,255,255,.78);white-space:nowrap}
/* GREETING */
.greet-bar{background:var(--navy3);border-radius:12px;padding:26px 30px;margin-bottom:26px;display:flex;align-items:center;justify-content:space-between;gap:18px;flex-wrap:wrap}
.greet-name{font-family:'Cormorant Garamond',serif;font-size:34px;font-weight:600;color:#fff;line-height:1.1;margin-bottom:3px}
.greet-date{font-size:13px;color:rgba(255,255,255,.75);letter-spacing:.04em}
.greet-stats{display:flex;gap:22px;flex-wrap:wrap}
.gstat-n{font-family:'Cormorant Garamond',serif;font-size:32px;font-weight:700;color:var(--gold2);line-height:1;text-align:center}
.gstat-l{font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:rgba(255,255,255,.72);margin-top:2px;text-align:center}
/* CHARTS */
.chart-grid{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:26px}
.chart-box{background:var(--white);border:1px solid var(--rule);border-radius:12px;padding:22px;box-shadow:0 1px 12px rgba(28,51,85,.05)}
.chart-title{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:600;color:var(--navy);margin-bottom:14px}
.chart-wrap{position:relative;height:200px}
/* COMPS */
.comp-filters{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:12px;margin-bottom:20px;padding:20px;background:var(--warm);border:1px solid var(--rule);border-radius:10px}
.comp-result{background:var(--white);border:1px solid var(--rule);border-radius:10px;padding:18px 22px;margin-bottom:12px;transition:box-shadow .15s;border-left:4px solid transparent}
.comp-result:hover{box-shadow:0 4px 16px rgba(28,51,85,.1)}
.comp-result.match-hi{border-left-color:var(--green)}
.comp-result.match-med{border-left-color:var(--gold)}
.comp-result.match-lo{border-left-color:var(--mid)}
.comp-prop{font-family:'Cormorant Garamond',serif;font-size:19px;font-weight:600;color:var(--navy3);margin-bottom:4px}
.comp-meta{font-size:13px;color:var(--mid);margin-bottom:8px}
.comp-tags{display:flex;flex-wrap:wrap;gap:6px}
/* SCORECARD */
.score-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:18px;margin-bottom:28px}
.score-card{background:var(--white);border:1px solid var(--rule);border-radius:12px;overflow:hidden;box-shadow:0 1px 12px rgba(28,51,85,.05)}
.score-head{padding:18px 22px;border-bottom:1px solid var(--rule)}
.score-market{font-family:'Cormorant Garamond',serif;font-size:22px;font-weight:600;color:var(--navy3)}
.score-tag{font-size:11px;color:var(--mid);letter-spacing:.06em;text-transform:uppercase;margin-top:2px}
.score-body{padding:16px 22px}
.score-row{display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid var(--rule)}
.score-row:last-child{border-bottom:none}
.score-metric{font-size:13px;color:var(--text)}
.score-val{font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:600;color:var(--navy)}
.score-bar-wrap{margin-top:14px;padding-top:14px;border-top:1.5px solid var(--rule)}
.score-overall-label{font-size:11px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:var(--mid);margin-bottom:6px}
.score-bar{height:8px;background:var(--rule);border-radius:4px;overflow:hidden}
.score-bar-fill{height:100%;border-radius:4px;transition:width .8s ease}
.fill-hi{background:linear-gradient(90deg,var(--green),#3dd68c)}
.fill-med{background:linear-gradient(90deg,var(--gold),var(--gold2))}
.fill-lo{background:linear-gradient(90deg,var(--mid),#9aaabb)}
.score-pct{font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;color:var(--navy3);margin-top:6px}
/* ARTICLE LOG */
.art-log-item{background:var(--warm);border:1px solid var(--rule);border-radius:8px;padding:11px 15px;display:flex;align-items:center;justify-content:space-between;gap:11px;flex-wrap:wrap;margin-bottom:7px}
.art-log-title{font-size:13px;font-weight:600;color:var(--navy);flex:1;min-width:180px}
.art-log-meta{font-size:11px;color:var(--mid)}
/* SHARE */
.share-preview{border:2px dashed var(--rule);border-radius:12px;padding:32px;text-align:center;color:var(--mid);margin-bottom:22px}
/* SEARCH */
.search-wrap{position:relative;flex:1;max-width:340px}
.search-wrap input{padding-left:34px;font-size:13px}
.search-icon{position:absolute;left:11px;top:50%;transform:translateY(-50%);color:var(--mid);pointer-events:none}
@media(max-width:900px){
  .mast-i,.nav-i,.pg{padding-left:16px;padding-right:16px}
  .pg-title{font-size:28px}
  .stat-strip{grid-template-columns:1fr 1fr}
  .chart-grid{grid-template-columns:1fr}
  .score-grid{grid-template-columns:1fr 1fr}
  .greet-bar{flex-direction:column;align-items:flex-start}
  .blg{font-size:15px;padding:14px 24px}
}
</style>
</head>
<body>

<header class="mast">
  <div class="mast-i">
    <div class="logo">
      <div class="logo-mark">C</div>
      <span class="logo-name">Conduit Investors</span>
      <div class="logo-pipe"></div>
      <span class="logo-sub">London CRE Intelligence</span>
    </div>
    <div class="mast-r">
      <span class="mast-date" id="mdate"></span>
      <button class="btn-key" onclick="exportData()" title="Export all data as a backup file">üíæ Export Data</button>
      <button class="btn-key" onclick="document.getElementById('importFile').click()" title="Import data from backup file">üìÇ Import Data</button>
      <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
      <button class="btn-share" onclick="go('share')">‚¨Ü Share Report</button>
      <button class="btn-key" id="keyBtn" onclick="openKeyModal()">üîë API Key</button>
    </div>
  </div>
</header>

<nav class="nav">
  <div class="nav-i">
    <button class="nb on" onclick="go('dash')"    id="nb-dash">    <span class="ic">üìä</span> Dashboard</button>
    <button class="nb"    onclick="go('weekly')"  id="nb-weekly">  <span class="ic">üìÖ</span> Weekly Brief</button>
    <button class="nb"    onclick="go('comps')"   id="nb-comps">   <span class="ic">üîé</span> Comparables</button>
    <button class="nb"    onclick="go('score')"   id="nb-score">   <span class="ic">üó∫</span> Scorecard</button>
    <button class="nb"    onclick="go('article')" id="nb-article"> <span class="ic">üì∞</span> Paste Article</button>
    <button class="nb"    onclick="go('deals')"   id="nb-deals">   <span class="ic">üè¢</span> Deals <span class="nbct" id="ct-deals"></span></button>
    <button class="nb"    onclick="go('intel')"   id="nb-intel">   <span class="ic">üîç</span> Market Data <span class="nbct" id="ct-intel"></span></button>
    <button class="nb"    onclick="go('digest')"  id="nb-digest">  <span class="ic">üìã</span> Digest</button>
    <button class="nb"    onclick="go('narr')"    id="nb-narr">    <span class="ic">üìà</span> Narrative</button>
    <button class="nb"    onclick="go('share')"   id="nb-share">   <span class="ic">‚¨Ü</span> Share</button>
    <button class="nb"    onclick="go('live')"    id="nb-live">    <span class="ic">üì°</span> Live Data</button>
    <button class="nb" onclick="go('belgrove')" id="nb-belgrove" style="background:var(--gold);color:#fff;border:2px solid var(--gold2);font-weight:700"><span class="ic">üè¢</span> Belgrove House</button>
    <button class="nb" onclick="go('learn')" id="nb-learn"><span class="ic">üéì</span> Learn</button>
  </div>
</nav>

<!-- DASHBOARD -->
<div class="pg on" id="pg-dash">
  <div class="greet-bar">
    <div>
      <div class="greet-name" id="greetName">Good morning, Ryon.</div>
      <div class="greet-date" id="greetDate"></div>
    </div>
    <div class="greet-stats">
      <div><div class="gstat-n" id="gs-deals">‚Äî</div><div class="gstat-l">Deals</div></div>
      <div><div class="gstat-n" id="gs-intel">‚Äî</div><div class="gstat-l">Data Points</div></div>
      <div><div class="gstat-n" id="gs-arts">‚Äî</div><div class="gstat-l">Articles</div></div>
      <div><div class="gstat-n" id="gs-wkdeals">‚Äî</div><div class="gstat-l">This Week</div></div>
    </div>
  </div>

  <!-- MARKET TICKER -->
  <div id="mkt-ticker" style="background:#0a1628;border-radius:8px;padding:13px 20px;margin-bottom:22px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px">
    <div style="display:flex;gap:24px;flex-wrap:wrap">
      <div style="display:flex;flex-direction:column;gap:3px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#ffffff">DOW</div>
        <div id="tk-dow" style="font-size:18px;font-weight:800;color:#ffffff;font-family:'Cormorant Garamond',serif">‚Äî</div>
        <div id="tk-dow-c" style="font-size:12px;font-weight:700;color:#ffffff"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#ffffff">NASDAQ</div>
        <div id="tk-nas" style="font-size:18px;font-weight:800;color:#ffffff;font-family:'Cormorant Garamond',serif">‚Äî</div>
        <div id="tk-nas-c" style="font-size:12px;font-weight:700;color:#ffffff"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#ffffff">FTSE 100</div>
        <div id="tk-ftse" style="font-size:18px;font-weight:800;color:#ffffff;font-family:'Cormorant Garamond',serif">‚Äî</div>
        <div id="tk-ftse-c" style="font-size:12px;font-weight:700;color:#ffffff"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#ffffff">BoE Rate</div>
        <div id="tk-boe" style="font-size:18px;font-weight:800;color:#ffffff;font-family:'Cormorant Garamond',serif">‚Äî</div>
        <div id="tk-ftse-c" style="font-size:12px;font-weight:700;color:#ffffff"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#ffffff">UK 10Y Gilt</div>
        <div id="tk-gilt" style="font-size:18px;font-weight:800;color:#ffffff;font-family:'Cormorant Garamond',serif">‚Äî</div>
        <div id="tk-gilt-c" style="font-size:12px;font-weight:700;color:#ffffff"></div>
      </div>
      <div style="display:flex;flex-direction:column;gap:3px">
        <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:#ffffff">USD/GBP</div>
        <div id="tk-fx" style="font-size:18px;font-weight:800;color:#ffffff;font-family:'Cormorant Garamond',serif">‚Äî</div>
        <div id="tk-fx-c" style="font-size:12px;font-weight:700;color:#ffffff"></div>
      </div>
    </div>
    <div style="display:flex;align-items:center;gap:8px">
      <span id="tk-time" style="font-size:10px;color:#ffffff"></span>
      <button onclick="fetchTicker()" id="tk-btn" style="background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.5);color:#ffffff;font-size:12px;font-weight:700;padding:5px 12px;border-radius:4px;cursor:pointer">‚Üª Refresh</button>
    </div>
  </div>

  <div class="sh">Key Market Indicators</div>
  <div class="stat-strip" id="kpiGrid"></div>
  <button class="btn bo bsm" onclick="openKpiModal()">‚úèÔ∏è Update Indicators</button>

  <hr class="dv">
  <div class="sh">Market Trends</div>
  <div class="chart-grid">
    <div class="chart-box"><div class="chart-title">Deal Volume by Sector</div><div class="chart-wrap"><canvas id="chartSector"></canvas></div></div>
    <div class="chart-box"><div class="chart-title">High Priority Intelligence Over Time</div><div class="chart-wrap"><canvas id="chartIntel"></canvas></div></div>
  </div>

  <hr class="dv">
  <div class="sh">This Week's Summary</div>
  <div id="dashWeekly"></div>

  <hr class="dv">
  <div class="sh">Recent Transactions</div>
  <div id="dashDeals"></div>
  <button class="btn bo bsm" style="margin-top:11px" onclick="go('deals')">View All ‚Üí</button>

  <hr class="dv">
  <div class="sh">Market Narrative</div>
  <div class="card card-gold" id="dashNarr"><p class="dnil">No narrative yet.</p></div>
</div>

<!-- LEARN -->
<div class="pg" id="pg-learn">
  <div class="eyebrow">CRE Education</div>
  <h1 class="pg-title">Learning Centre</h1>
  <p class="pg-sub">Build your CRE and proforma expertise. Ask the AI tutor anything ‚Äî get answers calibrated to your level.</p>

  <!-- AI TUTOR -->
  <div class="card card-gold" style="margin-bottom:22px">
    <div class="sh-sm" style="margin-bottom:4px">AI Tutor ‚Äî Ask Anything</div>
    <div style="font-size:12px;color:var(--gold3);margin-bottom:14px">Ask about any CRE concept, metric, or proforma question. Get a plain-English answer with a worked example.</div>
    <div style="display:flex;gap:10px;margin-bottom:12px">
      <input id="learn-q" type="text" placeholder="e.g. What is yield-on-cost and why does it matter more than NIY?" style="flex:1;padding:10px 14px;border:1px solid var(--gold2);border-radius:6px;font-size:14px;background:rgba(255,255,255,.4)">
      <button class="btn bn" onclick="learnAsk()" id="learn-btn">Ask ‚Üí</button>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px">
      <button class="learn-chip" onclick="learnQuick(this)">What is NIY vs yield-on-cost?</button>
      <button class="learn-chip" onclick="learnQuick(this)">How does a real estate proforma work?</button>
      <button class="learn-chip" onclick="learnQuick(this)">What is a covered land play?</button>
      <button class="learn-chip" onclick="learnQuick(this)">How do I read a cap rate?</button>
      <button class="learn-chip" onclick="learnQuick(this)">What is IRR in real estate?</button>
      <button class="learn-chip" onclick="learnQuick(this)">Explain debt service coverage ratio</button>
      <button class="learn-chip" onclick="learnQuick(this)">What makes King's Cross a Golden Triangle asset?</button>
      <button class="learn-chip" onclick="learnQuick(this)">What do family offices look for in a CRE pitch?</button>
    </div>
    <div id="learn-status" style="display:none" class="xstat on load"><div class="spin"></div><span>Thinking‚Ä¶</span></div>
    <div id="learn-answer" style="margin-top:4px"></div>
  </div>

  <!-- PROFORMA CALCULATOR -->
  <div class="card" style="margin-bottom:22px">
    <div class="sh-sm" style="margin-bottom:4px">Proforma Calculator</div>
    <div style="font-size:12px;color:var(--mid);margin-bottom:16px">Build a simple real estate proforma. See how the numbers work together.</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px">
      <div>
        <div style="font-size:11px;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px">INCOME</div>
        <div class="pf-row"><label>Gross rent (¬£ psf/yr)</label><input id="pf-rent" type="number" value="60" oninput="pfCalc()"></div>
        <div class="pf-row"><label>Net lettable area (sq ft)</label><input id="pf-area" type="number" value="180000" oninput="pfCalc()"></div>
        <div class="pf-row"><label>Occupancy (%)</label><input id="pf-occ" type="number" value="90" oninput="pfCalc()"></div>
        <div class="pf-row"><label>Other income (¬£/yr)</label><input id="pf-other" type="number" value="0" oninput="pfCalc()"></div>
      </div>
      <div>
        <div style="font-size:11px;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.1em;margin-bottom:10px">COSTS</div>
        <div class="pf-row"><label>Service charge shortfall (¬£/yr)</label><input id="pf-svc" type="number" value="500000" oninput="pfCalc()"></div>
        <div class="pf-row"><label>Management fee (%)</label><input id="pf-mgmt" type="number" value="2" oninput="pfCalc()"></div>
        <div class="pf-row"><label>Capex reserve (¬£/yr)</label><input id="pf-capex" type="number" value="200000" oninput="pfCalc()"></div>
        <div class="pf-row"><label>Purchase price (¬£M)</label><input id="pf-price" type="number" value="92.5" oninput="pfCalc()"></div>
      </div>
    </div>
    <div style="background:var(--navy3);border-radius:8px;padding:16px 20px">
      <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--gold2);margin-bottom:12px">PROFORMA OUTPUT</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:12px">
        <div class="pf-out"><div class="pf-out-l">Gross Income</div><div class="pf-out-v" id="pf-r-gross">‚Äî</div></div>
        <div class="pf-out"><div class="pf-out-l">Effective Gross</div><div class="pf-out-v" id="pf-r-egi">‚Äî</div></div>
        <div class="pf-out"><div class="pf-out-l">Total Opex</div><div class="pf-out-v" id="pf-r-opex">‚Äî</div></div>
        <div class="pf-out"><div class="pf-out-l">Net Operating Income</div><div class="pf-out-v" id="pf-r-noi">‚Äî</div></div>
        <div class="pf-out"><div class="pf-out-l">NIY (headline)</div><div class="pf-out-v" id="pf-r-niy">‚Äî</div></div>
        <div class="pf-out"><div class="pf-out-l">Yield-on-Cost</div><div class="pf-out-v" id="pf-r-yoc" style="color:var(--gold2)">‚Äî</div></div>
      </div>
      <div id="pf-explain" style="margin-top:12px;font-size:12px;line-height:1.7;color:rgba(255,255,255,.7)"></div>
    </div>
  </div>

  <!-- GLOSSARY -->
  <div class="card" style="margin-bottom:22px">
    <div class="sh-sm" style="margin-bottom:12px">CRE Glossary ‚Äî Key Terms</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:2px" id="glossary-grid">
    </div>
  </div>

  <!-- PITCH COACH -->
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:10px">
      <div>
        <div class="sh-sm">Pitch Coach</div>
        <div style="font-size:12px;color:var(--mid);margin-top:3px">Practise explaining Belgrove House or any CRE concept. Get coaching feedback.</div>
      </div>
      <button class="btn bn bsm" onclick="pitchCoach()">Start Practice</button>
    </div>
    <textarea id="pitch-input" rows="3" placeholder="Type how you would explain Belgrove House to a family office investor‚Ä¶" style="width:100%;padding:10px;border:1px solid var(--rule);border-radius:6px;font-size:13px;font-family:inherit;resize:vertical;box-sizing:border-box;margin-top:10px"></textarea>
    <div id="pitch-status" style="display:none;margin-top:8px" class="xstat on load"><div class="spin"></div><span>Analysing your pitch‚Ä¶</span></div>
    <div id="pitch-feedback" style="margin-top:10px"></div>
  </div>

</div>
<!-- END LEARN -->

<!-- BELGROVE HOUSE -->
<div class="pg" id="pg-belgrove">
  <div class="eyebrow">Deal Intelligence</div>
  <h1 class="pg-title">Belgrove House</h1>
  <p class="pg-sub">King's Cross, London ¬∑ 180,000 sq ft ¬∑ Purpose-built life sciences</p>

  <!-- RAISE PROGRESS -->
  <div class="card card-gold" style="margin-bottom:24px">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:20px;margin-bottom:20px">
      <div>
        <div class="kpi-label">Target Raise</div>
        <div class="kpi-val">¬£90‚Äì95M</div>
      </div>
      <div>
        <div class="kpi-label">Raised to Date</div>
        <div class="kpi-val" id="bg-raised">¬£<span id="bg-raised-val">0</span>M</div>
      </div>
      <div>
        <div class="kpi-label">Status</div>
        <div class="kpi-val" id="bg-status-val">Raising</div>
      </div>
      <div>
        <div class="kpi-label">Asset Size</div>
        <div class="kpi-val">180,000 sq ft</div>
      </div>
    </div>
    <div style="margin-bottom:8px;font-size:12px;color:var(--gold3);font-weight:700">RAISE PROGRESS</div>
    <div style="background:rgba(255,255,255,.25);border-radius:99px;height:10px;overflow:hidden">
      <div id="bg-progress-bar" style="background:var(--gold2);height:10px;border-radius:99px;transition:width .5s;width:0%"></div>
    </div>
    <div style="margin-top:8px;display:flex;gap:12px;flex-wrap:wrap;align-items:center">
      <label style="font-size:12px;color:var(--gold3);font-weight:600">Update raised amount: ¬£</label>
      <input id="bg-raised-input" type="number" placeholder="e.g. 25" style="width:80px;padding:4px 8px;border:1px solid var(--gold2);border-radius:4px;font-size:13px;background:rgba(255,255,255,.3)">
      <span style="font-size:12px;color:var(--gold3)">M</span>
      <button class="btn bn bsm" onclick="bgUpdateRaise()">Update</button>
      <select id="bg-status-sel" onchange="bgUpdateStatus()" style="padding:4px 8px;border:1px solid var(--gold2);border-radius:4px;font-size:12px;background:rgba(255,255,255,.3)">
        <option>Raising</option>
        <option>Soft Circle</option>
        <option>Hard Committed</option>
        <option>Closed</option>
      </select>
    </div>
  </div>

  <!-- TWO COLUMN LAYOUT -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px">

    <!-- THE DEAL -->
    <div class="card">
      <div class="sh-sm" style="margin-bottom:14px">The Opportunity</div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px">
        <div class="mini-kpi"><div class="kpi-label">Location</div><div style="font-size:14px;font-weight:700;color:var(--navy3)">King's Cross, N1C</div></div>
        <div class="mini-kpi"><div class="kpi-label">Size</div><div style="font-size:14px;font-weight:700;color:var(--navy3)">180,000 sq ft</div></div>
        <div class="mini-kpi"><div class="kpi-label">Building type</div><div style="font-size:14px;font-weight:700;color:var(--navy3)">Purpose-built lab</div></div>
        <div class="mini-kpi"><div class="kpi-label">Availability</div><div style="font-size:14px;font-weight:700;color:var(--navy3)">Merck/MSD withdrawal</div></div>
        <div class="mini-kpi"><div class="kpi-label">Submarket</div><div style="font-size:14px;font-weight:700;color:var(--navy3)">London Golden Triangle</div></div>
        <div class="mini-kpi"><div class="kpi-label">Structure</div><div style="font-size:14px;font-weight:700;color:var(--navy3)">Equity syndication</div></div>
      </div>
      <div style="background:var(--abg);border:1px solid var(--abdr);border-radius:6px;padding:12px;font-size:12.5px;line-height:1.7;color:var(--amber)">
        <strong>Origin:</strong> Became available when Merck/MSD withdrew from their pre-let commitment. Purpose-built to institutional specification. Conduit is raising ¬£90‚Äì95M to acquire and manage the asset.
      </div>
    </div>

    <!-- INVESTMENT THESIS -->
    <div class="card">
      <div class="sh-sm" style="margin-bottom:14px">Investment Thesis</div>
      <div style="font-size:13px;line-height:1.75;color:var(--text)">
        <div style="margin-bottom:10px">
          <span style="background:var(--navy3);color:var(--gold2);font-size:10px;font-weight:700;padding:2px 7px;border-radius:3px;letter-spacing:.08em;margin-right:6px">PRICING</span>
          Opportunity created by seller dislocation ‚Äî Merck withdrawal repriced the asset below replacement cost. Buyers pricing flexibility, not income.
        </div>
        <div style="margin-bottom:10px">
          <span style="background:var(--navy3);color:var(--gold2);font-size:10px;font-weight:700;padding:2px 7px;border-radius:3px;letter-spacing:.08em;margin-right:6px">LOCATION</span>
          King's Cross sits within London's Golden Triangle. 203k sq ft of London life sciences take-up in 2025, improving. Ecosystem demand ‚Äî UCL, Francis Crick Institute, Google DeepMind all within walking distance.
        </div>
        <div style="margin-bottom:10px">
          <span style="background:var(--navy3);color:var(--gold2);font-size:10px;font-weight:700;padding:2px 7px;border-radius:3px;letter-spacing:.08em;margin-right:6px">TIMING</span>
          18‚Äì36 month window. Refinancing cliffs to 2027 creating forced sellers. Capital returning to prime London before occupier data confirms recovery.
        </div>
        <div>
          <span style="background:var(--navy3);color:var(--gold2);font-size:10px;font-weight:700;padding:2px 7px;border-radius:3px;letter-spacing:.08em;margin-right:6px">YIELD</span>
          Target stabilised yield-on-cost 5.0‚Äì5.5%. Headline NIY understates leasing optionality and development platform value.
        </div>
      </div>
    </div>
  </div>

  <!-- MARKET CONTEXT -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px">
    <div class="card" style="text-align:center;padding:20px 16px">
      <div style="font-size:28px;font-weight:800;color:var(--navy3);font-family:'Cormorant Garamond',serif">+42%</div>
      <div style="font-size:12px;color:var(--mid);margin-top:4px">Golden Triangle take-up YoY 2025</div>
      <div style="font-size:11px;color:var(--gold3);font-weight:600;margin-top:4px">1.35m sq ft total</div>
    </div>
    <div class="card" style="text-align:center;padding:20px 16px">
      <div style="font-size:28px;font-weight:800;color:var(--navy3);font-family:'Cormorant Garamond',serif">3.6m</div>
      <div style="font-size:12px;color:var(--mid);margin-top:4px">sq ft under construction pipeline</div>
      <div style="font-size:11px;color:var(--gold3);font-weight:600;margin-top:4px">Supply wave incoming ‚Äî ecosystem assets win</div>
    </div>
    <div class="card" style="text-align:center;padding:20px 16px">
      <div style="font-size:28px;font-weight:800;color:var(--navy3);font-family:'Cormorant Garamond',serif">5‚Äì5.5%</div>
      <div style="font-size:12px;color:var(--mid);margin-top:4px">Target stabilised yield-on-cost</div>
      <div style="font-size:11px;color:var(--gold3);font-weight:600;margin-top:4px">vs headline NIY which understates leasing risk</div>
    </div>
  </div>

  <!-- COMPARABLES -->
  <div class="card" style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
      <div class="sh-sm">Comparable Transactions</div>
      <button class="btn bo bsm" onclick="go('comps')">View All Comps ‚Üí</button>
    </div>
    <div id="bg-comps-table">
      <div style="font-size:13px;color:var(--mid);font-style:italic">Loading comparables from your deals database‚Ä¶</div>
    </div>
  </div>

  <!-- IC Q&A -->
  <div class="card" style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:10px">
      <div>
        <div class="sh-sm">IC Question Anticipator</div>
        <div style="font-size:12px;color:var(--mid);margin-top:3px">The 10 hardest questions a family office IC will ask about Belgrove House ‚Äî with IC-standard answers.</div>
      </div>
      <button class="btn bn bsm" id="bg-qa-btn" onclick="bgGenerateQA()">‚ú¶ Generate Q&A</button>
    </div>
    <div id="bg-qa-status" style="display:none" class="xstat on load"><div class="spin"></div><span>Generating IC questions‚Ä¶</span></div>
    <div id="bg-qa-content" style="margin-top:14px"></div>
  </div>

  <!-- ONE-PAGER -->
  <div class="card" style="margin-bottom:20px">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;flex-wrap:wrap;gap:10px">
      <div>
        <div class="sh-sm">Investor One-Pager</div>
        <div style="font-size:12px;color:var(--mid);margin-top:3px">Single-page deal summary for family office conversations. Generate, edit, then copy or email.</div>
      </div>
      <button class="btn bn bsm" id="bg-op-btn" onclick="bgGenerateOnePager()">‚ú¶ Generate One-Pager</button>
    </div>
    <div id="bg-op-status" style="display:none" class="xstat on load"><div class="spin"></div><span>Drafting one-pager‚Ä¶</span></div>
    <div id="bg-op-content" style="margin-top:14px"></div>
  </div>

</div>
<!-- END BELGROVE HOUSE -->

<!-- WEEKLY BRIEF -->
<div class="pg" id="pg-weekly">
  <div class="eyebrow">Weekly Intelligence Summary</div>
  <h1 class="pg-title">Weekly Brief</h1>
  <p class="pg-sub">AI-generated summary of this week's London CRE activity drawn from every article you've processed.</p>
  <div style="display:flex;gap:9px;margin-bottom:26px;flex-wrap:wrap">
    <button class="btn bn" onclick="generateWeekly()">‚ú® Generate This Week's Brief</button>
    <button class="btn bo bsm" onclick="copyWeekly()">Copy Text</button>
    <button class="btn br_ bsm" onclick="clearWeekly()">Clear</button>
  </div>
  <div id="weeklyContent"></div>
  <hr class="dv">
  <div class="sh">This Week's Deals</div>
  <div class="tw"><table><thead><tr><th>Date</th><th>Property</th><th>Location</th><th>Sector</th><th>Price ¬£M</th><th>Status</th></tr></thead><tbody id="weekDealBody"></tbody></table></div>
  <hr class="dv">
  <div class="sh">This Week's Market Data</div>
  <div class="tw"><table><thead><tr><th>Area</th><th>Metric</th><th>Figure</th><th>Trend</th><th>Priority</th></tr></thead><tbody id="weekIntelBody"></tbody></table></div>
</div>

<!-- COMPARABLES -->
<div class="pg" id="pg-comps">
  <div class="eyebrow">Deal Analysis</div>
  <h1 class="pg-title">Comparables Engine</h1>
  <p class="pg-sub">Search your deal database to find comparable transactions. Filter by sector, location, price, or yield to build your comp set instantly.</p>
  <div class="comp-filters">
    <div><label class="fl">Keyword</label><input type="text" id="cf-kw" placeholder="e.g. King's Cross, office" oninput="runComps()"></div>
    <div><label class="fl">Sector</label><select id="cf-sec" onchange="runComps()"><option value="">All Sectors</option><option>Office</option><option>Life Sciences</option><option>Industrial</option><option>Retail</option><option>Mixed-Use</option><option>Residential</option></select></div>
    <div><label class="fl">Min Price ¬£M</label><input type="number" id="cf-pmin" placeholder="0" oninput="runComps()"></div>
    <div><label class="fl">Max Price ¬£M</label><input type="number" id="cf-pmax" placeholder="any" oninput="runComps()"></div>
    <div><label class="fl">Status</label><select id="cf-st" onchange="runComps()"><option value="">All</option><option>Completed</option><option>Under Offer</option><option>Pre-Let</option><option>Development</option></select></div>
    <div><label class="fl">Date From</label><input type="date" id="cf-d1" onchange="runComps()"></div>
  </div>
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;flex-wrap:wrap;gap:10px">
    <div id="compCount" style="font-size:14px;color:var(--mid);font-weight:600"></div>
    <div style="display:flex;gap:9px">
      <button class="btn bg_ bsm" onclick="generateCompSummary()">‚ú® AI Summary of Results</button>
      <button class="btn bo bsm" onclick="clearCompFilters()">Clear Filters</button>
    </div>
  </div>
  <div id="compAISummary"></div>
  <div id="compResults"></div>
</div>

<!-- SCORECARD -->
<div class="pg" id="pg-score">
  <div class="eyebrow">Submarket Intelligence</div>
  <h1 class="pg-title">Market Scorecard</h1>
  <p class="pg-sub">Live scoring of London's key submarkets based on your accumulated market data. Updates automatically as you process more articles.</p>
  <div style="display:flex;gap:9px;margin-bottom:24px;flex-wrap:wrap">
    <button class="btn bn" onclick="generateScorecard()">‚ú® Refresh AI Scorecard</button>
    <button class="btn bo bsm" onclick="renderScorecard()">Refresh from Data</button>
  </div>
  <div class="score-grid" id="scoreGrid"></div>
  <div id="scoreAIInsight"></div>
</div>

<!-- PASTE ARTICLE -->
<div class="pg" id="pg-article">
  <div class="eyebrow">AI-Powered Extraction</div>
  <h1 class="pg-title">Paste Article</h1>
  <p class="pg-sub">Paste any Property Week article and the AI extracts every deal and data point automatically.</p>
  <div class="instr">
    <strong>Three steps:</strong><br><br>
    <strong>1.</strong> Select all text in a Property Week article (Ctrl+A then Ctrl+C).<br>
    <strong>2.</strong> Click the yellow box below and paste (Ctrl+V).<br>
    <strong>3.</strong> Click <strong>Extract Intelligence</strong>. Done automatically.
  </div>
  <div class="card">
    <div class="fg"><label class="fl" for="artDate">Article Date</label><input type="date" id="artDate" style="max-width:230px"></div>
    <div class="fg"><label class="fl" for="artTitle">Article Headline (optional)</label><input type="text" id="artTitle" placeholder="e.g. King's Cross lab rents hit record"></div>
    <div class="fg"><label class="fl" for="artText">Article Text ‚Äî Paste Here</label>
      <textarea id="artText" rows="13" style="background:rgba(184,146,42,.05);border-color:var(--gold2)" placeholder="Click here and paste the full article text."></textarea></div>
    <button class="btn bn blg" id="extBtn" onclick="runExtraction()">‚ú¶ Extract Intelligence</button>
    <div class="xstat" id="xstat"><div class="spin" id="xspin"></div><div id="xmsg"></div></div>
  </div>
  <div id="extPreview"></div>
  <hr class="dv">
  <div class="sh">Articles Processed</div>
  <div id="artLog"><p class="dnil">No articles yet.</p></div>
</div>

<!-- DEAL TRACKER -->
<div class="pg" id="pg-deals">
  <div class="eyebrow">Transaction Log</div>
  <h1 class="pg-title">Deal Tracker</h1>
  <p class="pg-sub">Every London CRE transaction extracted from your articles.</p>
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div id="dealCount" style="font-size:14px;color:var(--mid);font-weight:600"></div>
      <div class="search-wrap"><span class="search-icon">üîç</span><input type="text" id="dealSearch" placeholder="Search‚Ä¶" oninput="renderDeals()"></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn bg_ bsm" onclick="openAddDeal()">+ Add</button>
      <button class="btn bo bsm" onclick="exportDeals()">‚Üì CSV</button>
      <button class="btn br_ bsm" onclick="clearDeals()">Clear All</button>
    </div>
  </div>
  <div class="tw"><table>
    <thead><tr><th>Date</th><th>Property</th><th>Location</th><th>Sector</th><th>Buyer</th><th>Seller</th><th>Price ¬£M</th><th>Yield</th><th>Status</th><th>Why It Matters</th><th></th></tr></thead>
    <tbody id="dealBody"></tbody>
  </table></div>
</div>

<!-- MARKET DATA -->
<div class="pg" id="pg-intel">
  <div class="eyebrow">Statistics & Intelligence</div>
  <h1 class="pg-title">Market Data</h1>
  <p class="pg-sub">Every statistic extracted from articles ‚Äî rents, vacancy, yields, volumes.</p>
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;margin-bottom:16px">
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap">
      <div id="intelCount" style="font-size:14px;color:var(--mid);font-weight:600"></div>
      <div class="search-wrap"><span class="search-icon">üîç</span><input type="text" id="intelSearch" placeholder="Search‚Ä¶" oninput="renderIntel()"></div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn bg_ bsm" onclick="openAddIntel()">+ Add</button>
      <button class="btn bo bsm" onclick="exportIntel()">‚Üì CSV</button>
      <button class="btn br_ bsm" onclick="clearIntel()">Clear All</button>
    </div>
  </div>
  <div class="tw"><table>
    <thead><tr><th>Date</th><th>Area</th><th>Type</th><th>Metric</th><th>Figure</th><th>Trend</th><th>Source</th><th>Why It Matters</th><th>Priority</th><th></th></tr></thead>
    <tbody id="intelBody"></tbody>
  </table></div>
</div>

<!-- DAILY DIGEST -->
<div class="pg" id="pg-digest">
  <div class="eyebrow">Morning Briefing</div>
  <h1 class="pg-title">Daily Digest</h1>
  <p class="pg-sub">Auto-generated from your articles. Click any section to edit.</p>
  <div style="display:flex;gap:9px;margin-bottom:20px;flex-wrap:wrap">
    <button class="btn bn bsm" onclick="regenDigest()">üîÑ Regenerate</button>
    <button class="btn bo bsm" onclick="copyDigest()">Copy</button>
    <button class="btn br_ bsm" onclick="clearDigest()">Clear</button>
  </div>
  <div class="card">
    <div class="dsec"><div class="dtitle">Date</div><div class="dbody" id="dDate" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">Headline</div><div class="dbody" id="dHead" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">Executive Summary</div><div class="dbody" id="dSum" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">Top Story</div><div class="dbody" id="dStory" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">Deals Reported</div><div class="dbody" id="dDeals" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">Watch List</div><div class="dbody" id="dWatch" contenteditable="true"></div></div>
  </div>
</div>

<!-- NARRATIVE -->
<div class="pg" id="pg-narr">
  <div class="eyebrow">Monthly Investor Commentary</div>
  <h1 class="pg-title">Market Narrative</h1>
  <p class="pg-sub">Capital allocation memo ‚Äî pricing regime change framing. IC standard.</p>
  <div style="background:var(--navy3);border-radius:8px;padding:18px 22px;margin-bottom:22px">
    <div style="font-size:10px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:var(--gold2);margin-bottom:10px">IC Writing Standards ‚Äî v2</div>
    <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:12px;font-size:11.5px;line-height:1.6;color:rgba(255,255,255,.8)">
      <div><b style="color:var(--gold2)">Core thesis: </b>Prime office = covered land play + interim income. Commodity life sciences = misallocated capital.</div>
      <div><b style="color:var(--gold2)">Seller psychology: </b>Open-ended fund redemptions ¬∑ German Spezialfonds ¬∑ REIT balance-sheet repair ¬∑ Developer refinance walls (to 2027)</div>
      <div><b style="color:var(--gold2)">Yield framing: </b>Stabilised yield-on-cost 5.0‚Äì5.5%, not headline NIY. Sellers value income. Buyers value flexibility. That gap = the edge.</div>
      <div><b style="color:var(--gold2)">Language rules: </b>"Structural divergence" not "bifurcation" ¬∑ "18‚Äì36 months" not 12‚Äì18 ¬∑ "Selective slowdown" not "frozen" for life sciences occupiers ¬∑ "Duration mismatch" for secondary offices</div>
      <div><b style="color:var(--gold2)">Distress signal: </b>Life sciences occupier market = selective slowdown, uneven demand ‚Äî NOT frozen. Golden Triangle take-up +42% YoY (2025). Capital market transactions = illiquid for commodity lab investment only. Ecosystem assets still transact.</div>
      <div><b style="color:var(--gold2)">Frame as: </b>Pricing regime change + relative-value dislocation. Who wins and why ‚Äî not just what is happening.</div>
    </div>
  </div>
  <div style="display:flex;gap:9px;margin-bottom:16px;flex-wrap:wrap">
    <button class="btn bn bsm" onclick="regenNarr()">‚ú® Generate Draft</button>
    <button class="btn bo bsm" onclick="copyNarr()">Copy</button>
    <button class="btn bsm" style="background:var(--gbg);color:var(--green);border:1px solid var(--gbdr)" onclick="checkNarrAccuracy()">‚úì Fact-Check vs Market</button>
    <button class="btn br_ bsm" onclick="clearNarr()">Clear</button>
  </div>
  <div id="narr-check-panel" style="display:none;margin-bottom:18px"></div>
  <div class="card">
    <div class="dsec"><div class="dtitle">Period</div><div class="dbody" id="nPeriod" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle" style="font-size:24px;border-bottom-color:var(--gold)">Headline Statement</div>
      <div class="dbody" id="nHead" contenteditable="true" style="font-family:'Cormorant Garamond',serif;font-size:21px;font-style:italic;color:var(--navy3)"></div></div>
    <hr class="dv">
    <div class="dsec"><div class="dtitle">1. Macro &amp; Capital Markets</div><div class="dbody" id="nMacro" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">2. London Life Sciences Sector</div><div class="dbody" id="nSector" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">3. Key Transactions</div><div class="dbody" id="nDeals" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">4. Investment Implications</div><div class="dbody" id="nImpl" contenteditable="true"></div></div>
    <div class="dsec"><div class="dtitle">5. Outlook</div><div class="dbody" id="nOut" contenteditable="true"></div></div>
  </div>
  <p style="font-size:11px;color:var(--mid);text-align:center;margin-top:14px;letter-spacing:.06em">CONFIDENTIAL ‚Äî CONDUIT INVESTORS ‚Äî NOT FOR DISTRIBUTION</p>
</div>

<!-- SHARE -->
<div class="pg" id="pg-share">
  <div class="eyebrow">Share with Ryon &amp; Jake</div>
  <h1 class="pg-title">Generate Shareable Report</h1>
  <p class="pg-sub">Creates a self-contained HTML file with all your intelligence baked in. Email it ‚Äî they open it in Chrome, no login or account needed.</p>
  <div class="card card-gold" style="margin-bottom:28px">
    <div class="sh-sm">What's included in the report</div>
    <p style="font-size:15px;line-height:1.8;color:var(--text);margin-bottom:16px">The shareable report contains: market KPIs, weekly brief, all deals, all market data, submarket scorecard, and your market narrative ‚Äî formatted as a clean investor-grade document.</p>
    <div style="display:flex;gap:10px;flex-wrap:wrap">
      <label class="fl" style="display:inline-flex;align-items:center;gap:8px;font-size:13px;text-transform:none;letter-spacing:0;cursor:pointer;margin-bottom:0;font-weight:400"><input type="checkbox" id="incWeekly" checked> Include Weekly Brief</label>
      <label class="fl" style="display:inline-flex;align-items:center;gap:8px;font-size:13px;text-transform:none;letter-spacing:0;cursor:pointer;margin-bottom:0;font-weight:400"><input type="checkbox" id="incDeals" checked> Include All Deals</label>
      <label class="fl" style="display:inline-flex;align-items:center;gap:8px;font-size:13px;text-transform:none;letter-spacing:0;cursor:pointer;margin-bottom:0;font-weight:400"><input type="checkbox" id="incIntel" checked> Include Market Data</label>
      <label class="fl" style="display:inline-flex;align-items:center;gap:8px;font-size:13px;text-transform:none;letter-spacing:0;cursor:pointer;margin-bottom:0;font-weight:400"><input type="checkbox" id="incNarr" checked> Include Narrative</label>
    </div>
  </div>
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:28px">
    <button class="btn bn blg" onclick="generateReport()">‚¨Ü Download Shareable Report</button>
  </div>
  <div class="share-preview">
    <p style="font-size:36px;margin-bottom:12px">üìÑ</p>
    <p style="font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--navy);margin-bottom:8px">Conduit Investors ‚Äî Market Intelligence Report</p>
    <p style="font-size:14px">Click the button above to generate and download the report as an HTML file.<br>Email it to Ryon or Jake ‚Äî they open it in Chrome, no account needed.</p>
  </div>
  <div class="card" style="background:var(--warm)">
    <div class="sh-sm">How to share</div>
    <ol style="font-size:15px;line-height:2;padding-left:20px;color:var(--text)">
      <li>Click <strong>Download Shareable Report</strong> above</li>
      <li>A file called <strong>conduit-market-intelligence.html</strong> downloads to your computer</li>
      <li>Attach it to an email to Ryon or Jake</li>
      <li>They open the file in Chrome ‚Äî no login, no account, everything is there</li>
    </ol>
  </div>
</div>


<!-- LIVE DATA -->
<div class="pg" id="pg-live">
  <div class="eyebrow">Real-Time Market Intelligence</div>
  <h1 class="pg-title">Live Data Feeds</h1>
  <p class="pg-sub">AI-powered news intelligence and verified Land Registry transaction data.</p>
  <div id="localWarning" class="xstat on bad" style="display:none;margin-bottom:20px">
    ‚ö†Ô∏è Running as a local file ‚Äî auto-fetch is disabled. 
    <a href="https://app.netlify.com/drop" target="_blank" style="color:inherit;font-weight:700;margin-left:8px">Deploy to Netlify to enable ‚Üí</a>
  </div>

  <!-- AI NEWS SECTION -->
  <div class="card card-gold" style="margin-bottom:8px">
    <div style="display:flex;align-items:flex-start;gap:14px;flex-wrap:wrap">
      <div style="flex:1">
        <div class="sh-sm" style="margin-bottom:5px">AI-Powered News Intelligence</div>
        <p style="font-size:13px;color:var(--mid);line-height:1.6">Uses your Claude API key to search the web for the latest London CRE headlines ‚Äî bypasses all CORS restrictions. Choose a topic or type your own.</p>
      </div>
    </div>
    <div style="margin-top:16px;display:flex;gap:9px;flex-wrap:wrap;align-items:flex-end">
      <div style="flex:1;min-width:220px">
        <label class="fl" style="margin-bottom:5px">Search Topic</label>
        <input type="text" id="newsQuery" value="London commercial real estate deals this week" placeholder="e.g. King's Cross life sciences lettings">
      </div>
      <button class="btn bn" id="newsBtn" onclick="fetchAINews()">üîç Search News</button>
    </div>
    <div style="margin-top:12px;display:flex;gap:7px;flex-wrap:wrap">
      <button class="btn bo bsm" onclick="setNewsQuery('London office deals this week')">Office deals</button>
      <button class="btn bo bsm" onclick="setNewsQuery('London life sciences property 2025')">Life sciences</button>
      <button class="btn bo bsm" onclick="setNewsQuery('King's Cross investment transactions')">King's Cross</button>
      <button class="btn bo bsm" onclick="setNewsQuery('UK commercial property yields investment')">Investment yields</button>
      <button class="btn bo bsm" onclick="setNewsQuery('Golden Triangle Oxford Cambridge London biotech property')">Golden Triangle</button>
    </div>
  </div>
  <div id="newsStatus" class="xstat" style="display:none"></div>
  <div id="newsResults" style="margin-bottom:36px"></div>

  <hr class="dv">

  <!-- LAND REGISTRY -->
  <div class="sh">HM Land Registry ‚Äî Import Transactions</div>
  <p style="font-size:13px;color:var(--mid);margin-bottom:18px;line-height:1.7">Land Registry data cannot be fetched automatically from a local file due to browser security restrictions. Use their official search to download transactions, then paste the data below for AI-assisted import.</p>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px">
    <div class="card" style="border-left:4px solid var(--navy)">
      <div class="sh-sm" style="margin-bottom:8px">Step 1 ‚Äî Search Land Registry</div>
      <p style="font-size:13px;line-height:1.7;margin-bottom:14px">Search their official database for London commercial transactions.</p>
      <a href="https://landregistry.data.gov.uk/app/ppd" target="_blank" class="btn bn bsm" style="display:inline-flex;text-decoration:none">üèõ Open Land Registry Search ‚Üí</a>
      <p style="font-size:11px;color:var(--mid);margin-top:10px">Filter by: County = Greater London, Property type = Other (commercial)</p>
    </div>
    <div class="card" style="border-left:4px solid var(--gold)">
      <div class="sh-sm" style="margin-bottom:8px">Step 2 ‚Äî AI Import</div>
      <p style="font-size:13px;line-height:1.7;margin-bottom:14px">Copy any transaction data from the results ‚Äî addresses, prices, dates ‚Äî and paste below. AI will parse and import it.</p>
      <div class="fg"><textarea id="lrPaste" rows="5" placeholder="Paste Land Registry data here ‚Äî any format works. E.g.:&#10;The Shard, SE1 9SG, ¬£850,000,000, 15 Jan 2025&#10;Or copy rows directly from their results table."></textarea></div>
      <button class="btn bg_" onclick="importLRPaste()">‚ú® Parse &amp; Import with AI</button>
    </div>
  </div>
  <div id="lrPasteStatus" class="xstat" style="display:none"></div>
  <div id="lrPasteResults" style="margin-bottom:36px"></div>

  <hr class="dv">

  <!-- KEY RATES -->
  <div class="sh">Key Rates ‚Äî Quick Update</div>
  <p style="font-size:13px;color:var(--mid);margin-bottom:16px">Live rate APIs are blocked in local file mode. Use the quick-set buttons below to update your KPI strip, or click the links to check current rates.</p>
  <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:14px;margin-bottom:18px">
    <div class="card">
      <div class="sh-sm" style="margin-bottom:8px">BoE Base Rate</div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <input type="text" id="boeInput" placeholder="e.g. 4.75%" style="max-width:120px">
        <button class="btn bg_ bsm" onclick="setKpiQuick('Bank of England Base Rate', document.getElementById('boeInput').value)">Set</button>
      </div>
      <a href="https://www.bankofengland.co.uk/monetary-policy/the-interest-rate-bank-rate" target="_blank" style="font-size:12px;color:var(--navy);font-weight:600">Check current rate ‚Üí</a>
    </div>
    <div class="card">
      <div class="sh-sm" style="margin-bottom:8px">10-Year Gilt Yield</div>
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
        <input type="text" id="giltInput" placeholder="e.g. 4.55%" style="max-width:120px">
        <button class="btn bg_ bsm" onclick="setKpiQuick('10-Year UK Gilt Yield', document.getElementById('giltInput').value)">Set</button>
      </div>
      <a href="https://www.ft.com/markets/government-bonds" target="_blank" style="font-size:12px;color:var(--navy);font-weight:600">Check current rate ‚Üí</a>
    </div>
    <div class="card">
      <div class="sh-sm" style="margin-bottom:8px">AI ‚Äî Fetch Current Rates</div>
      <p style="font-size:12px;color:var(--mid);margin-bottom:10px;line-height:1.5">Let AI look up current rates using your API key.</p>
      <button class="btn bn bsm" onclick="fetchRatesAI()">üîç Get Current Rates</button>
    </div>
  </div>
  <div id="ratesStatus" class="xstat" style="display:none"></div>
  <div id="ratesResults"></div>
</div>

<!-- MODALS -->
<div class="ov" id="ovKey">
  <div class="modal">
    <div class="modal-title">Anthropic API Key</div>
    <p style="font-size:15px;line-height:1.75;margin-bottom:18px">One-time setup ‚Äî saved in this browser only.<br><br>
    <strong>Get your key:</strong> Go to <a href="https://console.anthropic.com" target="_blank" style="color:var(--navy);font-weight:700">console.anthropic.com</a> ‚Üí API Keys ‚Üí Create Key ‚Üí copy and paste below.</p>
    <div class="fg"><label class="fl">API Key</label><input type="text" id="keyInput" placeholder="sk-ant-..." style="font-family:monospace;font-size:13px"></div>
    <div id="keyErr" style="color:var(--red);font-weight:600;font-size:13px;margin-bottom:10px;display:none"></div>
    <div class="ma"><button class="btn bn" onclick="saveKey()">Save Key</button><button class="btn bo" onclick="cm('ovKey')">Cancel</button></div>
    <p style="font-size:11px;color:var(--mid);margin-top:16px">Sent only to Anthropic's servers for AI processing.</p>
  </div>
</div>
<div class="ov" id="ovKpi">
  <div class="modal"><div class="modal-title">Update Market Indicators</div><div id="kpiFields"></div>
    <div class="ma"><button class="btn bn" onclick="saveKpi()">Save</button><button class="btn bo" onclick="cm('ovKpi')">Cancel</button></div></div>
</div>
<div class="ov" id="ovDeal">
  <div class="modal"><div class="modal-title">Add Deal Manually</div>
    <div class="fg"><label class="fl">Property Name</label><input type="text" id="nd_prop"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="fg"><label class="fl">Date</label><input type="date" id="nd_date"></div>
      <div class="fg"><label class="fl">Sector</label><input type="text" id="nd_sec"></div>
    </div>
    <div class="fg"><label class="fl">Location</label><input type="text" id="nd_loc"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="fg"><label class="fl">Buyer</label><input type="text" id="nd_buy"></div>
      <div class="fg"><label class="fl">Seller</label><input type="text" id="nd_sel"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="fg"><label class="fl">Price (¬£M)</label><input type="text" id="nd_pr"></div>
      <div class="fg"><label class="fl">Yield</label><input type="text" id="nd_yi"></div>
      <div class="fg"><label class="fl">Status</label><input type="text" id="nd_st"></div>
    </div>
    <div class="fg"><label class="fl">Why It Matters</label><textarea id="nd_rel" rows="3"></textarea></div>
    <div class="ma"><button class="btn bn" onclick="saveDeal()">Add</button><button class="btn bo" onclick="cm('ovDeal')">Cancel</button></div>
  </div>
</div>
<div class="ov" id="ovIntel">
  <div class="modal"><div class="modal-title">Add Data Point Manually</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="fg"><label class="fl">Date</label><input type="date" id="ni_date"></div>
      <div class="fg"><label class="fl">Area</label><input type="text" id="ni_area"></div>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
      <div class="fg"><label class="fl">Type</label><input type="text" id="ni_type" placeholder="Prime Rent"></div>
      <div class="fg"><label class="fl">Figure</label><input type="text" id="ni_val"></div>
    </div>
    <div class="fg"><label class="fl">What Was Measured</label><input type="text" id="ni_met"></div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px">
      <div class="fg"><label class="fl">Trend</label><select id="ni_tr"><option>‚Üë</option><option>‚Üì</option><option>‚Üî</option><option>‚Äî</option></select></div>
      <div class="fg"><label class="fl">Source</label><input type="text" id="ni_src"></div>
      <div class="fg"><label class="fl">Priority</label><select id="ni_pri"><option>High</option><option>Medium</option><option>Low</option></select></div>
    </div>
    <div class="fg"><label class="fl">Why It Matters</label><textarea id="ni_rel" rows="3"></textarea></div>
    <div class="ma"><button class="btn bn" onclick="saveIntel()">Add</button><button class="btn bo" onclick="cm('ovIntel')">Cancel</button></div>
  </div>
</div>
<div id="toast"></div>

<script>
// ‚ïê‚ïê STATE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const DEFAULTS = {
  deals:[], intel:[], articles:[],
  belgrove:{
    raiseStatus:'Raising',
    raisedM:0,
    targetM:92.5,
    qa:[],
    qaGeneratedAt:'',
    onepager:'',
    onepagerAt:''
  },
  weekly:{range:'',headline:'',summary:'',themes:[],deals_insight:'',data_insight:'',implications:'',outlook:'',generatedAt:''},
  scorecard:{},
  kpis:[
    {label:"King's Cross ‚Äî Lab Rent (¬£ psf)",    value:"",source:"Property Week"},
    {label:"London Life Sciences Vacancy Rate",  value:"",source:"Property Week"},
    {label:"Bank of England Base Rate",          value:"",source:"Bank of England"},
    {label:"10-Year UK Gilt Yield",              value:"",source:"Financial Times"},
    {label:"London Investment Vol (¬£bn, qtr)",   value:"",source:"Property Week"},
    {label:"Target Asset Net Initial Yield",     value:"",source:"Conduit Research"},
  ],
  digest:{date:'',headline:'',summary:'',story:'',deals:'',watch:''},
  narr:{period:'',headline:'',macro:'',sector:'',deals:'',impl:'',out:''},
};
const S = JSON.parse(JSON.stringify(DEFAULTS));

function loadState() {
  try {
    const raw = localStorage.getItem('conduit-cre-v2') || localStorage.getItem('conduit-cre-v1');
    if (!raw) return;
    const sv = JSON.parse(raw);
    if (Array.isArray(sv.deals))    S.deals    = sv.deals;
    if (Array.isArray(sv.intel))    S.intel    = sv.intel;
    if (Array.isArray(sv.articles)) S.articles = sv.articles;
    if (sv.kpis && Array.isArray(sv.kpis)) S.kpis = sv.kpis;
    if (sv.digest)   Object.assign(S.digest,   sv.digest);
    if (sv.narr)     Object.assign(S.narr,     sv.narr);
    if (sv.weekly)   Object.assign(S.weekly,   sv.weekly);
    if (sv.scorecard) S.scorecard = sv.scorecard;
  } catch(e) { console.warn('loadState:', e); }
}
function saveState() {
  try { localStorage.setItem('conduit-cre-v2', JSON.stringify(S)); }
  catch(e) { console.warn('saveState:', e); }
}

// ‚ïê‚ïê API ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getKey() { return localStorage.getItem('conduit-api-key') || ''; }
function openKeyModal() { document.getElementById('keyInput').value=getKey(); document.getElementById('keyErr').style.display='none'; om('ovKey'); }
function saveKey() {
  const k=document.getElementById('keyInput').value.trim();
  const err=document.getElementById('keyErr');
  if(!k){err.textContent='Please paste your API key.';err.style.display='block';return;}
  if(!k.startsWith('sk-ant-')){err.textContent='Anthropic keys start with sk-ant-';err.style.display='block';return;}
  localStorage.setItem('conduit-api-key',k); err.style.display='none'; cm('ovKey'); updateKeyBtn(); toast('API key saved ‚úì','ok');
}
function updateKeyBtn(){const b=document.getElementById('keyBtn');if(!b)return;if(getKey()){b.textContent='üîë API Key ‚úì';b.classList.add('set');}else{b.textContent='üîë Set API Key';b.classList.remove('set');}}

function bgRenderComps() {
  const el = document.getElementById('bg-comps-table');
  if (!el) return;
  const lifeDeals = S.deals.filter(d => {
    const s = (d.sector||'').toLowerCase();
    const p = (d.property||'').toLowerCase();
    return s.includes('life') || s.includes('lab') || s.includes('science') ||
           p.includes('king') || p.includes('cross') || p.includes('london');
  }).slice(-8);
  if (!lifeDeals.length) {
    el.innerHTML = '<div style="font-size:13px;color:var(--mid);font-style:italic">No life sciences comparables in your deals database yet. Add deals in the Deals tab.</div>';
    return;
  }
  el.innerHTML = '<div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:13px">' +
    '<thead><tr style="border-bottom:2px solid var(--rule)">' +
    '<th style="text-align:left;padding:7px 10px;color:#3a5068;font-size:11px;font-weight:700">PROPERTY</th>' +
    '<th style="text-align:left;padding:7px 10px;color:#3a5068;font-size:11px;font-weight:700">SECTOR</th>' +
    '<th style="text-align:right;padding:7px 10px;color:#3a5068;font-size:11px;font-weight:700">PRICE ¬£M</th>' +
    '<th style="text-align:right;padding:7px 10px;color:#3a5068;font-size:11px;font-weight:700">YIELD</th>' +
    '<th style="text-align:left;padding:7px 10px;color:#3a5068;font-size:11px;font-weight:700">DATE</th>' +
    '<th style="text-align:left;padding:7px 10px;color:#3a5068;font-size:11px;font-weight:700">BUYER</th>' +
    '</tr></thead><tbody>' +
    lifeDeals.map((d,i) => `<tr style="border-bottom:1px solid var(--rule);background:${i%2?'var(--warm)':'#fff'}">
      <td style="padding:8px 10px;font-weight:600;color:var(--navy3)">${esc(d.property||'‚Äî')}</td>
      <td style="padding:8px 10px;color:var(--text)">${esc(d.sector||'‚Äî')}</td>
      <td style="padding:8px 10px;text-align:right;font-weight:700;color:var(--navy)">${d.price?'¬£'+esc(d.price)+'M':'‚Äî'}</td>
      <td style="padding:8px 10px;text-align:right;color:var(--gold3);font-weight:700">${d.yield?esc(d.yield)+'%':'‚Äî'}</td>
      <td style="padding:8px 10px;color:var(--mid)">${esc(d.date||'‚Äî')}</td>
      <td style="padding:8px 10px;color:var(--text)">${esc(d.buyer||'‚Äî')}</td>
    </tr>`).join('') +
    '</tbody></table></div>';
}

function bgUpdateRaise() {
  const v = parseFloat(document.getElementById('bg-raised-input').value);
  if (isNaN(v) || v < 0) { toast('Enter a valid amount', 'err'); return; }
  S.belgrove.raisedM = v;
  saveState();
  bgRenderProgress();
  toast('Raise progress updated ‚úì', 'ok');
}

function bgUpdateStatus() {
  S.belgrove.raiseStatus = document.getElementById('bg-status-sel').value;
  saveState();
  document.getElementById('bg-status-val').textContent = S.belgrove.raiseStatus;
  toast('Status updated ‚úì', 'ok');
}

function bgRenderProgress() {
  const pct = Math.min(100, (S.belgrove.raisedM / S.belgrove.targetM) * 100);
  const bar = document.getElementById('bg-progress-bar');
  const val = document.getElementById('bg-raised-val');
  const stat = document.getElementById('bg-status-val');
  const sel = document.getElementById('bg-status-sel');
  if (bar) bar.style.width = pct + '%';
  if (val) val.textContent = S.belgrove.raisedM;
  if (stat) stat.textContent = S.belgrove.raiseStatus;
  if (sel) sel.value = S.belgrove.raiseStatus;
}

async function bgGenerateQA() {
  const btn = document.getElementById('bg-qa-btn');
  const st = document.getElementById('bg-qa-status');
  const el = document.getElementById('bg-qa-content');
  if (btn) { btn.disabled=true; btn.textContent='Generating‚Ä¶'; }
  if (st) { st.style.display='flex'; st.className='xstat on load'; st.innerHTML='<div class="spin"></div><span>Anticipating IC questions‚Ä¶</span>'; }

  const compsContext = S.deals.filter(d=>(d.sector||'').toLowerCase().includes('life') || (d.property||'').toLowerCase().includes('king')).slice(-5);
  const kpiContext = S.kpis.filter(k=>k.value).slice(0,6);

  const prompt = `You are preparing Ryon Paton (Conduit Investors) to pitch Belgrove House to a family office IC. Generate the 10 hardest questions a sophisticated family office investment committee will ask, with IC-standard answers.

Deal: Belgrove House, King's Cross, London. 180,000 sq ft purpose-built life sciences. Became available after Merck/MSD withdrew from pre-let. Conduit raising ¬£90-95M. Target stabilised yield-on-cost 5-5.5%.
Comparables: ${JSON.stringify(compsContext)}
Market data: ${JSON.stringify(kpiContext)}

JSON only: {"qa":[{"q":"the hard question","a":"IC-standard answer with specific data points, yield context, and risk mitigation. 3-5 sentences. Be direct."}]}

Focus on: vacancy risk post-Merck, yield justification vs alternatives, life sciences occupier demand, supply pipeline risk, exit liquidity, comparable evidence, macro sensitivity, why now, why King's Cross specifically, why Conduit.`;

  try {
    const raw = await callClaude(prompt);
    const p = parseJSON(raw);
    S.belgrove.qa = p.qa || [];
    S.belgrove.qaGeneratedAt = new Date().toLocaleString('en-GB');
    saveState();
    bgRenderQA();
    if (st) st.style.display='none';
    toast('Q&A generated ‚úì', 'ok');
  } catch(err) {
    if (st) { st.className='xstat on bad'; st.innerHTML=apiErrMsg(err); }
    toast(apiErrMsg(err), 'err');
  }
  if (btn) { btn.disabled=false; btn.textContent='‚ú¶ Regenerate Q&A'; }
}

function bgRenderQA() {
  const el = document.getElementById('bg-qa-content');
  if (!el || !S.belgrove.qa.length) return;
  el.innerHTML = (S.belgrove.qaGeneratedAt ? `<div style="font-size:11px;color:var(--mid);margin-bottom:14px">Generated ${S.belgrove.qaGeneratedAt}</div>` : '') +
    S.belgrove.qa.map((item,i) => `
      <div style="margin-bottom:16px;border-left:3px solid var(--gold2);padding-left:14px">
        <div style="font-size:13px;font-weight:700;color:var(--navy3);margin-bottom:5px">Q${i+1}. ${esc(item.q)}</div>
        <div style="font-size:13px;line-height:1.75;color:var(--text)">${esc(item.a)}</div>
      </div>`).join('') +
    `<button class="btn bo bsm" style="margin-top:8px" onclick="bgCopyQA()">Copy Q&A</button>`;
}

function bgCopyQA() {
  const text = S.belgrove.qa.map((item,i) => `Q${i+1}. ${item.q}\n\nA: ${item.a}`).join('\n\n---\n\n');
  navigator.clipboard.writeText('BELGROVE HOUSE ‚Äî IC Q&A\nConduit Investors\n\n' + text)
    .then(() => toast('Copied ‚úì', 'ok'));
}

async function bgGenerateOnePager() {
  const btn = document.getElementById('bg-op-btn');
  const st = document.getElementById('bg-op-status');
  const el = document.getElementById('bg-op-content');
  if (btn) { btn.disabled=true; btn.textContent='Generating‚Ä¶'; }
  if (st) { st.style.display='flex'; st.className='xstat on load'; st.innerHTML='<div class="spin"></div><span>Drafting investor one-pager‚Ä¶</span>'; }

  const comps = S.deals.filter(d=>(d.sector||'').toLowerCase().includes('life')).slice(-4);
  const kpis = S.kpis.filter(k=>k.value).slice(0,8);

  const prompt = `Write a concise investor one-pager for Belgrove House for a family office audience. Professional, direct, IC-quality. No fluff.

Deal: Belgrove House, King's Cross, London. 180,000 sq ft purpose-built life sciences. Available after Merck/MSD pre-let withdrawal. Conduit Investors raising ¬£90-95M. Target stabilised yield-on-cost 5-5.5%.
Market data: ${JSON.stringify(kpis)}
Comparable deals: ${JSON.stringify(comps)}

JSON only: {
  "tagline": "one powerful sentence ‚Äî the investment case",
  "opportunity": "2-3 sentences: what the asset is, why it became available, why now",
  "thesis_points": ["4 bullet points ‚Äî the four pillars of the investment case with specific data"],
  "market_context": "2-3 sentences: Golden Triangle take-up (+42% YoY), King's Cross ecosystem, selective slowdown not frozen",
  "returns": "2-3 sentences: target yield-on-cost, how it compares to alternatives, time horizon",
  "risks_mitigants": [{"risk":"specific risk","mitigant":"specific mitigation"}],
  "comparables_note": "1-2 sentences on comparable transactions and what they tell us about pricing",
  "call_to_action": "one sentence closing"
}`;

  try {
    const raw = await callClaude(prompt);
    const p = parseJSON(raw);
    S.belgrove.onepager = raw;
    S.belgrove.onepagerAt = new Date().toLocaleString('en-GB');
    saveState();
    bgRenderOnePager(p);
    if (st) st.style.display='none';
    toast('One-pager generated ‚úì', 'ok');
  } catch(err) {
    if (st) { st.className='xstat on bad'; st.innerHTML=apiErrMsg(err); }
    toast(apiErrMsg(err), 'err');
  }
  if (btn) { btn.disabled=false; btn.textContent='‚ú¶ Regenerate'; }
}

function bgRenderOnePager(p) {
  const el = document.getElementById('bg-op-content');
  if (!el) return;
  const risks = (p.risks_mitigants||[]).map(r => `
    <tr>
      <td style="padding:7px 10px;font-size:12.5px;color:var(--red);vertical-align:top">${esc(r.risk)}</td>
      <td style="padding:7px 10px;font-size:12.5px;color:var(--green);vertical-align:top">${esc(r.mitigant)}</td>
    </tr>`).join('');

  el.innerHTML = `
    <div style="border:2px solid var(--navy3);border-radius:8px;overflow:hidden;max-width:780px">
      <!-- Header -->
      <div style="background:var(--navy3);padding:20px 24px;color:#fff">
        <div style="font-size:10px;font-weight:700;letter-spacing:.15em;text-transform:uppercase;color:var(--gold2);margin-bottom:6px">Conduit Investors ¬∑ Strictly Confidential</div>
        <div style="font-family:'Cormorant Garamond',serif;font-size:26px;font-weight:700;margin-bottom:4px">Belgrove House</div>
        <div style="font-size:13px;color:rgba(255,255,255,.7);margin-bottom:10px">King's Cross, London ¬∑ 180,000 sq ft ¬∑ Life Sciences ¬∑ ¬£90‚Äì95M</div>
        <div style="font-size:15px;color:var(--gold2);font-style:italic;font-weight:600">${esc(p.tagline||'')}</div>
      </div>
      <!-- Body -->
      <div style="padding:20px 24px;background:#fff">
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:18px">
          <div>
            <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:7px">The Opportunity</div>
            <p style="font-size:13px;line-height:1.75;color:var(--text);margin:0">${esc(p.opportunity||'')}</p>
          </div>
          <div>
            <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:7px">Investment Thesis</div>
            ${(p.thesis_points||[]).map(pt=>`<div style="font-size:12.5px;line-height:1.6;color:var(--text);padding:3px 0 3px 12px;border-left:2px solid var(--gold2);margin-bottom:6px">${esc(pt)}</div>`).join('')}
          </div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:18px">
          <div>
            <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:7px">Market Context</div>
            <p style="font-size:13px;line-height:1.75;color:var(--text);margin:0">${esc(p.market_context||'')}</p>
          </div>
          <div>
            <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:7px">Target Returns</div>
            <p style="font-size:13px;line-height:1.75;color:var(--text);margin:0">${esc(p.returns||'')}</p>
          </div>
        </div>
        ${risks ? `<div style="margin-bottom:18px">
          <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:7px">Key Risks & Mitigants</div>
          <table style="width:100%;border-collapse:collapse;border:1px solid var(--rule);border-radius:6px;overflow:hidden">
            <thead><tr style="background:var(--warm)">
              <th style="padding:7px 10px;font-size:11px;font-weight:700;color:var(--red);text-align:left;width:50%">RISK</th>
              <th style="padding:7px 10px;font-size:11px;font-weight:700;color:var(--green);text-align:left">MITIGANT</th>
            </tr></thead><tbody>${risks}</tbody>
          </table>
        </div>` : ''}
        ${p.comparables_note ? `<div style="margin-bottom:18px">
          <div style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:7px">Comparable Evidence</div>
          <p style="font-size:13px;line-height:1.75;color:var(--text);margin:0">${esc(p.comparables_note||'')}</p>
        </div>` : ''}
        <div style="background:var(--navy3);border-radius:6px;padding:12px 16px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:10px">
          <div style="font-size:13px;color:var(--gold2);font-weight:600;font-style:italic">${esc(p.call_to_action||'')}</div>
          <div style="display:flex;gap:8px">
            <button class="btn bsm" style="background:var(--gold);color:#fff;border:none" onclick="bgCopyOnePager()">Copy Text</button>
          </div>
        </div>
      </div>
    </div>
    <div style="margin-top:10px;font-size:11px;color:var(--mid)">Generated ${S.belgrove.onepagerAt} ¬∑ Confidential ‚Äî Conduit Investors</div>`;
}

function bgCopyOnePager() {
  const p = parseJSON(S.belgrove.onepager);
  const text = [
    'BELGROVE HOUSE ‚Äî INVESTOR SUMMARY',
    'Conduit Investors ¬∑ Strictly Confidential',
    '',
    p.tagline,
    '',
    'THE OPPORTUNITY',
    p.opportunity,
    '',
    'INVESTMENT THESIS',
    ...(p.thesis_points||[]).map(pt=>'‚Ä¢ '+pt),
    '',
    'MARKET CONTEXT',
    p.market_context,
    '',
    'TARGET RETURNS',
    p.returns,
    '',
    'KEY RISKS & MITIGANTS',
    ...(p.risks_mitigants||[]).map(r=>'Risk: '+r.risk+' ‚Üí '+r.mitigant),
    '',
    p.call_to_action
  ].join('\n');
  navigator.clipboard.writeText(text).then(()=>toast('Copied ‚úì','ok'));
}

function onBelgroveTab() {
  bgRenderProgress();
  bgRenderComps();
  if (S.belgrove.qa.length) bgRenderQA();
  if (S.belgrove.onepager) {
    try { bgRenderOnePager(parseJSON(S.belgrove.onepager)); } catch(e) {}
  }
}


// ‚ïê‚ïê MARKET TICKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function fetchTicker() {
  const btn = document.getElementById('tk-btn');
  if (btn) btn.textContent = '‚Üª ‚Ä¶';
  const key = getKey();
  if (!key) { if (btn) btn.textContent = '‚Üª Refresh'; return; }
  try {
    // Use a single call with web search ‚Äî pass all content blocks back for synthesis
    const r1 = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body: JSON.stringify({
        model:'claude-haiku-4-5-20251001', max_tokens:1200,
        tools:[{type:'web_search_20250305',name:'web_search'}],
        messages:[{role:'user',content:'Search for the exact latest closing prices for: "Dow Jones Industrial Average" close price today, "NASDAQ Composite" close price today, "FTSE 100" close price today, "Bank of England base rate" current, "UK 10 year gilt yield" current, "USD GBP exchange rate" current. Find the most recent exact numbers.'}]
      })
    });
    const d1 = await r1.json();
    if (!r1.ok) throw new Error((d1.error&&d1.error.message)||'Search failed');

    // Pass full conversation back so AI has actual search results to read
    const r2 = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body: JSON.stringify({
        model:'claude-haiku-4-5-20251001', max_tokens:500,
        messages:[
          {role:'user',content:'Search for the exact latest closing prices for: "Dow Jones Industrial Average" close price today, "NASDAQ Composite" close price today, "FTSE 100" close price today, "Bank of England base rate" current, "UK 10 year gilt yield" current, "USD GBP exchange rate" current. Find the most recent exact numbers.'},
          {role:'assistant',content:d1.content},
          {role:'user',content:'From those search results extract EXACT numbers only. Never invent. Return ONLY JSON no markdown: {"dow":{"val":"49499","chg":"+0.03%","up":true},"nas":{"val":"22878","chg":"-1.18%","up":false},"ftse":{"val":"8650","chg":"+0.2%","up":true},"boe":{"val":"4.75%","chg":"unchanged","up":null},"gilt":{"val":"4.52%","chg":"+2bps","up":false},"fx":{"val":"0.79","chg":"-0.1%","up":false}} - replace values with exact real numbers from search, use dash string for any not found.'}
        ]
      })
    });
    const d2 = await r2.json();
    if (!r2.ok) throw new Error((d2.error&&d2.error.message)||'Parse failed');
    const text = (d2.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('');
    const m = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim().match(/\{[\s\S]*\}/);
    if (!m) throw new Error('Could not parse market data response');
    const p = JSON.parse(m[0]);
    const fields = [
      ['dow','tk-dow','tk-dow-c'],
      ['nas','tk-nas','tk-nas-c'],
      ['ftse','tk-ftse','tk-ftse-c'],
      ['boe','tk-boe','tk-boe-c'],
      ['gilt','tk-gilt','tk-gilt-c'],
      ['fx','tk-fx','tk-fx-c']
    ];
    fields.forEach(([key,vid,cid]) => {
      const d = p[key]||{};
      const ve = document.getElementById(vid);
      const ce = document.getElementById(cid);
      if (ve) { ve.textContent = d.val||'‚Äî'; ve.style.color='#ffffff'; }
      if (ce) {
        ce.textContent = d.chg||'';
        ce.style.color = d.up===true?'#4eff91':d.up===false?'#ff7070':'#ffffff';
      }
    });
    const te = document.getElementById('tk-time');
    if (te) te.textContent = 'Updated ' + new Date().toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit'});
    toast('Markets updated ‚úì','ok');
  } catch(e) {
    toast('Market data fetch failed ‚Äî try again','err');
  }
  if (btn) btn.textContent = '‚Üª Refresh';
}

// ‚ïê‚ïê NARRATIVE ACCURACY CHECKER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function checkNarrAccuracy() {
  const panel = document.getElementById('narr-check-panel');
  if (!panel) return;
  if (!S.narr.macro && !S.narr.sector) { toast('Generate a narrative draft first','err'); return; }
  panel.style.display = 'block';
  panel.innerHTML = '<div class="xstat on load" style="display:flex"><div class="spin"></div><span>Fact-checking narrative against live market data‚Ä¶</span></div>';

  const narrativeText = [S.narr.headline, S.narr.macro, S.narr.sector, S.narr.deals, S.narr.impl].filter(Boolean).join('\n\n').slice(0,3000);
  const marketData = JSON.stringify(S.intel.slice(-20));
  const deals = JSON.stringify(S.deals.slice(-10));

  const prompt = `You are a senior CoStar analyst fact-checking an investor narrative for accuracy.

NARRATIVE TO CHECK:
${narrativeText}

PLATFORM MARKET DATA:
${marketData}

COMPARABLE DEALS:
${deals}

KNOWN BENCHMARKS (use these to calibrate):
- Golden Triangle life sciences take-up: 1.35m sq ft in 2025 (+42% YoY)
- London life sciences take-up: ~203k sq ft (modest but improving)
- Pipeline under construction: 3.6m sq ft
- Prime London office NIY: ~4.5-5.5%
- Stabilised yield-on-cost target for quality assets: 5-5.5%
- BoE base rate: ~4.5%
- Secondary office vacancy: elevated, liquidity impaired
- Life sciences occupier market: selective slowdown, NOT frozen

For each major claim in the narrative, assess accuracy. JSON only:
{"score":85,"verdict":"Strong / Needs Work / Caution","checks":[{"claim":"exact claim from narrative","status":"accurate|overstated|understated|unverified","note":"brief correction or confirmation with data"}],"missing":["important market facts not mentioned that would strengthen this narrative"],"strongest":"the most credible and well-supported claim","weakest":"the claim most likely to be challenged by an IC"}`;

  try {
    const raw = await callClaude(prompt);
    const p = parseJSON(raw);
    const checks = p.checks||[];
    const statusColor = {accurate:'var(--green)',overstated:'var(--red)',understated:'var(--amber)',unverified:'var(--mid)'};
    const statusIcon = {accurate:'‚úì',overstated:'‚ö†',understated:'‚Üì',unverified:'?'};
    const scoreColor = p.score>=80?'var(--green)':p.score>=60?'var(--amber)':'var(--red)';

    panel.innerHTML = `
      <div style="border:2px solid var(--rule);border-radius:8px;overflow:hidden">
        <div style="background:var(--navy3);padding:14px 18px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px">
          <div style="font-size:11px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--gold2)">Accuracy Report</div>
          <div style="display:flex;align-items:center;gap:12px">
            <div style="font-size:24px;font-weight:800;font-family:'Cormorant Garamond',serif;color:${scoreColor}">${p.score||'‚Äî'}<span style="font-size:13px;color:rgba(255,255,255,.5)">/100</span></div>
            <div style="font-size:13px;font-weight:700;color:#fff">${esc(p.verdict||'')}</div>
          </div>
        </div>
        <div style="padding:16px 18px;background:#fff">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
            ${p.strongest?`<div style="background:var(--gbg);border:1px solid var(--gbdr);border-radius:6px;padding:10px 12px"><div style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">‚úì Strongest Claim</div><div style="font-size:12.5px;line-height:1.5;color:var(--text)">${esc(p.strongest)}</div></div>`:''}
            ${p.weakest?`<div style="background:var(--rbg);border:1px solid #f5c5c5;border-radius:6px;padding:10px 12px"><div style="font-size:10px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">‚ö† Most Likely to Be Challenged</div><div style="font-size:12.5px;line-height:1.5;color:var(--text)">${esc(p.weakest)}</div></div>`:''}
          </div>
          <div style="margin-bottom:14px">
            <div style="font-size:11px;font-weight:700;color:var(--mid);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px">Claim-by-Claim Check</div>
            ${checks.map(ch=>`<div style="display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--rule);align-items:flex-start">
              <div style="flex-shrink:0;width:20px;height:20px;border-radius:50%;background:${statusColor[ch.status]||'var(--mid)'};display:flex;align-items:center;justify-content:center;font-size:11px;color:#fff;font-weight:700;margin-top:1px">${statusIcon[ch.status]||'?'}</div>
              <div style="flex:1">
                <div style="font-size:12.5px;font-weight:600;color:var(--text);margin-bottom:2px">${esc(ch.claim||'')}</div>
                <div style="font-size:12px;color:${statusColor[ch.status]||'var(--mid)'}">${esc(ch.note||'')}</div>
              </div>
            </div>`).join('')}
          </div>
          ${(p.missing||[]).length?`<div style="background:var(--abg);border:1px solid var(--abdr);border-radius:6px;padding:12px 14px">
            <div style="font-size:10px;font-weight:700;color:var(--amber);text-transform:uppercase;letter-spacing:.1em;margin-bottom:8px">Missing Data Points That Would Strengthen This</div>
            ${p.missing.map(m=>`<div style="font-size:12px;line-height:1.6;color:var(--amber);padding:2px 0 2px 12px;border-left:2px solid var(--gold2);margin-bottom:4px">${esc(m)}</div>`).join('')}
          </div>`:''}
          <button class="btn bo bsm" style="margin-top:12px" onclick="document.getElementById('narr-check-panel').style.display='none'">Dismiss</button>
        </div>
      </div>`;
    toast('Fact-check complete ‚úì','ok');
  } catch(e) {
    panel.innerHTML = `<div class="xstat on bad" style="display:flex">${apiErrMsg(e)}</div>`;
  }
}

// ‚ïê‚ïê LEARN ‚Äî AI TUTOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function learnQuick(btn) {
  document.getElementById('learn-q').value = btn.textContent;
  learnAsk();
}

async function learnAsk() {
  const q = (document.getElementById('learn-q')?.value||'').trim();
  if (!q) return;
  const btn = document.getElementById('learn-btn');
  const st = document.getElementById('learn-status');
  const el = document.getElementById('learn-answer');
  if (btn) btn.disabled=true;
  if (st) { st.style.display='flex'; st.className='xstat on load'; st.innerHTML='<div class="spin"></div><span>Thinking‚Ä¶</span>'; }
  if (el) el.innerHTML='';

  const prompt = `You are a CRE tutor helping James, a beginner analyst at Conduit Investors. He needs to become a proforma expert and "numbers guy" to support Ryon Paton who is pitching London life sciences deals to US family offices.

Question: ${q}

Context: Conduit is raising ¬£90-95M for Belgrove House, a 180,000 sq ft life sciences building in King's Cross. James needs to understand CRE metrics, proformas, and how to talk to sophisticated investors.

Give a clear, structured answer. JSON only:
{
  "headline": "one sentence plain English answer",
  "explanation": "2-3 paragraphs explaining the concept clearly. Use simple language first, then build to the technical detail.",
  "example": "a specific worked example with real numbers ‚Äî ideally using Belgrove House or a King's Cross comparable",
  "why_it_matters": "one paragraph: why this matters specifically for the Belgrove House raise and family office conversations",
  "key_numbers": [{"label":"key metric name","value":"typical value or range","note":"what it means"}],
  "common_mistakes": "one sentence on the most common beginner mistake with this concept"
}`;

  try {
    const raw = await callClaude(prompt);
    const p = parseJSON(raw);
    if (st) st.style.display='none';
    el.innerHTML = `
      <div style="border-left:3px solid var(--gold2);padding-left:14px;margin-bottom:14px">
        <div style="font-size:16px;font-weight:700;color:var(--navy3);font-family:'Cormorant Garamond',serif;margin-bottom:4px">${esc(p.headline||'')}</div>
      </div>
      <div style="font-size:13.5px;line-height:1.85;color:var(--text);margin-bottom:14px;white-space:pre-line">${esc(p.explanation||'')}</div>
      ${p.key_numbers?.length?`<div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:14px">
        ${p.key_numbers.map(k=>`<div style="background:var(--navy3);border-radius:6px;padding:10px 14px;min-width:120px">
          <div style="font-size:10px;color:rgba(255,255,255,.5);text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px">${esc(k.label)}</div>
          <div style="font-size:18px;font-weight:700;color:var(--gold2);font-family:'Cormorant Garamond',serif">${esc(k.value)}</div>
          <div style="font-size:11px;color:rgba(255,255,255,.6);margin-top:2px">${esc(k.note)}</div>
        </div>`).join('')}
      </div>`:''}
      ${p.example?`<div style="background:var(--warm);border:1px solid var(--rule);border-radius:6px;padding:12px 14px;margin-bottom:12px">
        <div style="font-size:10px;font-weight:700;color:var(--gold3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px">Worked Example</div>
        <div style="font-size:13px;line-height:1.75;color:var(--text);white-space:pre-line">${esc(p.example)}</div>
      </div>`:''}
      ${p.why_it_matters?`<div style="background:var(--gbg);border:1px solid var(--gbdr);border-radius:6px;padding:10px 14px;margin-bottom:12px">
        <div style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:5px">Why This Matters for Belgrove House</div>
        <div style="font-size:13px;line-height:1.7;color:var(--text)">${esc(p.why_it_matters)}</div>
      </div>`:''}
      ${p.common_mistakes?`<div style="background:var(--rbg);border:1px solid #f5c5c5;border-radius:6px;padding:10px 14px">
        <div style="font-size:10px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">‚ö† Common Beginner Mistake</div>
        <div style="font-size:13px;color:var(--text)">${esc(p.common_mistakes)}</div>
      </div>`:''}`;
    toast('Answer ready ‚úì','ok');
  } catch(e) {
    if (st) { st.className='xstat on bad'; st.innerHTML=apiErrMsg(e); }
  }
  if (btn) btn.disabled=false;
}

// ‚ïê‚ïê PROFORMA CALCULATOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function pfCalc() {
  const rent = parseFloat(document.getElementById('pf-rent')?.value)||0;
  const area = parseFloat(document.getElementById('pf-area')?.value)||0;
  const occ  = parseFloat(document.getElementById('pf-occ')?.value)||100;
  const other= parseFloat(document.getElementById('pf-other')?.value)||0;
  const svc  = parseFloat(document.getElementById('pf-svc')?.value)||0;
  const mgmt = parseFloat(document.getElementById('pf-mgmt')?.value)||0;
  const capex= parseFloat(document.getElementById('pf-capex')?.value)||0;
  const price= parseFloat(document.getElementById('pf-price')?.value)||0;

  const gross = rent * area;
  const egi   = gross * (occ/100) + other;
  const mgmtCost = egi * (mgmt/100);
  const opex  = svc + mgmtCost + capex;
  const noi   = egi - opex;
  const niy   = price>0 ? (noi / (price*1000000))*100 : 0;
  const yoc   = price>0 ? (noi / (price*1000000))*100 : 0;

  const fmt = n => '¬£' + (n>=1000000?(n/1000000).toFixed(2)+'M':(n/1000).toFixed(0)+'K');
  const pct = n => n.toFixed(2)+'%';

  const set = (id,v) => { const e=document.getElementById(id); if(e) e.textContent=v; };
  set('pf-r-gross', fmt(gross));
  set('pf-r-egi',   fmt(egi));
  set('pf-r-opex',  fmt(opex));
  set('pf-r-noi',   fmt(noi));
  set('pf-r-niy',   pct(niy));
  set('pf-r-yoc',   pct(yoc));

  const ex = document.getElementById('pf-explain');
  if (ex) {
    const signal = yoc >= 5.0 && yoc <= 5.5 ? '‚úì Within Conduit\'s target range (5‚Äì5.5%)' :
                   yoc > 5.5 ? '‚Üë Above target ‚Äî strong return but check assumptions' :
                   yoc > 4.0 ? '‚ö† Below Conduit\'s 5% target ‚Äî consider renegotiating price or improving occupancy' :
                   '‚úó Below market threshold ‚Äî reassess deal economics';
    ex.innerHTML = `<strong style="color:var(--gold2)">${signal}</strong><br>NOI of ${fmt(noi)}/yr on ${fmt(price*1000000)} purchase price = ${pct(yoc)} yield-on-cost. Note: NIY uses contracted rent; yield-on-cost uses actual achieved income after all costs.`;
  }
}

// ‚ïê‚ïê GLOSSARY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const GLOSSARY = [
  {t:'NIY ‚Äî Net Initial Yield',d:'Contracted rent √∑ purchase price. The headline number. Understates real return because it ignores vacancies, incentives, and capex.'},
  {t:'Yield-on-Cost',d:'Stabilised NOI √∑ total cost (price + capex). More accurate than NIY for development or repositioning deals. Conduit targets 5‚Äì5.5%.'},
  {t:'NOI ‚Äî Net Operating Income',d:'Effective gross income minus all operating expenses. The number that drives valuation. Everything else is noise.'},
  {t:'Cap Rate',d:'NOI √∑ market value. Lower = more expensive asset. Prime London offices: ~4.5‚Äì5.5%. Falling cap rates = rising values.'},
  {t:'IRR ‚Äî Internal Rate of Return',d:'The annualised return on investment over the hold period, including income and exit proceeds. Target for UK CRE PE: 10‚Äì15%+.'},
  {t:'DSCR ‚Äî Debt Service Coverage',d:'NOI √∑ annual debt payments. Lenders typically require >1.25x. Below 1.0x = property can\'t service its debt.'},
  {t:'LTV ‚Äî Loan to Value',d:'Loan amount √∑ property value. UK CRE lenders typically cap at 55‚Äì65% LTV for prime assets. Higher LTV = higher risk.'},
  {t:'Covered Land Play',d:'Buying an asset primarily for future redevelopment value, with current income providing "cover" while you wait. How sophisticated buyers underwrite prime London offices today.'},
  {t:'EPC Arbitrage',d:'Buying assets with poor energy ratings cheaply, then upgrading them to meet MEES regulations. Creates value through compliance, not just leasing.'},
  {t:'Golden Triangle',d:'London‚ÄìOxford‚ÄìCambridge life sciences ecosystem. Structurally scarce. Demand is ecosystem-driven ‚Äî UCL, Francis Crick, MRC labs. Separate analysis from speculative suburban labs.'},
  {t:'Bid-Ask Spread',d:'Gap between what sellers want and buyers will pay. Wide spread = illiquid market, dislocation opportunity. Sellers anchored to 2021 pricing; buyers pricing 2025 reality.'},
  {t:'Structural Divergence',d:'Prime and secondary markets moving in opposite directions simultaneously. Prime London offices strengthening; secondary offices distressed. Not a cycle ‚Äî different assets, different outcomes.'},
  {t:'Duration Mismatch',d:'The real problem with secondary offices: leases are shortening but assets need long-term capital. Investors can\'t exit. Liquidity risk, not just vacancy risk.'},
  {t:'Conviction Capital',d:'Money deployed because investors genuinely believe in the thesis ‚Äî overseas sovereigns buying prime London ahead of occupier recovery. Opposite: forced allocation.'},
  {t:'Stabilised NOI',d:'What the asset will earn once fully leased at market rents, after lease-up costs. The number yield-on-cost is calculated from. More honest than contracted rent.'},
  {t:'MEES Regulations',d:'Minimum Energy Efficiency Standards. From 2023, commercial leases require EPC rating E or above. Driving obsolescence of old stock and creating repositioning plays.'},
];

function renderGlossary() {
  const el = document.getElementById('glossary-grid');
  if (!el) return;
  el.innerHTML = GLOSSARY.map(g=>`<div class="gloss-item">
    <div class="gloss-term">${esc(g.t)}</div>
    <div class="gloss-def">${esc(g.d)}</div>
  </div>`).join('');
}

// ‚ïê‚ïê PITCH COACH ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function pitchCoach() {
  const input = (document.getElementById('pitch-input')?.value||'').trim();
  if (!input) { toast('Type your pitch first','err'); return; }
  const st = document.getElementById('pitch-status');
  const el = document.getElementById('pitch-feedback');
  if (st) { st.style.display='flex'; st.className='xstat on load'; st.innerHTML='<div class="spin"></div><span>Analysing your pitch‚Ä¶</span>'; }
  if (el) el.innerHTML='';

  const prompt = `You are a senior REPE partner coaching James, a junior analyst at Conduit Investors, on how to pitch Belgrove House to family office investors.

James's pitch attempt:
"${input}"

Assess this pitch as if you were a family office IC member hearing it. JSON only:
{
  "score": 75,
  "verdict": "Good start / Needs Work / Strong",
  "what_worked": "what was clear and compelling",
  "what_missed": "what a family office would want to hear that wasn't there",
  "red_flags": "anything that would raise doubts or seem amateurish",
  "improved_version": "rewrite the pitch at IC standard ‚Äî same core points but sharper, more specific, more credible. 3-4 sentences.",
  "one_tip": "the single most important thing to practise"
}`;

  try {
    const raw = await callClaude(prompt);
    const p = parseJSON(raw);
    if (st) st.style.display='none';
    const scoreColor = p.score>=80?'var(--green)':p.score>=60?'var(--amber)':'var(--red)';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:14px;margin-bottom:14px;flex-wrap:wrap">
        <div style="font-size:32px;font-weight:800;font-family:'Cormorant Garamond',serif;color:${scoreColor}">${p.score||'‚Äî'}<span style="font-size:14px;color:var(--mid)">/100</span></div>
        <div style="font-size:15px;font-weight:700;color:var(--navy3)">${esc(p.verdict||'')}</div>
      </div>
      ${p.what_worked?`<div style="background:var(--gbg);border:1px solid var(--gbdr);border-radius:6px;padding:10px 14px;margin-bottom:10px">
        <div style="font-size:10px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">‚úì What Worked</div>
        <div style="font-size:13px;line-height:1.6;color:var(--text)">${esc(p.what_worked)}</div>
      </div>`:''}
      ${p.what_missed?`<div style="background:var(--abg);border:1px solid var(--abdr);border-radius:6px;padding:10px 14px;margin-bottom:10px">
        <div style="font-size:10px;font-weight:700;color:var(--amber);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">Missing</div>
        <div style="font-size:13px;line-height:1.6;color:var(--text)">${esc(p.what_missed)}</div>
      </div>`:''}
      ${p.red_flags?`<div style="background:var(--rbg);border:1px solid #f5c5c5;border-radius:6px;padding:10px 14px;margin-bottom:10px">
        <div style="font-size:10px;font-weight:700;color:var(--red);text-transform:uppercase;letter-spacing:.1em;margin-bottom:4px">‚ö† Red Flags</div>
        <div style="font-size:13px;line-height:1.6;color:var(--text)">${esc(p.red_flags)}</div>
      </div>`:''}
      ${p.improved_version?`<div style="background:var(--navy3);border-radius:6px;padding:12px 16px;margin-bottom:10px">
        <div style="font-size:10px;font-weight:700;color:var(--gold2);text-transform:uppercase;letter-spacing:.1em;margin-bottom:6px">IC-Standard Version</div>
        <div style="font-size:13.5px;line-height:1.8;color:#fff;font-style:italic">"${esc(p.improved_version)}"</div>
      </div>`:''}
      ${p.one_tip?`<div style="border-left:3px solid var(--gold2);padding-left:12px;margin-top:4px">
        <div style="font-size:12px;font-weight:700;color:var(--gold3);text-transform:uppercase;letter-spacing:.1em;margin-bottom:3px">Top Tip</div>
        <div style="font-size:13px;color:var(--text)">${esc(p.one_tip)}</div>
      </div>`:''}`;
    toast('Feedback ready ‚úì','ok');
  } catch(e) {
    if (st) { st.className='xstat on bad'; st.innerHTML=apiErrMsg(e); }
  }
}

// ‚ïê‚ïê HOOK onLearnTab ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onLearnTab() {
  renderGlossary();
  pfCalc();
}


async function callClaude(prompt) {
  const key=getKey();
  if(!key){openKeyModal();throw new Error('NO_KEY');}
  const res=await fetch('https://api.anthropic.com/v1/messages',{
    method:'POST',
    headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
    body:JSON.stringify({model:'claude-haiku-4-5-20251001',max_tokens:4096,messages:[{role:'user',content:prompt}]})
  });
  const data=await res.json();
  if(!res.ok){const m=(data.error&&data.error.message)?data.error.message:'HTTP '+res.status;if(res.status===401)throw new Error('INVALID_KEY');if(res.status===429)throw new Error('RATE_LIMIT');throw new Error('API_ERROR: '+m);}
  return (data.content||[]).map(b=>b.text||'').join('').trim();
}

function parseJSON(raw) {
  let s=raw.replace(/^```(?:json)?\s*/i,'').replace(/\s*```\s*$/,'').trim();
  try{return JSON.parse(s);}catch(e){}
  const a=s.indexOf('{'),b=s.lastIndexOf('}');
  if(a!==-1&&b>a){try{return JSON.parse(s.slice(a,b+1));}catch(e){}}
  throw new Error('JSON parse failed: '+raw.slice(0,120));
}

function apiErrMsg(err) {
  const e=err&&err.message?err.message:String(err);
  if(e==='NO_KEY')       return 'No API key ‚Äî click üîë API Key to set one.';
  if(e==='INVALID_KEY')  return 'API key rejected ‚Äî click üîë to re-enter.';
  if(e==='RATE_LIMIT')   return 'Rate limit hit ‚Äî wait a moment and try again.';
  if(e.includes('credit')||e.includes('billing')) return 'Account credit issue ‚Äî add credits at console.anthropic.com.';
  if(e.includes('fetch')||e.includes('Failed')) return 'Network error ‚Äî check connection.';
  if(e.includes('JSON')) return 'Could not parse AI response ‚Äî try again.';
  return 'Error: '+e;
}

// ‚ïê‚ïê NAV ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let charts = {};
function go(id) {
  document.querySelectorAll('.pg').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.nb').forEach(b=>b.classList.remove('on'));
  document.getElementById('pg-'+id).classList.add('on');
  const nb=document.getElementById('nb-'+id);if(nb)nb.classList.add('on');
  if(id==='belgrove') onBelgroveTab();
  if(id==='live') onLiveTab();
  if(id==='learn') onLearnTab();
  const r={dash:renderDash,weekly:renderWeekly,comps:runComps,score:renderScorecard,deals:renderDeals,intel:renderIntel,digest:renderDigest,narr:renderNarr,article:renderArtLog,live:onLiveTab};
  if(r[id])r[id]();
  window.scrollTo(0,0);
}
function toast(msg,type){const t=document.getElementById('toast');t.textContent=msg;t.className='on '+(type||'ok');clearTimeout(t._t);t._t=setTimeout(()=>t.className='',3500);}
function om(id){document.getElementById(id).classList.add('on');}
function cm(id){document.getElementById(id).classList.remove('on');}
document.querySelectorAll('.ov').forEach(ov=>ov.addEventListener('click',function(e){if(e.target===this)this.classList.remove('on');}));

// ‚ïê‚ïê DASHBOARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDash() {
  const h=new Date().getHours();
  const g=h<12?'Good morning':h<17?'Good afternoon':'Good evening';
  setText('greetName',g+', Ryon.');
  setText('greetDate',new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'}));
  const wkd=getWeekDeals();
  setText('gs-deals',S.deals.length||'‚Äî');setText('gs-intel',S.intel.length||'‚Äî');
  setText('gs-arts',S.articles.length||'‚Äî');setText('gs-wkdeals',wkd.length||'‚Äî');

  document.getElementById('kpiGrid').innerHTML=S.kpis.map(k=>`
    <div class="stat-cell">
      <div class="stat-label">${esc(k.label)}</div>
      <div class="stat-val ${k.value?'':'nil'}">${esc(k.value)||'‚Äî'}</div>
      <div class="stat-src">${esc(k.source)}</div>
    </div>`).join('');

  renderCharts();

  // Weekly
  const dw=document.getElementById('dashWeekly');
  if(S.weekly&&S.weekly.headline){
    dw.innerHTML=`<div class="week-hdr">
      <div class="week-range">${esc(S.weekly.range||'')}</div>
      <div class="week-headline">${esc(S.weekly.headline)}</div>
      <div class="week-summary">${esc((S.weekly.summary||'').slice(0,280))}${(S.weekly.summary||'').length>280?'‚Ä¶':''}</div>
      ${(S.weekly.themes||[]).length?`<div class="pill-row">${S.weekly.themes.map(t=>`<div class="pill">${esc(t)}</div>`).join('')}</div>`:''}
    </div><button class="btn bo bsm" onclick="go('weekly')">Read Full Brief ‚Üí</button>`;
  } else {
    dw.innerHTML='<p style="color:var(--mid);font-style:italic;font-size:14px">No weekly brief yet. Go to Weekly Brief tab and click Generate.</p>';
  }

  // Recent deals
  const dd=document.getElementById('dashDeals');
  if(!S.deals.length){dd.innerHTML='<p style="color:var(--mid);font-style:italic;font-size:14px">No deals yet.</p>';}
  else{
    const rec=S.deals.slice(-6).reverse();
    dd.innerHTML=`<div class="tw"><table><thead><tr><th>Date</th><th>Property</th><th>Location</th><th>Sector</th><th>Price ¬£M</th><th>Status</th></tr></thead>
      <tbody>${rec.map(d=>`<tr><td style="font-size:11px;white-space:nowrap">${esc(d.date||'')}</td>
        <td style="font-weight:700;color:var(--navy)">${esc(d.property||'')}</td>
        <td>${esc(d.location||'')}</td><td>${esc(d.sector||'')}</td>
        <td style="text-align:right;font-weight:700">${esc(d.price||'')}</td>
        <td>${sbadge(d.status)}</td></tr>`).join('')}</tbody></table></div>`;
  }

  // Narrative
  const dn=document.getElementById('dashNarr');
  if(S.narr.headline||S.narr.macro){
    dn.innerHTML=`${S.narr.headline?`<p style="font-family:'Cormorant Garamond',serif;font-size:20px;font-style:italic;color:var(--navy3);margin-bottom:10px">${esc(S.narr.headline)}</p>`:''}`+
    `${S.narr.macro?`<p style="font-size:14px;line-height:1.8">${esc(S.narr.macro.slice(0,320))}${S.narr.macro.length>320?'‚Ä¶':''}</p>`:''}`+
    `<button class="btn bo bsm" style="margin-top:12px" onclick="go('narr')">Read Full ‚Üí</button>`;
  } else { dn.innerHTML='<p class="dnil">No narrative yet.</p>'; }

  updateCounts();
}

function renderCharts() {
  // Sector chart
  const sectors={};
  S.deals.forEach(d=>{const s=(d.sector||'Unknown').trim();sectors[s]=(sectors[s]||0)+1;});
  const sKeys=Object.keys(sectors).sort((a,b)=>sectors[b]-sectors[a]).slice(0,6);
  const sVals=sKeys.map(k=>sectors[k]);
  const palette=['#1C3355','#B8922A','#1A5C3A','#1A3C6A','#7A4A00','#6B7A8D'];

  const sc=document.getElementById('chartSector');
  if(sc){
    if(charts.sector){charts.sector.destroy();}
    if(sKeys.length){
      charts.sector=new Chart(sc,{type:'doughnut',data:{labels:sKeys,datasets:[{data:sVals,backgroundColor:palette,borderWidth:2,borderColor:'#fff'}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{position:'right',labels:{font:{family:'DM Sans',size:12},boxWidth:12,padding:10}}}}});
    } else { sc.getContext('2d').clearRect(0,0,sc.width,sc.height); }
  }

  // Intel over time ‚Äî group high priority by month
  const monthly={};
  S.intel.filter(i=>i.priority==='High').forEach(i=>{
    if(!i.date)return;
    const m=i.date.slice(0,7);
    monthly[m]=(monthly[m]||0)+1;
  });
  const mKeys=Object.keys(monthly).sort().slice(-8);
  const mVals=mKeys.map(k=>monthly[k]);
  const mLabels=mKeys.map(k=>{try{const d=new Date(k+'-01');return d.toLocaleDateString('en-GB',{month:'short',year:'2-digit'});}catch(e){return k;}});

  const ic=document.getElementById('chartIntel');
  if(ic){
    if(charts.intel){charts.intel.destroy();}
    if(mKeys.length){
      charts.intel=new Chart(ic,{type:'bar',data:{labels:mLabels,datasets:[{label:'High Priority Data Points',data:mVals,backgroundColor:'rgba(184,146,42,.75)',borderColor:'#B8922A',borderWidth:1.5,borderRadius:4}]},
        options:{responsive:true,maintainAspectRatio:false,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{stepSize:1,font:{family:'DM Sans',size:11}},grid:{color:'rgba(0,0,0,.04)'}},x:{ticks:{font:{family:'DM Sans',size:11}},grid:{display:false}}}}});
    }
  }
}

function updateCounts(){
  const dc=document.getElementById('ct-deals');if(dc){dc.textContent=S.deals.length;dc.className=S.deals.length?'nbct on':'nbct';}
  const ic=document.getElementById('ct-intel');if(ic){ic.textContent=S.intel.length;ic.className=S.intel.length?'nbct on':'nbct';}
}

// ‚ïê‚ïê WEEKLY ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getWeekRange(){
  const now=new Date(),day=now.getDay();
  const mon=new Date(now);mon.setDate(now.getDate()-(day===0?6:day-1));
  const sun=new Date(mon);sun.setDate(mon.getDate()+6);
  const fmt=d=>d.toLocaleDateString('en-GB',{day:'numeric',month:'short'});
  return{mon,sun,label:fmt(mon)+' ‚Äì '+fmt(sun)+' '+sun.getFullYear()};
}
function getWeekDeals(){const{mon,sun}=getWeekRange();return S.deals.filter(d=>{try{const t=new Date(d.date+'T12:00:00');return t>=mon&&t<=sun;}catch(e){return false;}});}
function getWeekIntel(){const{mon,sun}=getWeekRange();return S.intel.filter(d=>{try{const t=new Date(d.date+'T12:00:00');return t>=mon&&t<=sun;}catch(e){return false;}});}

function renderWeekly(){
  const{label}=getWeekRange();
  const wD=getWeekDeals(),wI=getWeekIntel();
  const wc=document.getElementById('weeklyContent');
  if(S.weekly&&S.weekly.headline){
    wc.innerHTML=`<div class="week-hdr">
      <div class="week-range">${esc(S.weekly.range||label)}</div>
      <div class="week-headline">${esc(S.weekly.headline)}</div>
      <div class="week-summary">${esc(S.weekly.summary||'')}</div>
      ${(S.weekly.themes||[]).length?`<div class="pill-row">${S.weekly.themes.map(t=>`<div class="pill">${esc(t)}</div>`).join('')}</div>`:''}
    </div>
    ${S.weekly.deals_insight?`<div class="card"><div class="sh-sm">Deals Analysis</div><p style="font-size:14px;line-height:1.8">${esc(S.weekly.deals_insight)}</p></div>`:''}
    ${S.weekly.data_insight?`<div class="card"><div class="sh-sm">Market Data Analysis</div><p style="font-size:14px;line-height:1.8">${esc(S.weekly.data_insight)}</p></div>`:''}
    ${S.weekly.implications?`<div class="card card-gold"><div class="sh-sm">Investment Implications for Conduit</div><p style="font-size:14px;line-height:1.8">${esc(S.weekly.implications)}</p></div>`:''}
    ${S.weekly.outlook?`<div class="card"><div class="sh-sm">Watch List ‚Äî Next Week</div><p style="font-size:14px;line-height:1.8;white-space:pre-line">${esc(S.weekly.outlook)}</p></div>`:''}
    <p style="font-size:11px;color:var(--mid);margin-top:8px">Generated: ${esc(S.weekly.generatedAt||'')}</p>`;
  } else {
    wc.innerHTML=`<div class="card" style="text-align:center;padding:44px">
      <p style="font-family:'Cormorant Garamond',serif;font-size:22px;color:var(--mid);margin-bottom:10px">Week of ${esc(label)}</p>
      <p style="font-size:14px;color:var(--mid);margin-bottom:18px">${wD.length} deals and ${wI.length} data points logged this week.</p>
      <button class="btn bn" onclick="generateWeekly()">‚ú® Generate This Week's Brief</button></div>`;
  }
  document.getElementById('weekDealBody').innerHTML=wD.length?wD.map(d=>`<tr>
    <td style="font-size:11px;white-space:nowrap">${esc(d.date||'')}</td>
    <td style="font-weight:700;color:var(--navy)">${esc(d.property||'')}</td>
    <td>${esc(d.location||'')}</td><td>${esc(d.sector||'')}</td>
    <td style="text-align:right;font-weight:700">${esc(d.price||'')}</td>
    <td>${sbadge(d.status)}</td></tr>`).join(''):'<tr><td colspan="6" class="es">No deals this week yet.</td></tr>';
  document.getElementById('weekIntelBody').innerHTML=wI.length?wI.map(i=>`<tr>
    <td style="font-weight:700;color:var(--navy)">${esc(i.area||'')}</td>
    <td>${esc(i.metric||'')}</td><td style="font-weight:700">${esc(i.value||'')}</td>
    <td style="font-size:16px;text-align:center">${tArrow(i.trend||'')}</td>
    <td>${priBadge(i.priority)}</td></tr>`).join(''):'<tr><td colspan="5" class="es">No data this week yet.</td></tr>';
}

async function generateWeekly(){
  const wD=getWeekDeals(),wI=getWeekIntel();
  const useD=wD.length>=2?wD:S.deals.slice(-20);
  const useI=wI.length>=3?wI:S.intel.slice(-30);
  if(!useD.length&&!useI.length){toast('Paste more articles first','err');return;}
  toast('Generating weekly brief‚Ä¶','ok');
  const{label}=getWeekRange();
  const prompt=`Weekly IC brief for Conduit Investors (¬£90-95M Belgrove House raise, King's Cross life sciences).

RULES: Structural divergence not bifurcation. Stabilised yield-on-cost not NIY. Seller psychology signals = dislocation evidence (open-ended redemptions, German Spezialfonds, REIT sales, refinance walls). Life sciences occupier = selective slowdown not frozen. Capital market illiquidity = commodity lab investment only. 18-36 month window. Secondary = duration mismatch.

Week: \${label} | Deals: \${JSON.stringify(useD)} | Data: \${JSON.stringify(useI)}

JSON only: {"range":"\${label}","headline":"capital signal: dislocation or recovery?","summary":"3-4 sentences: what happened, cycle signal, Belgrove raise implication","themes":["3-4 labels"],"deals_insight":"2-3 paras: conviction vs forced sellers, yield-on-cost vs NIY, optionality signals","data_insight":"2-3 paras: structural divergence evidence, occupier vs capital market dynamics","implications":"2-3 paras: Belgrove House raise angle, LP conversation points, dislocation window argument","outlook":"‚Ä¢ 3-4 leading indicators as thesis confirmers/invalidators"}`;
  try{
    const raw=await callClaude(prompt);const p=parseJSON(raw);
    Object.assign(S.weekly,p,{generatedAt:new Date().toLocaleString('en-GB')});
    saveState();renderWeekly();renderDash();toast('Weekly brief generated ‚úì','ok');
  }catch(err){toast(apiErrMsg(err),'err');console.error(err);}
}

function copyWeekly(){
  if(!S.weekly.headline){toast('Generate a brief first','err');return;}
  const w=S.weekly;
  navigator.clipboard.writeText(`CONDUIT INVESTORS ‚Äî WEEKLY BRIEF\n${w.range}\n\n${w.headline}\n\nSUMMARY\n${w.summary}\n\nDEALS ANALYSIS\n${w.deals_insight}\n\nMARKET DATA\n${w.data_insight}\n\nINVESTMENT IMPLICATIONS\n${w.implications}\n\nWATCH LIST\n${w.outlook}`).then(()=>toast('Copied ‚úì','ok'));
}
function clearWeekly(){if(!confirm('Clear weekly brief?'))return;Object.assign(S.weekly,DEFAULTS.weekly);saveState();renderWeekly();renderDash();toast('Cleared');}

// ‚ïê‚ïê COMPARABLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function runComps(){
  const kw=(document.getElementById('cf-kw')?.value||'').toLowerCase();
  const sec=(document.getElementById('cf-sec')?.value||'').toLowerCase();
  const pmin=parseFloat(document.getElementById('cf-pmin')?.value)||0;
  const pmax=parseFloat(document.getElementById('cf-pmax')?.value)||Infinity;
  const st=(document.getElementById('cf-st')?.value||'').toLowerCase();
  const d1=document.getElementById('cf-d1')?.value||'';

  const results=S.deals.filter(d=>{
    const text=JSON.stringify(d).toLowerCase();
    if(kw&&!text.includes(kw))return false;
    if(sec&&!(d.sector||'').toLowerCase().includes(sec))return false;
    const p=parseFloat(d.price)||0;
    if(pmin&&p&&p<pmin)return false;
    if(pmax!==Infinity&&p&&p>pmax)return false;
    if(st&&!(d.status||'').toLowerCase().includes(st))return false;
    if(d1&&d.date&&d.date<d1)return false;
    return true;
  }).sort((a,b)=>(b.date||'').localeCompare(a.date||''));

  const cc=document.getElementById('compCount');
  if(cc)cc.textContent=results.length+' deal'+(results.length!==1?'s':'')+' match'+(results.length===1?'es':'');

  const el=document.getElementById('compResults');
  if(!el)return;
  if(!S.deals.length){el.innerHTML='<div class="card" style="text-align:center;padding:40px"><p class="dnil">No deals yet. Paste articles to build your deal database.</p></div>';return;}
  if(!results.length){el.innerHTML='<div class="card" style="text-align:center;padding:40px"><p class="dnil">No deals match your filters. Try widening the search.</p></div>';return;}

  el.innerHTML=results.map((d,i)=>{
    const matchScore=kw?'match-hi':sec||pmin||pmax!==Infinity?'match-med':'match-lo';
    return `<div class="comp-result ${matchScore}">
      <div class="comp-prop">${esc(d.property||'')}</div>
      <div class="comp-meta">${[d.date,d.location,d.sector].filter(Boolean).map(esc).join(' ¬∑ ')}</div>
      <div style="display:flex;flex-wrap:wrap;gap:20px;margin-bottom:10px;font-size:13px">
        ${d.price?`<span><strong style="font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--navy3)">¬£${esc(d.price)}M</strong></span>`:''}
        ${d.yield?`<span>Yield: <strong>${esc(d.yield)}</strong></span>`:''}
        ${d.buyer?`<span>Buyer: <strong>${esc(d.buyer)}</strong></span>`:''}
        ${d.seller?`<span>Vendor: <strong>${esc(d.seller)}</strong></span>`:''}
      </div>
      <div class="comp-tags">
        ${d.status?sbadge(d.status):''}
        ${d.relevance?`<span style="font-size:12px;color:var(--mid);font-style:italic;margin-left:4px">üí° ${esc(d.relevance)}</span>`:''}
      </div>
    </div>`;
  }).join('');
}

function clearCompFilters(){
  ['cf-kw','cf-pmin','cf-pmax'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  ['cf-sec','cf-st'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  const d=document.getElementById('cf-d1');if(d)d.value='';
  runComps();
}

async function generateCompSummary(){
  const kw=(document.getElementById('cf-kw')?.value||'').toLowerCase();
  const sec=(document.getElementById('cf-sec')?.value||'').toLowerCase();
  const results=S.deals.filter(d=>{
    const text=JSON.stringify(d).toLowerCase();
    if(kw&&!text.includes(kw))return false;
    if(sec&&!(d.sector||'').toLowerCase().includes(sec))return false;
    return true;
  });
  if(!results.length){toast('No matching deals to summarise','err');return;}
  toast('Generating comp summary‚Ä¶','ok');
  const prompt=`London CRE analyst at Conduit Investors. Briefly analyse these comparable deals in 2-3 sentences: pricing levels, yield range, buyer types, and what they imply for current market pricing. Be specific with numbers.

Deals: ${JSON.stringify(results.slice(0,20))}

Respond with ONLY a JSON object: {"summary": "your analysis here"}`;
  try{
    const raw=await callClaude(prompt);const p=parseJSON(raw);
    const el=document.getElementById('compAISummary');
    if(el&&p.summary)el.innerHTML=`<div class="card card-gold" style="margin-bottom:16px"><div class="sh-sm">AI Comp Analysis</div><p style="font-size:14px;line-height:1.8">${esc(p.summary)}</p></div>`;
    toast('Summary generated ‚úì','ok');
  }catch(err){toast(apiErrMsg(err),'err');}
}

// ‚ïê‚ïê SCORECARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const MARKETS=['King\'s Cross','Mayfair','City of London','Canary Wharf','Oxford','Cambridge'];

function renderScorecard(){
  const sg=document.getElementById('scoreGrid');
  if(!sg)return;
  if(!S.intel.length){
    sg.innerHTML='<div class="card" style="grid-column:1/-1;text-align:center;padding:44px"><p class="dnil">No market data yet. Paste articles to build the scorecard automatically.</p></div>';
    return;
  }
  sg.innerHTML=MARKETS.map(mkt=>{
    // Pull intel relevant to this market
    const rel=S.intel.filter(i=>(i.area||'').toLowerCase().includes(mkt.toLowerCase().split(' ')[0]));
    const highCount=rel.filter(i=>i.priority==='High').length;
    const upCount=rel.filter(i=>tArrow(i.trend||'')==='\u2191').length;
    const downCount=rel.filter(i=>tArrow(i.trend||'')==='\u2193').length;
    const score=rel.length?Math.min(100,Math.round((highCount*3+upCount*2-downCount*1+rel.length*0.5)/Math.max(1,rel.length)*25)):null;
    const scoreClass=score===null?'fill-lo':score>=60?'fill-hi':score>=35?'fill-med':'fill-lo';
    const saved=S.scorecard&&S.scorecard[mkt]||{};
    // Find most recent figures
    const rents=rel.filter(i=>/rent/i.test(i.type||i.metric||''));
    const vac=rel.filter(i=>/vacanc/i.test(i.type||i.metric||''));
    const lastRent=rents.length?rents[rents.length-1]:{};
    const lastVac=vac.length?vac[vac.length-1]:{};
    return `<div class="score-card">
      <div class="score-head"><div class="score-market">${esc(mkt)}</div><div class="score-tag">${rel.length} data point${rel.length!==1?'s':''} logged</div></div>
      <div class="score-body">
        ${lastRent.value?`<div class="score-row"><span class="score-metric">Prime Rent</span><span class="score-val">${esc(lastRent.value)}</span></div>`:''}
        ${lastVac.value?`<div class="score-row"><span class="score-metric">Vacancy</span><span class="score-val">${esc(lastVac.value)}</span></div>`:''}
        <div class="score-row"><span class="score-metric">Rising Signals</span><span class="score-val" style="color:var(--green)">${upCount}‚Üë</span></div>
        <div class="score-row"><span class="score-metric">Falling Signals</span><span class="score-val" style="color:var(--red)">${downCount}‚Üì</span></div>
        ${saved.note?`<div style="font-size:12px;color:var(--mid);font-style:italic;margin-top:8px;padding-top:8px;border-top:1px solid var(--rule)">${esc(saved.note)}</div>`:''}
        <div class="score-bar-wrap">
          <div class="score-overall-label">Activity Score</div>
          ${score!==null?`<div class="score-bar"><div class="score-bar-fill ${scoreClass}" style="width:${score}%"></div></div><div class="score-pct">${score}</div>`:'<p class="dnil" style="font-size:13px">Not enough data</p>'}
        </div>
      </div>
    </div>`;
  }).join('');
}

async function generateScorecard(){
  if(!S.intel.length){toast('Paste articles first','err');return;}
  toast('Generating AI scorecard‚Ä¶','ok');
  const prompt=`Senior London CRE analyst at Conduit Investors. Analyse this market intelligence and score each submarket.

Market Data: ${JSON.stringify(S.intel.slice(-50))}

For each of these markets: King's Cross, Mayfair, City of London, Canary Wharf, Oxford, Cambridge ‚Äî write a one-sentence insight.

Respond ONLY with JSON:
{"notes":{"King's Cross":"one sentence insight","Mayfair":"one sentence insight","City of London":"one sentence insight","Canary Wharf":"one sentence insight","Oxford":"one sentence insight","Cambridge":"one sentence insight"},"overall":"2-3 sentences on where the strongest opportunities lie across these markets based on the data"}`;
  try{
    const raw=await callClaude(prompt);const p=parseJSON(raw);
    if(p.notes){Object.keys(p.notes).forEach(k=>{if(!S.scorecard[k])S.scorecard[k]={};S.scorecard[k].note=p.notes[k];});}
    saveState();renderScorecard();
    const el=document.getElementById('scoreAIInsight');
    if(el&&p.overall)el.innerHTML=`<div class="card card-gold"><div class="sh-sm">Overall Market Assessment</div><p style="font-size:14px;line-height:1.8">${esc(p.overall)}</p></div>`;
    toast('Scorecard refreshed ‚úì','ok');
  }catch(err){toast(apiErrMsg(err),'err');console.error(err);}
}

// ‚ïê‚ïê EXTRACTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runExtraction(){
  const text=document.getElementById('artText').value.trim();
  const dateV=document.getElementById('artDate').value||todayISO();
  const title=document.getElementById('artTitle').value.trim();
  if(!text){toast('Paste article text first','err');return;}
  const btn=document.getElementById('extBtn');
  const xs=document.getElementById('xstat');
  const xmsg=document.getElementById('xmsg');
  const xspin=document.getElementById('xspin');
  btn.disabled=true;xs.className='xstat on load';xspin.style.display='';
  xmsg.textContent='Reading article and extracting intelligence‚Ä¶';
  document.getElementById('extPreview').innerHTML='';

  const prompt=`London CRE analyst at Conduit Investors. Extract ALL deals and data from this Property Week article. Respond ONLY with JSON.

Article date: ${dateV}
Article:
${text}

{"article_headline":"headline or short title","deals":[{"date":"${dateV}","property":"","location":"","sector":"office/life sciences/retail/industrial/residential/mixed-use","buyer":"","seller":"","price":"millions as number only","yield":"e.g. 5.2%","status":"Completed/Under Offer/Pre-Let/Development/Planning/Rumoured","relevance":"why this matters for London CRE investment"}],"intel":[{"date":"${dateV}","area":"","type":"Prime Rent/Vacancy Rate/Investment Volume/Yield/Take-Up/Pipeline/Other","metric":"what was measured","value":"figure with units","trend":"up/down/flat","source":"Property Week","relevance":"why this matters","priority":"High/Medium/Low"}],"digest":{"headline":"most important signal in one sentence","summary":"2-3 sentences for a senior investor","story":"top story then 3 bullet points","deals_text":"brief paragraph on transactions","watch_points":"3 bullet points starting with ‚Ä¢"}}

Rules: include EVERY transaction and EVERY statistic. Empty arrays if none. Empty string not null.`;

  try{
    const rawText=await callClaude(prompt);
    const parsed=parseJSON(rawText);
    let nd=0,ni=0;
    if(Array.isArray(parsed.deals)){const v=parsed.deals.filter(d=>d&&(d.property||'').trim());S.deals.push(...v);nd=v.length;}
    if(Array.isArray(parsed.intel)){const v=parsed.intel.filter(i=>i&&(i.metric||i.value));S.intel.push(...v);ni=v.length;}
    const ah=(title||(parsed.article_headline||'').trim()||'Article '+fmtDate(dateV));
    S.articles.push({date:dateV,headline:ah,deals:nd,intel:ni,processedAt:new Date().toISOString()});
    const dg=parsed.digest||{};
    S.digest.date=fmtDate(dateV);
    if(dg.headline)S.digest.headline=dg.headline;if(dg.summary)S.digest.summary=dg.summary;
    if(dg.story)S.digest.story=dg.story;if(dg.deals_text)S.digest.deals=dg.deals_text;
    if(dg.watch_points)S.digest.watch=dg.watch_points;
    saveState();showPreview(parsed,nd,ni);updateCounts();renderArtLog();
    document.getElementById('artTitle').value='';
    xs.className='xstat on good';xspin.style.display='none';
    xmsg.innerHTML=`<strong>‚úì Done.</strong> &nbsp;Added <strong>${nd}</strong> deal${nd!==1?'s':''} and <strong>${ni}</strong> data point${ni!==1?'s':''}.`;
    toast(`‚úì ${nd} deals ¬∑ ${ni} data points`,'ok');
  }catch(err){
    xs.className='xstat on bad';xspin.style.display='none';
    xmsg.textContent=apiErrMsg(err);toast('Extraction failed','err');console.error(err);
  }
  btn.disabled=false;
}

function showPreview(parsed,nd,ni){
  const el=document.getElementById('extPreview');
  if(!nd&&!ni){el.innerHTML='';return;}
  let h='<div class="rp">';
  h+=`<p style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:14px">‚úì Extraction Complete</p>`;
  if(parsed.digest&&parsed.digest.headline)h+=`<div style="background:var(--white);border-radius:7px;padding:12px 16px;margin-bottom:14px;border-left:3px solid var(--gold)"><p style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:4px">Headline</p><p style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--navy3)">${esc(parsed.digest.headline)}</p></div>`;
  if(nd){h+=`<p style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:8px">üè¢ ${nd} deal${nd!==1?'s':''} added</p>`;parsed.deals.filter(d=>d&&d.property).forEach(d=>{h+=`<div class="rp-row"><strong style="color:var(--navy)">${esc(d.property)}</strong>${d.location?' ‚Äî '+esc(d.location):''}${d.price?' ¬∑ <strong>¬£'+esc(d.price)+'M</strong>':''}${d.yield?' ¬∑ '+esc(d.yield):''}${d.status?' '+sbadge(d.status):''}${d.relevance?'<br><span style="font-size:11px;color:var(--mid);font-style:italic">üí° '+esc(d.relevance)+'</span>':''}</div>`;});}
  if(ni){h+=`<p style="font-size:13px;font-weight:700;color:var(--navy);margin:12px 0 8px">üîç ${ni} data point${ni!==1?'s':''} added</p>`;parsed.intel.filter(i=>i&&(i.metric||i.value)).forEach(i=>{h+=`<div class="rp-row"><strong>${esc(i.area||'')}</strong>${i.type?' ‚Äî '+esc(i.type):''}: ${esc(i.metric||'')} <strong style="color:var(--navy)">${esc(i.value||'')}</strong> ${tArrow(i.trend||'')} ${priBadge(i.priority)}${i.relevance?'<br><span style="font-size:11px;color:var(--mid);font-style:italic">üí° '+esc(i.relevance)+'</span>':''}</div>`;});}
  h+=`<div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn bn bsm" onclick="go('weekly')">View Weekly ‚Üí</button><button class="btn bo bsm" onclick="go('deals')">Deals ‚Üí</button><button class="btn bo bsm" onclick="go('digest')">Digest ‚Üí</button></div></div>`;
  el.innerHTML=h;
}

// ‚ïê‚ïê ARTICLE LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderArtLog(){
  const el=document.getElementById('artLog');if(!el)return;
  if(!S.articles.length){el.innerHTML='<p class="dnil">No articles processed yet.</p>';return;}
  const sorted=[...S.articles].reverse();
  el.innerHTML=sorted.map((a,i)=>`<div class="art-log-item">
    <div><div class="art-log-title">${esc(a.headline||'Untitled')}</div>
      <div class="art-log-meta">${esc(fmtDate(a.date))} ¬∑ ${a.deals||0} deals ¬∑ ${a.intel||0} data points</div></div>
    <button class="btn br_ bsm" onclick="deleteArt(${S.articles.length-1-i})">Remove</button></div>`).join('');
}
function deleteArt(i){if(!confirm('Remove from log? Data remains.'))return;S.articles.splice(i,1);saveState();renderArtLog();updateCounts();toast('Removed');}

// ‚ïê‚ïê DEALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDeals(){
  const q=(document.getElementById('dealSearch')?.value||'').toLowerCase();
  const fl=q?S.deals.filter(d=>JSON.stringify(d).toLowerCase().includes(q)):S.deals;
  setText('dealCount',S.deals.length+' total ¬∑ '+fl.length+' shown');
  const tb=document.getElementById('dealBody');if(!tb)return;
  if(!fl.length){tb.innerHTML=`<tr><td colspan="11" class="es">${q?'No matches.':'No deals yet.'}</td></tr>`;return;}
  tb.innerHTML=fl.map(d=>{const ri=S.deals.indexOf(d);return`<tr>
    <td style="font-size:11px;white-space:nowrap">${esc(d.date||'')}</td>
    <td style="font-weight:700;color:var(--navy)">${esc(d.property||'')}</td>
    <td>${esc(d.location||'')}</td><td>${esc(d.sector||'')}</td>
    <td>${esc(d.buyer||'')}</td><td>${esc(d.seller||'')}</td>
    <td style="text-align:right;font-weight:700">${esc(d.price||'')}</td>
    <td>${esc(d.yield||'')}</td><td>${sbadge(d.status)}</td>
    <td style="font-size:11px;color:var(--mid);font-style:italic">${esc(d.relevance||'')}</td>
    <td><button class="btn br_" style="padding:5px 10px;font-size:11px" onclick="delDeal(${ri})">‚úï</button></td></tr>`;}).join('');
}
function sbadge(s){if(!s)return'';const c=/complet|sold/i.test(s)?'bg2':/exchang|offer/i.test(s)?'ba2':/plan|dev/i.test(s)?'br2':'bb2';return`<span class="badge ${c}">${esc(s)}</span>`;}
function delDeal(i){if(!confirm('Remove?'))return;S.deals.splice(i,1);saveState();renderDeals();updateCounts();toast('Removed');}
function clearDeals(){if(!confirm('Remove ALL deals?'))return;S.deals=[];saveState();renderDeals();updateCounts();toast('Cleared');}
function exportDeals(){const h=['Date','Property','Location','Sector','Buyer','Seller','Price ¬£M','Yield','Status','Why It Matters'];dlCSV('conduit_deals.csv',[h,...S.deals.map(d=>[d.date,d.property,d.location,d.sector,d.buyer,d.seller,d.price,d.yield,d.status,d.relevance].map(csvCell))]);}
function openAddDeal(){document.getElementById('nd_date').value=todayISO();['prop','loc','sec','buy','sel','pr','yi','st','rel'].forEach(f=>{const e=document.getElementById('nd_'+f);if(e)e.value='';});om('ovDeal');}
function saveDeal(){const d={date:v('nd_date'),property:v('nd_prop'),location:v('nd_loc'),sector:v('nd_sec'),buyer:v('nd_buy'),seller:v('nd_sel'),price:v('nd_pr'),yield:v('nd_yi'),status:v('nd_st'),relevance:v('nd_rel')};if(!d.property){toast('Property name required','err');return;}S.deals.push(d);saveState();cm('ovDeal');renderDeals();updateCounts();toast('Added ‚úì','ok');}

// ‚ïê‚ïê INTEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderIntel(){
  const q=(document.getElementById('intelSearch')?.value||'').toLowerCase();
  const fl=q?S.intel.filter(i=>JSON.stringify(i).toLowerCase().includes(q)):S.intel;
  setText('intelCount',S.intel.length+' total ¬∑ '+fl.length+' shown');
  const tb=document.getElementById('intelBody');if(!tb)return;
  if(!fl.length){tb.innerHTML=`<tr><td colspan="10" class="es">${q?'No matches.':'No market data yet.'}</td></tr>`;return;}
  tb.innerHTML=fl.map(i=>{const ri=S.intel.indexOf(i);return`<tr>
    <td style="font-size:11px;white-space:nowrap">${esc(i.date||'')}</td>
    <td style="font-weight:700;color:var(--navy)">${esc(i.area||'')}</td>
    <td>${esc(i.type||'')}</td><td>${esc(i.metric||'')}</td>
    <td style="font-weight:700;font-size:15px">${esc(i.value||'')}</td>
    <td style="font-size:16px;text-align:center">${tArrow(i.trend||'')}</td>
    <td style="font-size:11px;color:var(--mid)">${esc(i.source||'')}</td>
    <td style="font-size:11px;color:var(--mid);font-style:italic">${esc(i.relevance||'')}</td>
    <td>${priBadge(i.priority)}</td>
    <td><button class="btn br_" style="padding:5px 10px;font-size:11px" onclick="delIntel(${ri})">‚úï</button></td></tr>`;}).join('');
}
function priBadge(p){if(!p)return'';return`<span class="badge ${p==='High'?'bg2':p==='Medium'?'ba2':'bb2'}">${esc(p)}</span>`;}
function tArrow(t){const s=(t||'').toLowerCase();return s==='up'||s==='\u2191'?'\u2191':s==='down'||s==='\u2193'?'\u2193':s==='flat'||s==='\u2194'?'\u2194':t;}
function delIntel(i){if(!confirm('Remove?'))return;S.intel.splice(i,1);saveState();renderIntel();updateCounts();toast('Removed');}
function clearIntel(){if(!confirm('Remove ALL market data?'))return;S.intel=[];saveState();renderIntel();updateCounts();toast('Cleared');}
function exportIntel(){const h=['Date','Area','Type','Metric','Value','Trend','Source','Why It Matters','Priority'];dlCSV('conduit_market_data.csv',[h,...S.intel.map(i=>[i.date,i.area,i.type,i.metric,i.value,i.trend,i.source,i.relevance,i.priority].map(csvCell))]);}
function openAddIntel(){document.getElementById('ni_date').value=todayISO();document.getElementById('ni_src').value='Property Week';['area','type','met','val','rel'].forEach(f=>{const e=document.getElementById('ni_'+f);if(e)e.value='';});om('ovIntel');}
function saveIntel(){S.intel.push({date:v('ni_date'),area:v('ni_area'),type:v('ni_type'),metric:v('ni_met'),value:v('ni_val'),trend:v('ni_tr'),source:v('ni_src'),relevance:v('ni_rel'),priority:v('ni_pri')});saveState();cm('ovIntel');renderIntel();updateCounts();toast('Added ‚úì','ok');}

// ‚ïê‚ïê KPI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openKpiModal(){document.getElementById('kpiFields').innerHTML=S.kpis.map((k,i)=>`<div class="fg"><label class="fl">${esc(k.label)}</label><input type="text" id="kpi_${i}" value="${esc(k.value)}" placeholder="e.g. ¬£78 psf"></div>`).join('');om('ovKpi');}
function saveKpi(){S.kpis.forEach((k,i)=>{const e=document.getElementById('kpi_'+i);if(e)k.value=e.value;});saveState();cm('ovKpi');renderDash();toast('Updated ‚úì','ok');}

// ‚ïê‚ïê DIGEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDigest(){
  setText('dDate',S.digest.date);setText('dHead',S.digest.headline);setText('dSum',S.digest.summary);setText('dStory',S.digest.story);setText('dDeals',S.digest.deals);setText('dWatch',S.digest.watch);
  if(!S.digest.headline)['dHead','dSum','dStory','dDeals','dWatch'].forEach(id=>{const e=document.getElementById(id);if(e&&!e.textContent.trim())e.innerHTML='<span class="dnil">Paste an article to populate automatically.</span>';});
}
async function regenDigest(){
  if(!S.deals.length&&!S.intel.length){toast('Paste articles first','err');return;}
  toast('Generating‚Ä¶','ok');
  const prompt=`Daily IC digest for Conduit Investors. One page. Answer: what does this mean for our capital?

Deals: \${JSON.stringify(S.deals.slice(-10))} | Data: \${JSON.stringify(S.intel.slice(-20))}

JSON only: {"date":"\${fmtDate(todayISO())}","headline":"capital signal today","summary":"2-3 sentences: cycle phase, risk asymmetry, ¬£90-95M raise implication","story":"top story: conviction capital or forced seller? Dislocation signal? + 3 bullets","deals_text":"buyers/sellers, yield-on-cost vs NIY, optionality","watch_points":"‚Ä¢ 3 thesis confirmers/invalidators"}`;
  try{const raw=await callClaude(prompt);const p=parseJSON(raw);Object.assign(S.digest,{date:p.date||S.digest.date,headline:p.headline||'',summary:p.summary||'',story:p.story||'',deals:p.deals_text||'',watch:p.watch_points||''});saveState();renderDigest();toast('Regenerated ‚úì','ok');}
  catch(err){toast(apiErrMsg(err),'err');}
}
function copyDigest(){const d=S.digest;navigator.clipboard.writeText(`CONDUIT ‚Äî DAILY DIGEST\n${d.date}\n\nHEADLINE\n${d.headline}\n\nSUMMARY\n${d.summary}\n\nTOP STORY\n${d.story}\n\nDEALS\n${d.deals}\n\nWATCH LIST\n${d.watch}`).then(()=>toast('Copied ‚úì','ok'));}
function clearDigest(){if(!confirm('Clear?'))return;S.digest={date:'',headline:'',summary:'',story:'',deals:'',watch:''};saveState();renderDigest();toast('Cleared');}
['dDate','dHead','dSum','dStory','dDeals','dWatch'].forEach(id=>{const el=document.getElementById(id);const m={dDate:'date',dHead:'headline',dSum:'summary',dStory:'story',dDeals:'deals',dWatch:'watch'};if(el)el.addEventListener('input',()=>{S.digest[m[id]]=el.textContent;saveState();});});

// ‚ïê‚ïê NARRATIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNarr(){
  const n=S.narr,fm={nHead:'headline',nMacro:'macro',nSector:'sector',nDeals:'deals',nImpl:'impl',nOut:'out'};
  document.getElementById('nPeriod').textContent=new Date().toLocaleDateString('en-GB',{month:'long',year:'numeric'});
  Object.entries(fm).forEach(([id,k])=>setText(id,n[k]||''));
  // Always show current month for period
  setText('nPeriod', fmtMonth());
  if(!n.headline){['nHead','nMacro','nSector','nDeals','nImpl','nOut'].forEach(id=>{const e=document.getElementById(id);if(e)e.innerHTML='<span class="dnil">Click Generate above, or click here to type.</span>';});}
}
async function regenNarr(){
  if(!S.deals.length&&!S.intel.length){toast('Add deals or market data first','err');return;}
  const key = getKey();
  if(!key){openKeyModal();return;}

  // Clear stale period immediately
  S.narr.period = new Date().toLocaleDateString('en-GB',{month:'long',year:'numeric'});
  saveState(); renderNarr();
  const btn = document.querySelector('[onclick="regenNarr()"]');
  if(btn){btn.disabled=true;btn.textContent='Fetching live data‚Ä¶';}
  toast('Fetching live market data‚Ä¶','ok');

  const today = new Date();
  const periodStr = today.toLocaleDateString('en-GB',{month:'long',year:'numeric'});
  let liveContext = '';

  try {
    // Single web search call ‚Äî no extraction step
    const r1 = await fetch('https://api.anthropic.com/v1/messages',{
      method:'POST',
      headers:{'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body:JSON.stringify({
        model:'claude-haiku-4-5-20251001', max_tokens:1000,
        tools:[{type:'web_search_20250305',name:'web_search'}],
        messages:[{role:'user',content:'Latest London CRE data 2026: prime City office rents psf, London life sciences take-up sq ft, UK REIT NAV discounts, recent investment yields, BoE rate, gilt yield. List specific numbers only.'}]
      })
    });
    const d1 = await r1.json();
    if(r1.ok){
      liveContext = (d1.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('').slice(0,1500);
    }
  } catch(e){ console.warn('Live fetch skipped:', e); }

  if(btn) btn.textContent='Writing narrative‚Ä¶';
  toast('Writing narrative‚Ä¶','ok');

  const dealsSnap = JSON.stringify(S.deals.slice(-15));
  const intelSnap = JSON.stringify(S.intel.slice(-20));

  const prompt=`IC capital allocation memo. Conduit Investors. ${periodStr}.

RULES: Structural divergence not bifurcation. Yield-on-cost (5-5.5%) not NIY. Life sciences = selective slowdown not frozen (Golden Triangle +42% YoY 2025, 3.6m sqft pipeline). Capital market illiquidity = commodity lab investment only. 18-36 month window. Seller psychology: open-ended redemptions, German Spezialfonds, REIT balance-sheet repair, developer refinance walls. Overseas = conviction arbitrage. Secondary = duration mismatch.

LIVE DATA: ${liveContext||'use platform data only'}
DEALS: ${dealsSnap}
INDICATORS: ${intelSnap}

Only cite figures present in the data above. Use "circa" for estimates. Period is ${periodStr}.

JSON only: {"period":"${periodStr}","headline":"pricing regime signal, who wins","macro":"2-3 paras: cycle phase, seller psychology with specific fund types, overseas capital logic","sector":"2-3 paras: prime offices covered land play, life sciences selective slowdown with figures, secondary duration mismatch","deals":"2-3 paras: seller asymmetry, yield-on-cost vs NIY examples","impl":"2-3 paras: 18-36 month window, three-tier strategy","out":"3-4 specific leading indicators as thesis confirmers/invalidators"}`;

  try{
    const raw=await callClaude(prompt);
    const p=parseJSON(raw);
    S.narr.period=periodStr; // always force today's date, never trust AI for this
    S.narr.headline=p.headline||'';
    S.narr.macro=p.macro||'';
    S.narr.sector=p.sector||'';
    S.narr.deals=p.deals||'';
    S.narr.impl=p.impl||'';
    S.narr.out=p.out||'';
    saveState();renderNarr();
    toast('Narrative ready ‚úì','ok');
  }catch(err){
    toast(apiErrMsg(err),'err');
  }
  if(btn){btn.disabled=false;btn.textContent='‚ú® Generate Draft';}
}


async function generateWeekly(){
  const wD=getWeekDeals(),wI=getWeekIntel();
  const useD=wD.length>=2?wD:S.deals.slice(-20);
  const useI=wI.length>=3?wI:S.intel.slice(-30);
  if(!useD.length&&!useI.length){toast('Paste more articles first','err');return;}
  toast('Generating weekly brief‚Ä¶','ok');
  const{label}=getWeekRange();
  const prompt=`Weekly IC brief for Conduit Investors (¬£90-95M Belgrove House raise, King's Cross life sciences).

RULES: Structural divergence not bifurcation. Stabilised yield-on-cost not NIY. Seller psychology signals = dislocation evidence (open-ended redemptions, German Spezialfonds, REIT sales, refinance walls). Life sciences occupier = selective slowdown not frozen. Capital market illiquidity = commodity lab investment only. 18-36 month window. Secondary = duration mismatch.

Week: \${label} | Deals: \${JSON.stringify(useD)} | Data: \${JSON.stringify(useI)}

JSON only: {"range":"\${label}","headline":"capital signal: dislocation or recovery?","summary":"3-4 sentences: what happened, cycle signal, Belgrove raise implication","themes":["3-4 labels"],"deals_insight":"2-3 paras: conviction vs forced sellers, yield-on-cost vs NIY, optionality signals","data_insight":"2-3 paras: structural divergence evidence, occupier vs capital market dynamics","implications":"2-3 paras: Belgrove House raise angle, LP conversation points, dislocation window argument","outlook":"‚Ä¢ 3-4 leading indicators as thesis confirmers/invalidators"}`;
  try{
    const raw=await callClaude(prompt);const p=parseJSON(raw);
    Object.assign(S.weekly,p,{generatedAt:new Date().toLocaleString('en-GB')});
    saveState();renderWeekly();renderDash();toast('Weekly brief generated ‚úì','ok');
  }catch(err){toast(apiErrMsg(err),'err');console.error(err);}
}

function copyWeekly(){
  if(!S.weekly.headline){toast('Generate a brief first','err');return;}
  const w=S.weekly;
  navigator.clipboard.writeText(`CONDUIT INVESTORS ‚Äî WEEKLY BRIEF\n${w.range}\n\n${w.headline}\n\nSUMMARY\n${w.summary}\n\nDEALS ANALYSIS\n${w.deals_insight}\n\nMARKET DATA\n${w.data_insight}\n\nINVESTMENT IMPLICATIONS\n${w.implications}\n\nWATCH LIST\n${w.outlook}`).then(()=>toast('Copied ‚úì','ok'));
}
function clearWeekly(){if(!confirm('Clear weekly brief?'))return;Object.assign(S.weekly,DEFAULTS.weekly);saveState();renderWeekly();renderDash();toast('Cleared');}

// ‚ïê‚ïê COMPARABLES ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function runComps(){
  const kw=(document.getElementById('cf-kw')?.value||'').toLowerCase();
  const sec=(document.getElementById('cf-sec')?.value||'').toLowerCase();
  const pmin=parseFloat(document.getElementById('cf-pmin')?.value)||0;
  const pmax=parseFloat(document.getElementById('cf-pmax')?.value)||Infinity;
  const st=(document.getElementById('cf-st')?.value||'').toLowerCase();
  const d1=document.getElementById('cf-d1')?.value||'';

  const results=S.deals.filter(d=>{
    const text=JSON.stringify(d).toLowerCase();
    if(kw&&!text.includes(kw))return false;
    if(sec&&!(d.sector||'').toLowerCase().includes(sec))return false;
    const p=parseFloat(d.price)||0;
    if(pmin&&p&&p<pmin)return false;
    if(pmax!==Infinity&&p&&p>pmax)return false;
    if(st&&!(d.status||'').toLowerCase().includes(st))return false;
    if(d1&&d.date&&d.date<d1)return false;
    return true;
  }).sort((a,b)=>(b.date||'').localeCompare(a.date||''));

  const cc=document.getElementById('compCount');
  if(cc)cc.textContent=results.length+' deal'+(results.length!==1?'s':'')+' match'+(results.length===1?'es':'');

  const el=document.getElementById('compResults');
  if(!el)return;
  if(!S.deals.length){el.innerHTML='<div class="card" style="text-align:center;padding:40px"><p class="dnil">No deals yet. Paste articles to build your deal database.</p></div>';return;}
  if(!results.length){el.innerHTML='<div class="card" style="text-align:center;padding:40px"><p class="dnil">No deals match your filters. Try widening the search.</p></div>';return;}

  el.innerHTML=results.map((d,i)=>{
    const matchScore=kw?'match-hi':sec||pmin||pmax!==Infinity?'match-med':'match-lo';
    return `<div class="comp-result ${matchScore}">
      <div class="comp-prop">${esc(d.property||'')}</div>
      <div class="comp-meta">${[d.date,d.location,d.sector].filter(Boolean).map(esc).join(' ¬∑ ')}</div>
      <div style="display:flex;flex-wrap:wrap;gap:20px;margin-bottom:10px;font-size:13px">
        ${d.price?`<span><strong style="font-family:'Cormorant Garamond',serif;font-size:18px;color:var(--navy3)">¬£${esc(d.price)}M</strong></span>`:''}
        ${d.yield?`<span>Yield: <strong>${esc(d.yield)}</strong></span>`:''}
        ${d.buyer?`<span>Buyer: <strong>${esc(d.buyer)}</strong></span>`:''}
        ${d.seller?`<span>Vendor: <strong>${esc(d.seller)}</strong></span>`:''}
      </div>
      <div class="comp-tags">
        ${d.status?sbadge(d.status):''}
        ${d.relevance?`<span style="font-size:12px;color:var(--mid);font-style:italic;margin-left:4px">üí° ${esc(d.relevance)}</span>`:''}
      </div>
    </div>`;
  }).join('');
}

function clearCompFilters(){
  ['cf-kw','cf-pmin','cf-pmax'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  ['cf-sec','cf-st'].forEach(id=>{const e=document.getElementById(id);if(e)e.value='';});
  const d=document.getElementById('cf-d1');if(d)d.value='';
  runComps();
}

async function generateCompSummary(){
  const kw=(document.getElementById('cf-kw')?.value||'').toLowerCase();
  const sec=(document.getElementById('cf-sec')?.value||'').toLowerCase();
  const results=S.deals.filter(d=>{
    const text=JSON.stringify(d).toLowerCase();
    if(kw&&!text.includes(kw))return false;
    if(sec&&!(d.sector||'').toLowerCase().includes(sec))return false;
    return true;
  });
  if(!results.length){toast('No matching deals to summarise','err');return;}
  toast('Generating comp summary‚Ä¶','ok');
  const prompt=`London CRE analyst at Conduit Investors. Briefly analyse these comparable deals in 2-3 sentences: pricing levels, yield range, buyer types, and what they imply for current market pricing. Be specific with numbers.

Deals: ${JSON.stringify(results.slice(0,20))}

Respond with ONLY a JSON object: {"summary": "your analysis here"}`;
  try{
    const raw=await callClaude(prompt);const p=parseJSON(raw);
    const el=document.getElementById('compAISummary');
    if(el&&p.summary)el.innerHTML=`<div class="card card-gold" style="margin-bottom:16px"><div class="sh-sm">AI Comp Analysis</div><p style="font-size:14px;line-height:1.8">${esc(p.summary)}</p></div>`;
    toast('Summary generated ‚úì','ok');
  }catch(err){toast(apiErrMsg(err),'err');}
}

// ‚ïê‚ïê SCORECARD ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderScorecard(){
  const sg=document.getElementById('scoreGrid');
  if(!sg)return;
  if(!S.intel.length){
    sg.innerHTML='<div class="card" style="grid-column:1/-1;text-align:center;padding:44px"><p class="dnil">No market data yet. Paste articles to build the scorecard automatically.</p></div>';
    return;
  }
  sg.innerHTML=MARKETS.map(mkt=>{
    // Pull intel relevant to this market
    const rel=S.intel.filter(i=>(i.area||'').toLowerCase().includes(mkt.toLowerCase().split(' ')[0]));
    const highCount=rel.filter(i=>i.priority==='High').length;
    const upCount=rel.filter(i=>tArrow(i.trend||'')==='\u2191').length;
    const downCount=rel.filter(i=>tArrow(i.trend||'')==='\u2193').length;
    const score=rel.length?Math.min(100,Math.round((highCount*3+upCount*2-downCount*1+rel.length*0.5)/Math.max(1,rel.length)*25)):null;
    const scoreClass=score===null?'fill-lo':score>=60?'fill-hi':score>=35?'fill-med':'fill-lo';
    const saved=S.scorecard&&S.scorecard[mkt]||{};
    // Find most recent figures
    const rents=rel.filter(i=>/rent/i.test(i.type||i.metric||''));
    const vac=rel.filter(i=>/vacanc/i.test(i.type||i.metric||''));
    const lastRent=rents.length?rents[rents.length-1]:{};
    const lastVac=vac.length?vac[vac.length-1]:{};
    return `<div class="score-card">
      <div class="score-head"><div class="score-market">${esc(mkt)}</div><div class="score-tag">${rel.length} data point${rel.length!==1?'s':''} logged</div></div>
      <div class="score-body">
        ${lastRent.value?`<div class="score-row"><span class="score-metric">Prime Rent</span><span class="score-val">${esc(lastRent.value)}</span></div>`:''}
        ${lastVac.value?`<div class="score-row"><span class="score-metric">Vacancy</span><span class="score-val">${esc(lastVac.value)}</span></div>`:''}
        <div class="score-row"><span class="score-metric">Rising Signals</span><span class="score-val" style="color:var(--green)">${upCount}‚Üë</span></div>
        <div class="score-row"><span class="score-metric">Falling Signals</span><span class="score-val" style="color:var(--red)">${downCount}‚Üì</span></div>
        ${saved.note?`<div style="font-size:12px;color:var(--mid);font-style:italic;margin-top:8px;padding-top:8px;border-top:1px solid var(--rule)">${esc(saved.note)}</div>`:''}
        <div class="score-bar-wrap">
          <div class="score-overall-label">Activity Score</div>
          ${score!==null?`<div class="score-bar"><div class="score-bar-fill ${scoreClass}" style="width:${score}%"></div></div><div class="score-pct">${score}</div>`:'<p class="dnil" style="font-size:13px">Not enough data</p>'}
        </div>
      </div>
    </div>`;
  }).join('');
}

async function generateScorecard(){
  if(!S.intel.length){toast('Paste articles first','err');return;}
  toast('Generating AI scorecard‚Ä¶','ok');
  const prompt=`Senior London CRE analyst at Conduit Investors. Analyse this market intelligence and score each submarket.

Market Data: ${JSON.stringify(S.intel.slice(-50))}

For each of these markets: King's Cross, Mayfair, City of London, Canary Wharf, Oxford, Cambridge ‚Äî write a one-sentence insight.

Respond ONLY with JSON:
{"notes":{"King's Cross":"one sentence insight","Mayfair":"one sentence insight","City of London":"one sentence insight","Canary Wharf":"one sentence insight","Oxford":"one sentence insight","Cambridge":"one sentence insight"},"overall":"2-3 sentences on where the strongest opportunities lie across these markets based on the data"}`;
  try{
    const raw=await callClaude(prompt);const p=parseJSON(raw);
    if(p.notes){Object.keys(p.notes).forEach(k=>{if(!S.scorecard[k])S.scorecard[k]={};S.scorecard[k].note=p.notes[k];});}
    saveState();renderScorecard();
    const el=document.getElementById('scoreAIInsight');
    if(el&&p.overall)el.innerHTML=`<div class="card card-gold"><div class="sh-sm">Overall Market Assessment</div><p style="font-size:14px;line-height:1.8">${esc(p.overall)}</p></div>`;
    toast('Scorecard refreshed ‚úì','ok');
  }catch(err){toast(apiErrMsg(err),'err');console.error(err);}
}

// ‚ïê‚ïê EXTRACTION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function runExtraction(){
  const text=document.getElementById('artText').value.trim();
  const dateV=document.getElementById('artDate').value||todayISO();
  const title=document.getElementById('artTitle').value.trim();
  if(!text){toast('Paste article text first','err');return;}
  const btn=document.getElementById('extBtn');
  const xs=document.getElementById('xstat');
  const xmsg=document.getElementById('xmsg');
  const xspin=document.getElementById('xspin');
  btn.disabled=true;xs.className='xstat on load';xspin.style.display='';
  xmsg.textContent='Reading article and extracting intelligence‚Ä¶';
  document.getElementById('extPreview').innerHTML='';

  const prompt=`London CRE analyst at Conduit Investors. Extract ALL deals and data from this Property Week article. Respond ONLY with JSON.

Article date: ${dateV}
Article:
${text}

{"article_headline":"headline or short title","deals":[{"date":"${dateV}","property":"","location":"","sector":"office/life sciences/retail/industrial/residential/mixed-use","buyer":"","seller":"","price":"millions as number only","yield":"e.g. 5.2%","status":"Completed/Under Offer/Pre-Let/Development/Planning/Rumoured","relevance":"why this matters for London CRE investment"}],"intel":[{"date":"${dateV}","area":"","type":"Prime Rent/Vacancy Rate/Investment Volume/Yield/Take-Up/Pipeline/Other","metric":"what was measured","value":"figure with units","trend":"up/down/flat","source":"Property Week","relevance":"why this matters","priority":"High/Medium/Low"}],"digest":{"headline":"most important signal in one sentence","summary":"2-3 sentences for a senior investor","story":"top story then 3 bullet points","deals_text":"brief paragraph on transactions","watch_points":"3 bullet points starting with ‚Ä¢"}}

Rules: include EVERY transaction and EVERY statistic. Empty arrays if none. Empty string not null.`;

  try{
    const rawText=await callClaude(prompt);
    const parsed=parseJSON(rawText);
    let nd=0,ni=0;
    if(Array.isArray(parsed.deals)){const v=parsed.deals.filter(d=>d&&(d.property||'').trim());S.deals.push(...v);nd=v.length;}
    if(Array.isArray(parsed.intel)){const v=parsed.intel.filter(i=>i&&(i.metric||i.value));S.intel.push(...v);ni=v.length;}
    const ah=(title||(parsed.article_headline||'').trim()||'Article '+fmtDate(dateV));
    S.articles.push({date:dateV,headline:ah,deals:nd,intel:ni,processedAt:new Date().toISOString()});
    const dg=parsed.digest||{};
    S.digest.date=fmtDate(dateV);
    if(dg.headline)S.digest.headline=dg.headline;if(dg.summary)S.digest.summary=dg.summary;
    if(dg.story)S.digest.story=dg.story;if(dg.deals_text)S.digest.deals=dg.deals_text;
    if(dg.watch_points)S.digest.watch=dg.watch_points;
    saveState();showPreview(parsed,nd,ni);updateCounts();renderArtLog();
    document.getElementById('artTitle').value='';
    xs.className='xstat on good';xspin.style.display='none';
    xmsg.innerHTML=`<strong>‚úì Done.</strong> &nbsp;Added <strong>${nd}</strong> deal${nd!==1?'s':''} and <strong>${ni}</strong> data point${ni!==1?'s':''}.`;
    toast(`‚úì ${nd} deals ¬∑ ${ni} data points`,'ok');
  }catch(err){
    xs.className='xstat on bad';xspin.style.display='none';
    xmsg.textContent=apiErrMsg(err);toast('Extraction failed','err');console.error(err);
  }
  btn.disabled=false;
}

function showPreview(parsed,nd,ni){
  const el=document.getElementById('extPreview');
  if(!nd&&!ni){el.innerHTML='';return;}
  let h='<div class="rp">';
  h+=`<p style="font-size:16px;font-weight:700;color:var(--green);margin-bottom:14px">‚úì Extraction Complete</p>`;
  if(parsed.digest&&parsed.digest.headline)h+=`<div style="background:var(--white);border-radius:7px;padding:12px 16px;margin-bottom:14px;border-left:3px solid var(--gold)"><p style="font-size:10px;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--mid);margin-bottom:4px">Headline</p><p style="font-family:'Cormorant Garamond',serif;font-size:18px;font-weight:600;color:var(--navy3)">${esc(parsed.digest.headline)}</p></div>`;
  if(nd){h+=`<p style="font-size:13px;font-weight:700;color:var(--navy);margin-bottom:8px">üè¢ ${nd} deal${nd!==1?'s':''} added</p>`;parsed.deals.filter(d=>d&&d.property).forEach(d=>{h+=`<div class="rp-row"><strong style="color:var(--navy)">${esc(d.property)}</strong>${d.location?' ‚Äî '+esc(d.location):''}${d.price?' ¬∑ <strong>¬£'+esc(d.price)+'M</strong>':''}${d.yield?' ¬∑ '+esc(d.yield):''}${d.status?' '+sbadge(d.status):''}${d.relevance?'<br><span style="font-size:11px;color:var(--mid);font-style:italic">üí° '+esc(d.relevance)+'</span>':''}</div>`;});}
  if(ni){h+=`<p style="font-size:13px;font-weight:700;color:var(--navy);margin:12px 0 8px">üîç ${ni} data point${ni!==1?'s':''} added</p>`;parsed.intel.filter(i=>i&&(i.metric||i.value)).forEach(i=>{h+=`<div class="rp-row"><strong>${esc(i.area||'')}</strong>${i.type?' ‚Äî '+esc(i.type):''}: ${esc(i.metric||'')} <strong style="color:var(--navy)">${esc(i.value||'')}</strong> ${tArrow(i.trend||'')} ${priBadge(i.priority)}${i.relevance?'<br><span style="font-size:11px;color:var(--mid);font-style:italic">üí° '+esc(i.relevance)+'</span>':''}</div>`;});}
  h+=`<div style="margin-top:16px;display:flex;gap:8px;flex-wrap:wrap"><button class="btn bn bsm" onclick="go('weekly')">View Weekly ‚Üí</button><button class="btn bo bsm" onclick="go('deals')">Deals ‚Üí</button><button class="btn bo bsm" onclick="go('digest')">Digest ‚Üí</button></div></div>`;
  el.innerHTML=h;
}

// ‚ïê‚ïê ARTICLE LOG ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderArtLog(){
  const el=document.getElementById('artLog');if(!el)return;
  if(!S.articles.length){el.innerHTML='<p class="dnil">No articles processed yet.</p>';return;}
  const sorted=[...S.articles].reverse();
  el.innerHTML=sorted.map((a,i)=>`<div class="art-log-item">
    <div><div class="art-log-title">${esc(a.headline||'Untitled')}</div>
      <div class="art-log-meta">${esc(fmtDate(a.date))} ¬∑ ${a.deals||0} deals ¬∑ ${a.intel||0} data points</div></div>
    <button class="btn br_ bsm" onclick="deleteArt(${S.articles.length-1-i})">Remove</button></div>`).join('');
}
function deleteArt(i){if(!confirm('Remove from log? Data remains.'))return;S.articles.splice(i,1);saveState();renderArtLog();updateCounts();toast('Removed');}

// ‚ïê‚ïê DEALS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDeals(){
  const q=(document.getElementById('dealSearch')?.value||'').toLowerCase();
  const fl=q?S.deals.filter(d=>JSON.stringify(d).toLowerCase().includes(q)):S.deals;
  setText('dealCount',S.deals.length+' total ¬∑ '+fl.length+' shown');
  const tb=document.getElementById('dealBody');if(!tb)return;
  if(!fl.length){tb.innerHTML=`<tr><td colspan="11" class="es">${q?'No matches.':'No deals yet.'}</td></tr>`;return;}
  tb.innerHTML=fl.map(d=>{const ri=S.deals.indexOf(d);return`<tr>
    <td style="font-size:11px;white-space:nowrap">${esc(d.date||'')}</td>
    <td style="font-weight:700;color:var(--navy)">${esc(d.property||'')}</td>
    <td>${esc(d.location||'')}</td><td>${esc(d.sector||'')}</td>
    <td>${esc(d.buyer||'')}</td><td>${esc(d.seller||'')}</td>
    <td style="text-align:right;font-weight:700">${esc(d.price||'')}</td>
    <td>${esc(d.yield||'')}</td><td>${sbadge(d.status)}</td>
    <td style="font-size:11px;color:var(--mid);font-style:italic">${esc(d.relevance||'')}</td>
    <td><button class="btn br_" style="padding:5px 10px;font-size:11px" onclick="delDeal(${ri})">‚úï</button></td></tr>`;}).join('');
}
function sbadge(s){if(!s)return'';const c=/complet|sold/i.test(s)?'bg2':/exchang|offer/i.test(s)?'ba2':/plan|dev/i.test(s)?'br2':'bb2';return`<span class="badge ${c}">${esc(s)}</span>`;}
function delDeal(i){if(!confirm('Remove?'))return;S.deals.splice(i,1);saveState();renderDeals();updateCounts();toast('Removed');}
function clearDeals(){if(!confirm('Remove ALL deals?'))return;S.deals=[];saveState();renderDeals();updateCounts();toast('Cleared');}
function exportDeals(){const h=['Date','Property','Location','Sector','Buyer','Seller','Price ¬£M','Yield','Status','Why It Matters'];dlCSV('conduit_deals.csv',[h,...S.deals.map(d=>[d.date,d.property,d.location,d.sector,d.buyer,d.seller,d.price,d.yield,d.status,d.relevance].map(csvCell))]);}
function openAddDeal(){document.getElementById('nd_date').value=todayISO();['prop','loc','sec','buy','sel','pr','yi','st','rel'].forEach(f=>{const e=document.getElementById('nd_'+f);if(e)e.value='';});om('ovDeal');}
function saveDeal(){const d={date:v('nd_date'),property:v('nd_prop'),location:v('nd_loc'),sector:v('nd_sec'),buyer:v('nd_buy'),seller:v('nd_sel'),price:v('nd_pr'),yield:v('nd_yi'),status:v('nd_st'),relevance:v('nd_rel')};if(!d.property){toast('Property name required','err');return;}S.deals.push(d);saveState();cm('ovDeal');renderDeals();updateCounts();toast('Added ‚úì','ok');}

// ‚ïê‚ïê INTEL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderIntel(){
  const q=(document.getElementById('intelSearch')?.value||'').toLowerCase();
  const fl=q?S.intel.filter(i=>JSON.stringify(i).toLowerCase().includes(q)):S.intel;
  setText('intelCount',S.intel.length+' total ¬∑ '+fl.length+' shown');
  const tb=document.getElementById('intelBody');if(!tb)return;
  if(!fl.length){tb.innerHTML=`<tr><td colspan="10" class="es">${q?'No matches.':'No market data yet.'}</td></tr>`;return;}
  tb.innerHTML=fl.map(i=>{const ri=S.intel.indexOf(i);return`<tr>
    <td style="font-size:11px;white-space:nowrap">${esc(i.date||'')}</td>
    <td style="font-weight:700;color:var(--navy)">${esc(i.area||'')}</td>
    <td>${esc(i.type||'')}</td><td>${esc(i.metric||'')}</td>
    <td style="font-weight:700;font-size:15px">${esc(i.value||'')}</td>
    <td style="font-size:16px;text-align:center">${tArrow(i.trend||'')}</td>
    <td style="font-size:11px;color:var(--mid)">${esc(i.source||'')}</td>
    <td style="font-size:11px;color:var(--mid);font-style:italic">${esc(i.relevance||'')}</td>
    <td>${priBadge(i.priority)}</td>
    <td><button class="btn br_" style="padding:5px 10px;font-size:11px" onclick="delIntel(${ri})">‚úï</button></td></tr>`;}).join('');
}
function priBadge(p){if(!p)return'';return`<span class="badge ${p==='High'?'bg2':p==='Medium'?'ba2':'bb2'}">${esc(p)}</span>`;}
function tArrow(t){const s=(t||'').toLowerCase();return s==='up'||s==='\u2191'?'\u2191':s==='down'||s==='\u2193'?'\u2193':s==='flat'||s==='\u2194'?'\u2194':t;}
function delIntel(i){if(!confirm('Remove?'))return;S.intel.splice(i,1);saveState();renderIntel();updateCounts();toast('Removed');}
function clearIntel(){if(!confirm('Remove ALL market data?'))return;S.intel=[];saveState();renderIntel();updateCounts();toast('Cleared');}
function exportIntel(){const h=['Date','Area','Type','Metric','Value','Trend','Source','Why It Matters','Priority'];dlCSV('conduit_market_data.csv',[h,...S.intel.map(i=>[i.date,i.area,i.type,i.metric,i.value,i.trend,i.source,i.relevance,i.priority].map(csvCell))]);}
function openAddIntel(){document.getElementById('ni_date').value=todayISO();document.getElementById('ni_src').value='Property Week';['area','type','met','val','rel'].forEach(f=>{const e=document.getElementById('ni_'+f);if(e)e.value='';});om('ovIntel');}
function saveIntel(){S.intel.push({date:v('ni_date'),area:v('ni_area'),type:v('ni_type'),metric:v('ni_met'),value:v('ni_val'),trend:v('ni_tr'),source:v('ni_src'),relevance:v('ni_rel'),priority:v('ni_pri')});saveState();cm('ovIntel');renderIntel();updateCounts();toast('Added ‚úì','ok');}

// ‚ïê‚ïê KPI ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openKpiModal(){document.getElementById('kpiFields').innerHTML=S.kpis.map((k,i)=>`<div class="fg"><label class="fl">${esc(k.label)}</label><input type="text" id="kpi_${i}" value="${esc(k.value)}" placeholder="e.g. ¬£78 psf"></div>`).join('');om('ovKpi');}
function saveKpi(){S.kpis.forEach((k,i)=>{const e=document.getElementById('kpi_'+i);if(e)k.value=e.value;});saveState();cm('ovKpi');renderDash();toast('Updated ‚úì','ok');}

// ‚ïê‚ïê DIGEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderDigest(){
  setText('dDate',S.digest.date);setText('dHead',S.digest.headline);setText('dSum',S.digest.summary);setText('dStory',S.digest.story);setText('dDeals',S.digest.deals);setText('dWatch',S.digest.watch);
  if(!S.digest.headline)['dHead','dSum','dStory','dDeals','dWatch'].forEach(id=>{const e=document.getElementById(id);if(e&&!e.textContent.trim())e.innerHTML='<span class="dnil">Paste an article to populate automatically.</span>';});
}
async function regenDigest(){
  if(!S.deals.length&&!S.intel.length){toast('Paste articles first','err');return;}
  toast('Generating‚Ä¶','ok');
  const prompt=`Daily IC digest for Conduit Investors. One page. Answer: what does this mean for our capital?

Deals: \${JSON.stringify(S.deals.slice(-10))} | Data: \${JSON.stringify(S.intel.slice(-20))}

JSON only: {"date":"\${fmtDate(todayISO())}","headline":"capital signal today","summary":"2-3 sentences: cycle phase, risk asymmetry, ¬£90-95M raise implication","story":"top story: conviction capital or forced seller? Dislocation signal? + 3 bullets","deals_text":"buyers/sellers, yield-on-cost vs NIY, optionality","watch_points":"‚Ä¢ 3 thesis confirmers/invalidators"}`;
  try{const raw=await callClaude(prompt);const p=parseJSON(raw);Object.assign(S.digest,{date:p.date||S.digest.date,headline:p.headline||'',summary:p.summary||'',story:p.story||'',deals:p.deals_text||'',watch:p.watch_points||''});saveState();renderDigest();toast('Regenerated ‚úì','ok');}
  catch(err){toast(apiErrMsg(err),'err');}
}
function copyDigest(){const d=S.digest;navigator.clipboard.writeText(`CONDUIT ‚Äî DAILY DIGEST\n${d.date}\n\nHEADLINE\n${d.headline}\n\nSUMMARY\n${d.summary}\n\nTOP STORY\n${d.story}\n\nDEALS\n${d.deals}\n\nWATCH LIST\n${d.watch}`).then(()=>toast('Copied ‚úì','ok'));}
function clearDigest(){if(!confirm('Clear?'))return;S.digest={date:'',headline:'',summary:'',story:'',deals:'',watch:''};saveState();renderDigest();toast('Cleared');}
['dDate','dHead','dSum','dStory','dDeals','dWatch'].forEach(id=>{const el=document.getElementById(id);const m={dDate:'date',dHead:'headline',dSum:'summary',dStory:'story',dDeals:'deals',dWatch:'watch'};if(el)el.addEventListener('input',()=>{S.digest[m[id]]=el.textContent;saveState();});});

// ‚ïê‚ïê NARRATIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNarr(){
  const n=S.narr,fm={nHead:'headline',nMacro:'macro',nSector:'sector',nDeals:'deals',nImpl:'impl',nOut:'out'};
  document.getElementById('nPeriod').textContent=new Date().toLocaleDateString('en-GB',{month:'long',year:'numeric'});
  Object.entries(fm).forEach(([id,k])=>setText(id,n[k]||''));
  if(!n.headline){setText('nPeriod',fmtMonth());['nHead','nMacro','nSector','nDeals','nImpl','nOut'].forEach(id=>{const e=document.getElementById(id);if(e)e.innerHTML='<span class="dnil">Click Generate above, or click here to type.</span>';});}
}
async function regenNarr(){
  if(!S.deals.length&&!S.intel.length){toast('Paste articles first','err');return;}
  toast('Generating draft‚Ä¶','ok');
  const prompt=`IC-level capital allocation memo for London CRE. Conduit Investors monthly narrative.

RULES: "Structural divergence" not "bifurcation". Stabilised yield-on-cost (5-5.5%) not NIY. Sellers value income, buyers value flexibility = the edge. Life sciences occupier = selective slowdown not frozen (Golden Triangle +42% YoY). Capital market illiquidity = commodity lab investment only. 18-36 month window. Seller psychology: open-ended fund redemptions, German Spezialfonds, REIT balance-sheet repair, developer refinance walls. Overseas capital = conviction arbitrage not TINA. Secondary offices = duration mismatch.

Deals: \${JSON.stringify(S.deals)}
Data: \${JSON.stringify(S.intel)}

JSON only: {"period":"\${fmtMonth()}","headline":"pricing regime signal, who wins","macro":"2-3 paras: cycle phase, seller psychology (who must sell and why), overseas capital logic, risk asymmetry","sector":"2-3 paras: prime offices as covered land plays, life sciences selective slowdown (Golden Triangle +42% YoY, 3.6m sqft pipeline, VC-constrained smaller occupiers), secondary as duration mismatch","deals":"2-3 paras: seller asymmetry, stabilised yield-on-cost vs NIY, development optionality","impl":"2-3 paras: 18-36 month window, three-tier strategy (prime offices 5-5.5% yield-on-cost, avoid secondary, selective Golden Triangle only)","out":"1-2 paras: leading indicators as thesis confirmers/invalidators"}`;
  try{const raw=await callClaude(prompt);const p=parseJSON(raw);Object.assign(S.narr,p);saveState();renderNarr();toast('Generated ‚úì','ok');}
  catch(err){toast(apiErrMsg(err),'err');}
}
function copyNarr(){const n=S.narr;navigator.clipboard.writeText(`CONDUIT INVESTORS ‚Äî MARKET NARRATIVE\n${n.period}\n\n${n.headline}\n\n1. MACRO\n${n.macro}\n\n2. LIFE SCIENCES\n${n.sector}\n\n3. TRANSACTIONS\n${n.deals}\n\n4. IMPLICATIONS\n${n.impl}\n\n5. OUTLOOK\n${n.out}\n\nCONFIDENTIAL`).then(()=>toast('Copied ‚úì','ok'));}
function clearNarr(){if(!confirm('Clear?'))return;S.narr={period:'',headline:'',macro:'',sector:'',deals:'',impl:'',out:''};saveState();renderNarr();toast('Cleared');}
const narrMap={nPeriod:'period',nHead:'headline',nMacro:'macro',nSector:'sector',nDeals:'deals',nImpl:'impl',nOut:'out'};
Object.entries(narrMap).forEach(([id,k])=>{const e=document.getElementById(id);if(e)e.addEventListener('input',()=>{S.narr[k]=e.textContent;saveState();});});

// ‚ïê‚ïê SHARE / REPORT GENERATION ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function generateReport(){
  const incW=document.getElementById('incWeekly')?.checked;
  const incD=document.getElementById('incDeals')?.checked;
  const incI=document.getElementById('incIntel')?.checked;
  const incN=document.getElementById('incNarr')?.checked;

  const today=new Date().toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});
  const kpiRows=S.kpis.map(k=>`<tr><td style="padding:10px 16px;font-size:14px;color:#6B7A8D;border-bottom:1px solid #E2D9CC">${k.label}</td><td style="padding:10px 16px;font-size:20px;font-family:'Georgia',serif;font-weight:700;color:${k.value?'#1C3355':'#ccc'};border-bottom:1px solid #E2D9CC">${k.value||'‚Äî'}</td></tr>`).join('');
  const dealRows=S.deals.slice(-30).reverse().map(d=>`<tr><td style="padding:9px 12px;font-size:13px;white-space:nowrap;border-bottom:1px solid #E2D9CC">${d.date||''}</td><td style="padding:9px 12px;font-size:13px;font-weight:700;color:#1C3355;border-bottom:1px solid #E2D9CC">${d.property||''}</td><td style="padding:9px 12px;font-size:13px;border-bottom:1px solid #E2D9CC">${d.location||''}</td><td style="padding:9px 12px;font-size:13px;border-bottom:1px solid #E2D9CC">${d.sector||''}</td><td style="padding:9px 12px;font-size:13px;font-weight:700;text-align:right;border-bottom:1px solid #E2D9CC">${d.price?'¬£'+d.price+'M':''}</td><td style="padding:9px 12px;font-size:13px;border-bottom:1px solid #E2D9CC">${d.yield||''}</td><td style="padding:9px 12px;font-size:13px;border-bottom:1px solid #E2D9CC">${d.status||''}</td></tr>`).join('');
  const intelRows=S.intel.filter(i=>i.priority==='High').slice(-20).reverse().map(i=>`<tr><td style="padding:9px 12px;font-size:13px;font-weight:700;color:#1C3355;border-bottom:1px solid #E2D9CC">${i.area||''}</td><td style="padding:9px 12px;font-size:13px;border-bottom:1px solid #E2D9CC">${i.metric||''}</td><td style="padding:9px 12px;font-size:15px;font-weight:700;border-bottom:1px solid #E2D9CC">${i.value||''}</td><td style="padding:9px 12px;font-size:16px;text-align:center;border-bottom:1px solid #E2D9CC">${i.trend||''}</td><td style="padding:9px 12px;font-size:13px;border-bottom:1px solid #E2D9CC">${i.date||''}</td></tr>`).join('');

  const report=`<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Conduit Investors ‚Äî Market Intelligence ‚Äî ${today}</title>
<link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@400;500;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}body{background:#F9F6F0;font-family:'DM Sans',sans-serif;font-size:15px;color:#2C3444;line-height:1.7}
.wrap{max-width:960px;margin:0 auto;padding:0 32px 80px}
.cover{background:#0F1F35;padding:60px 56px;margin-bottom:0;border-bottom:4px solid #B8922A}
.cover-eyebrow{font-size:11px;font-weight:700;letter-spacing:.2em;text-transform:uppercase;color:#B8922A;margin-bottom:10px}
.cover-title{font-family:'Cormorant Garamond',serif;font-size:52px;font-weight:700;color:#fff;line-height:1.05;margin-bottom:12px}
.cover-sub{font-size:15px;color:rgba(255,255,255,.5);margin-bottom:30px}
.cover-date{font-size:13px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:#D4A843}
.sec{margin-top:48px}
.sec-head{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;color:#1C3355;border-bottom:2px solid #E2D9CC;padding-bottom:10px;margin-bottom:20px}
.card{background:#fff;border:1px solid #E2D9CC;border-radius:10px;padding:24px 28px;margin-bottom:18px;box-shadow:0 1px 10px rgba(28,51,85,.05)}
.card-gold{border-left:4px solid #B8922A}
.kpi-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:1px;background:#E2D9CC;border:1px solid #E2D9CC;border-radius:10px;overflow:hidden;margin-bottom:20px}
.kpi-cell{background:#fff;padding:18px 20px}
.kpi-label{font-size:11px;color:#3a5068!important;font-weight:700;letter-spacing:.1em;text-transform:uppercase;color:#7A8A9A;margin-bottom:6px}
.kpi-val{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:700;color:#0F1F35}
.kpi-nil{color:#ccc;font-size:16px;font-style:italic;font-family:'DM Sans',sans-serif}
.week-box{background:linear-gradient(135deg,#0F1F35,#254470);border-radius:10px;padding:28px 32px;color:#fff;margin-bottom:18px}
.week-range{font-size:11px;font-weight:700;letter-spacing:.14em;text-transform:uppercase;color:#D4A843;margin-bottom:7px}
.week-headline{font-family:'Cormorant Garamond',serif;font-size:28px;font-weight:600;line-height:1.2;margin-bottom:10px}
.week-summary{font-size:14px;line-height:1.75;color:rgba(255,255,255,.72)}
table{width:100%;border-collapse:collapse}
thead tr{background:#0F1F35}
thead th{color:rgba(255,255,255,.8);font-size:10px;font-weight:700;letter-spacing:.1em;text-transform:uppercase;padding:12px 12px;text-align:left;white-space:nowrap}
.narr-section{margin-bottom:22px}
.narr-title{font-family:'Cormorant Garamond',serif;font-size:19px;font-weight:600;color:#1C3355;border-bottom:1.5px solid #E2D9CC;padding-bottom:7px;margin-bottom:10px}
.narr-body{font-size:14px;line-height:1.85;white-space:pre-wrap;color:#2C3444}
.footer{text-align:center;padding:32px 0;font-size:11px;color:#7A8A9A;letter-spacing:.08em;text-transform:uppercase;border-top:1px solid #E2D9CC;margin-top:48px}
@media(max-width:700px){.kpi-grid{grid-template-columns:1fr 1fr}.cover{padding:40px 24px}.wrap{padding:0 18px 60px}}
</style></head><body>
<div class="cover">
  <div class="wrap">
    <div class="cover-eyebrow">Market Intelligence Report</div>
    <div class="cover-title">London CRE<br>Intelligence</div>
    <div class="cover-sub">Conduit Investors ¬∑ ${S.deals.length} Deals Tracked ¬∑ ${S.intel.length} Market Data Points</div>
    <div class="cover-date">${today}</div>
  </div>
</div>
<div class="wrap">
  <div class="sec">
    <div class="sec-head">Key Market Indicators</div>
    <div class="kpi-grid">${S.kpis.map(k=>`<div class="kpi-cell"><div class="kpi-label">${k.label}</div><div class="kpi-val ${k.value?'':'kpi-nil'}">${k.value||'‚Äî'}</div></div>`).join('')}</div>
  </div>
  ${incW&&S.weekly&&S.weekly.headline?`<div class="sec">
    <div class="sec-head">Weekly Brief</div>
    <div class="week-box"><div class="week-range">${S.weekly.range||''}</div><div class="week-headline">${S.weekly.headline}</div><div class="week-summary">${S.weekly.summary||''}</div></div>
    ${S.weekly.deals_insight?`<div class="card"><div class="narr-title">Deals Analysis</div><div class="narr-body">${S.weekly.deals_insight}</div></div>`:''}
    ${S.weekly.implications?`<div class="card card-gold"><div class="narr-title">Investment Implications</div><div class="narr-body">${S.weekly.implications}</div></div>`:''}
    ${S.weekly.outlook?`<div class="card"><div class="narr-title">Watch List</div><div class="narr-body">${S.weekly.outlook}</div></div>`:''}
  </div>`:''}
  ${incD&&S.deals.length?`<div class="sec">
    <div class="sec-head">Deal Tracker ‚Äî Most Recent ${Math.min(30,S.deals.length)} of ${S.deals.length}</div>
    <div style="overflow-x:auto;border-radius:9px;border:1px solid #E2D9CC">
    <table><thead><tr><th>Date</th><th>Property</th><th>Location</th><th>Sector</th><th>Price ¬£M</th><th>Yield</th><th>Status</th></tr></thead>
    <tbody>${dealRows}</tbody></table></div>
  </div>`:''}
  ${incI&&S.intel.length?`<div class="sec">
    <div class="sec-head">Market Data ‚Äî High Priority Intelligence</div>
    <div style="overflow-x:auto;border-radius:9px;border:1px solid #E2D9CC">
    <table><thead><tr><th>Area</th><th>Metric</th><th>Figure</th><th>Trend</th><th>Date</th></tr></thead>
    <tbody>${intelRows}</tbody></table></div>
  </div>`:''}
  ${incN&&(S.narr.headline||S.narr.macro)?`<div class="sec">
    <div class="sec-head">Market Narrative ‚Äî ${S.narr.period||''}</div>
    ${S.narr.headline?`<div class="card card-gold"><p style="font-family:'Cormorant Garamond',serif;font-size:24px;font-style:italic;font-weight:600;color:#0F1F35">${S.narr.headline}</p></div>`:''}
    ${S.narr.macro?`<div class="card"><div class="narr-title">Macro &amp; Capital Markets</div><div class="narr-body">${S.narr.macro}</div></div>`:''}
    ${S.narr.sector?`<div class="card"><div class="narr-title">London Life Sciences</div><div class="narr-body">${S.narr.sector}</div></div>`:''}
    ${S.narr.deals?`<div class="card"><div class="narr-title">Key Transactions</div><div class="narr-body">${S.narr.deals}</div></div>`:''}
    ${S.narr.impl?`<div class="card card-gold"><div class="narr-title">Investment Implications</div><div class="narr-body">${S.narr.impl}</div></div>`:''}
    ${S.narr.out?`<div class="card"><div class="narr-title">Outlook</div><div class="narr-body">${S.narr.out}</div></div>`:''}
  </div>`:''}
  <div class="footer">Conduit Investors ¬∑ Confidential ¬∑ Not for Distribution ¬∑ Generated ${today}</div>
</div></body></html>`;

  const blob=new Blob([report],{type:'text/html'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');a.href=url;a.download='conduit-market-intelligence.html';
  document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Report downloaded ‚úì','ok');
}



function onLiveTab() {
  // Auto-fetch BoE data when tab opens
  fetchBoE();
}


// ‚ïê‚ïê LIVE DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function onLiveTab() {
  const warn = document.getElementById('localWarning');
  if(isLocal()){
    if(warn) warn.style.display='flex';
  } else {
    if(warn) warn.style.display='none';
    // Don't auto-fetch on every tab open ‚Äî user triggers manually
  }
}

function setNewsQuery(q) {
  const el = document.getElementById('newsQuery');
  if (el) { el.value = q; fetchAINews(); }
}

async function fetchAINews() {
  const query = (document.getElementById('newsQuery')?.value || '').trim();
  if (!query) { toast('Enter a search topic', 'err'); return; }
  const btn = document.getElementById('newsBtn');
  const st  = document.getElementById('newsStatus');
  const el  = document.getElementById('newsResults');
  if (btn) { btn.disabled=true; btn.textContent='Searching‚Ä¶'; }
  if (st)  { st.className='xstat on load'; st.style.display='flex'; st.innerHTML='<div class="spin"></div><span>Searching: '+esc(query)+'‚Ä¶</span>'; }
  if (el)  el.innerHTML = '';

  const key = getKey();
  if (!key) { openKeyModal(); if(btn){btn.disabled=false;btn.textContent='üîç Search News';} return; }

  try {
    // Step 1: web search ‚Äî keep max_tokens low to limit response size
    const r1 = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 1500,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        tool_choice: { type: 'auto' },
        messages: [{ role: 'user', content: 'Search for: ' + query + '. UK commercial real estate focus. Find deal values, buyers, yields.' }]
      })
    });
    const d1 = await r1.json();
    if (!r1.ok) throw new Error((d1.error&&d1.error.message)||'Search failed: HTTP '+r1.status);

    if (st) st.innerHTML = '<div class="spin"></div><span>Analysing‚Ä¶</span>';

    // Extract just the text content from search results to reduce token count
    const searchText = (d1.content||[])
      .filter(b => b.type === 'text' || b.type === 'tool_result')
      .map(b => {
        if (b.type === 'text') return b.text;
        if (b.type === 'tool_result') return JSON.stringify(b.content).slice(0, 2000);
        return '';
      })
      .join('\n').slice(0, 4000); // hard cap at 4000 chars

    if (!searchText.trim()) throw new Error('No search results returned ‚Äî try again');

    // Step 2: synthesise using just the extracted text, not the full conversation
    const r2 = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {'Content-Type':'application/json','x-api-key':key,'anthropic-version':'2023-06-01','anthropic-dangerous-direct-browser-access':'true'},
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 2000,
        messages: [{
          role: 'user',
          content: `Analyse these search results about "${query}" for a London CRE investor. Search results:

${searchText}

Return ONLY valid JSON, no markdown:
{"headlines":[{"title":"headline","source":"source","date":"date or empty","summary":"2-3 sentences with specific figures","relevance":"investment signal: dislocation or recovery?","url":"url or empty"}],"synthesis":"2-3 paragraphs: (1) pricing signal, (2) who is buying/selling and why, (3) what this means for London life sciences investment"}

Return 3-6 headlines from the search results.`
        }]
      })
    });
    const d2 = await r2.json();
    if (!r2.ok) throw new Error((d2.error&&d2.error.message)||'Analysis failed: HTTP '+r2.status);

    const text = (d2.content||[]).filter(b=>b.type==='text').map(b=>b.text).join('').trim();
    if (!text) throw new Error('No analysis returned');

    // Robust JSON parse
    let parsed;
    try {
      const cleaned = text.replace(/^```json\s*/,'').replace(/^```\s*/,'').replace(/\s*```$/,'').trim();
      parsed = JSON.parse(cleaned);
    } catch(e) {
      const m = text.match(/\{[\s\S]*\}/);
      if (m) parsed = JSON.parse(m[0]);
      else throw new Error('Could not parse response. The search may have returned no usable results.');
    }

    const headlines = parsed.headlines || [];
    const synthesis = parsed.synthesis || '';
    if (st) st.style.display = 'none';

    let html = '';
    if (synthesis) {
      html += `<div class="card card-gold" style="margin-bottom:18px">
        <div class="sh-sm" style="margin-bottom:8px">Intelligence ‚Äî ${esc(query)}</div>
        <p style="font-size:14px;line-height:1.85;white-space:pre-line">${esc(synthesis)}</p>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn bn bsm" onclick="addSynthesisToDigest(this.dataset.text)" data-text="${synthesis.replace(/"/g,'&quot;').replace(/'/g,'&#39;')}">‚Üí Digest</button>
          <button class="btn bo bsm" onclick="addSynthesisToNarr(this.dataset.text)" data-text="${synthesis.replace(/"/g,'&quot;').replace(/'/g,'&#39;')}">‚Üí Narrative</button>
        </div>
      </div>`;
    }
    if (headlines.length) {
      html += `<div style="margin-bottom:10px;font-size:12px;color:var(--mid);font-weight:600">${headlines.length} results ‚Äî ${esc(query)}</div>`;
      html += headlines.map(h=>`<div class="card" style="margin-bottom:10px">
        <div style="font-family:'Cormorant Garamond',serif;font-size:17px;font-weight:700;color:var(--navy3);margin-bottom:3px;line-height:1.3">${esc(h.title||'')}</div>
        ${(h.source||h.date)?`<div style="font-size:11px;color:var(--mid);margin-bottom:7px">${esc([h.source,h.date].filter(Boolean).join(' ¬∑ '))}</div>`:''}
        <p style="font-size:13px;line-height:1.7;margin-bottom:6px">${esc(h.summary||'')}</p>
        ${h.relevance?`<p style="font-size:12px;color:var(--gold3);font-style:italic;font-weight:600;margin-bottom:6px">üí° ${esc(h.relevance)}</p>`:''}
        ${h.url?`<a href="${esc(h.url)}" target="_blank" style="font-size:12px;color:var(--navy);font-weight:700">Read ‚Üí</a>`:''}
      </div>`).join('');
    }
    if (!headlines.length && !synthesis) html = '<div class="card" style="padding:30px;text-align:center"><p class="dnil">No results ‚Äî try different terms.</p></div>';
    if (el) el.innerHTML = html;
    toast('‚úì Intelligence fetched', 'ok');

  } catch(err) {
    const msg = err.message||'Unknown error';
    if (st) { st.className='xstat on bad'; st.style.display='flex'; st.innerHTML='<strong>Error:</strong>&nbsp;'+esc(msg); }
    toast(msg.slice(0,80), 'err');
  }
  if (btn) { btn.disabled=false; btn.textContent='üîç Search News'; }
}


function addSynthesisToDigest(text) {
  S.digest.summary = text.slice(0, 800);
  saveState();
  toast('Added to Digest ‚úì', 'ok');
}

function addSynthesisToNarr(text) {
  // Add to the macro section of the narrative, appending if already has content
  if (!S.narr.macro || !S.narr.macro.trim()) {
    S.narr.macro = text;
  } else {
    S.narr.macro = S.narr.macro + '\n\n' + text;
  }
  saveState();
  toast('Added to Narrative ‚úì', 'ok');
}

async function importLRPaste() {
  const text = (document.getElementById('lrPaste')?.value || '').trim();
  if (!text) { toast('Paste some Land Registry data first', 'err'); return; }
  const st  = document.getElementById('lrPasteStatus');
  const el  = document.getElementById('lrPasteResults');
  if (st) { st.className='xstat on load'; st.style.display='flex'; st.innerHTML='<div class="spin"></div><span>Parsing with AI‚Ä¶</span>'; }
  if (el) el.innerHTML = '';

  const prompt = `You are a London CRE data analyst. Parse this Land Registry transaction data and extract structured deal records.

Data:
${text}

Extract every transaction. Respond ONLY with JSON:
{"deals": [{"date": "YYYY-MM-DD", "property": "property name or address", "location": "area/town", "sector": "Commercial", "price": "price in millions as number e.g. 12.5", "status": "Completed", "relevance": "HM Land Registry verified transaction", "source": "HM Land Registry", "lrPostcode": "postcode if present"}]}

If no transactions found: {"deals": [], "note": "reason"}`;

  try {
    const raw = await callClaude(prompt);
    const parsed = parseJSON(raw);
    const deals = parsed.deals || [];
    if (!deals.length) {
      if (st) { st.className='xstat on bad'; st.style.display='flex'; st.innerHTML=parsed.note||'No transactions found in the pasted data.'; }
      return;
    }
    deals.forEach(d => S.deals.push(d));
    saveState(); updateCounts();
    if (st) st.style.display = 'none';
    if (el) el.innerHTML = `<div class="card" style="border-left:4px solid var(--green)">
      <p style="font-weight:700;color:var(--green);margin-bottom:10px">‚úì Imported ${deals.length} transaction${deals.length!==1?'s':''}</p>
      ${deals.map(d=>`<div class="rp-row"><strong>${esc(d.property)}</strong>${d.location?' ‚Äî '+esc(d.location):''}${d.price?' ¬∑ <strong>¬£'+esc(d.price)+'M</strong>':''}</div>`).join('')}
      <button class="btn bo bsm" style="margin-top:12px" onclick="go('deals')">View in Deal Tracker ‚Üí</button>
    </div>`;
    document.getElementById('lrPaste').value = '';
    toast('Imported '+deals.length+' deals ‚úì', 'ok');
  } catch(err) {
    if (st) { st.className='xstat on bad'; st.style.display='flex'; st.innerHTML=apiErrMsg(err); }
  }
}

async function fetchRatesAI() {
  const st  = document.getElementById('ratesStatus');
  const el  = document.getElementById('ratesResults');
  if (st) { st.className='xstat on load'; st.style.display='flex'; st.innerHTML='<div class="spin"></div><span>Fetching current rates‚Ä¶</span>'; }
  if (el) el.innerHTML = '';

  const key = getKey();
  if (!key) { openKeyModal(); return; }

  const prompt = `Search the web for the current UK financial rates as of today. Return ONLY JSON:
{
  "base_rate": "current Bank of England base rate as percentage e.g. 4.75",
  "gilt_10yr": "current 10-year UK gilt yield as percentage",
  "sonia": "current SONIA overnight rate",
  "date_checked": "today's date",
  "notes": "any relevant context e.g. recent MPC decision"
}`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': key,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-haiku-4-5-20251001',
        max_tokens: 512,
        tools: [{ type: 'web_search_20250305', name: 'web_search' }],
        messages: [{ role: 'user', content: prompt }]
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error((data.error && data.error.message) || 'HTTP ' + res.status);
    const text = (data.content || []).filter(b => b.type === 'text').map(b => b.text).join('');
    const rates = parseJSON(text);
    if (st) st.style.display = 'none';

    // Auto-update KPIs
    if (rates.base_rate) setKpiQuick('Bank of England Base Rate', rates.base_rate + '%');
    if (rates.gilt_10yr) setKpiQuick('10-Year UK Gilt Yield', rates.gilt_10yr + '%');

    if (el) el.innerHTML = `<div class="stat-strip" style="max-width:700px;margin-bottom:14px">
      ${rates.base_rate?`<div class="stat-cell"><div class="stat-label">BoE Base Rate</div><div class="stat-val">${esc(rates.base_rate)}%</div></div>`:''}
      ${rates.gilt_10yr?`<div class="stat-cell"><div class="stat-label">10Y Gilt Yield</div><div class="stat-val">${esc(rates.gilt_10yr)}%</div></div>`:''}
      ${rates.sonia?`<div class="stat-cell"><div class="stat-label">SONIA</div><div class="stat-val">${esc(rates.sonia)}%</div></div>`:''}
    </div>
    ${rates.notes?`<p style="font-size:13px;color:var(--mid)">${esc(rates.notes)}</p>`:''}
    <p style="font-size:11px;color:var(--mid);margin-top:8px">KPI strip updated automatically. Checked: ${esc(rates.date_checked||'today')}</p>`;
    toast('Rates updated ‚úì', 'ok');
  } catch(err) {
    if (st) { st.className='xstat on bad'; st.style.display='flex'; st.innerHTML=apiErrMsg(err); }
  }
}

function setKpiQuick(label, value) {
  if (!value || !value.trim()) return;
  const kpi = S.kpis.find(k => k.label.toLowerCase().includes(label.toLowerCase().slice(0,12)));
  if (kpi) { kpi.value = value.trim(); saveState(); toast(label.slice(0,20)+' updated ‚úì', 'ok'); }
}


// ‚ïê‚ïê UTILS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function esc(s){if(s===null||s===undefined)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function setText(id,val){const e=document.getElementById(id);if(e)e.textContent=val||'';}
function todayISO(){return new Date().toISOString().slice(0,10);}
function fmtDate(iso){try{return new Date(iso+'T12:00:00').toLocaleDateString('en-GB',{day:'numeric',month:'long',year:'numeric'});}catch(e){return iso;}}
function fmtMonth(){return new Date().toLocaleDateString('en-GB',{month:'long',year:'numeric'});}
function csvCell(x){if(x==null)return'';const s=String(x);return(s.includes(',')||s.includes('"')||s.includes('\n'))?'"'+s.replace(/"/g,'""')+'"':s;}
function dlCSV(name,rows){const a=document.createElement('a');a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(rows.map(r=>r.join(',')).join('\n'));a.download=name;document.body.appendChild(a);a.click();document.body.removeChild(a);}
function v(id){const e=document.getElementById(id);return e?e.value:'';}


// ‚ïê‚ïê EXPORT / IMPORT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function exportData() {
  const data = localStorage.getItem('conduit-cre-v2') || localStorage.getItem('conduit-cre-v1');
  if (!data) { toast('No data to export', 'err'); return; }
  const blob = new Blob([data], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().slice(0,10);
  a.href = url;
  a.download = 'conduit-data-' + date + '.json';
  document.body.appendChild(a); a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  toast('Data exported ‚úì ‚Äî ' + S.deals.length + ' deals, ' + S.intel.length + ' data points', 'ok');
}

function importData(event) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const raw = e.target.result;
      let parsed = JSON.parse(raw);

      // Handle different export formats
      // Format 1: direct state object {deals:[], intel:[], ...}
      // Format 2: old platform export {data: {deals:[], intel:[]}}
      // Format 3: array of deals [{property:...}, ...]
      if (Array.isArray(parsed)) {
        // It's an array ‚Äî could be deals or intel
        const isDeals = parsed.length && parsed[0].property;
        parsed = isDeals ? {deals: parsed, intel: []} : {deals: [], intel: parsed};
      } else if (parsed.data && (parsed.data.deals || parsed.data.intel)) {
        parsed = parsed.data;
      }

      // Extract what we can
      const deals = parsed.deals || parsed.transactions || [];
      const intel = parsed.intel || parsed.marketData || parsed.market_data || [];
      const articles = parsed.articles || [];
      const kpis = parsed.kpis || [];

      if (!deals.length && !intel.length) {
        throw new Error('No deals or market data found in this file. Make sure you exported from a Conduit platform using the üíæ Export Data button.');
      }

      // Merge into current state rather than overwrite, so you don't lose anything
      const merged = JSON.parse(JSON.stringify(S));
      if (deals.length) {
        // Deduplicate by property+date
        const existing = new Set(S.deals.map(d => (d.property||'')+'|'+(d.date||'')));
        const newDeals = deals.filter(d => !existing.has((d.property||'')+'|'+(d.date||'')));
        merged.deals = [...S.deals, ...newDeals];
      }
      if (intel.length) {
        const existingI = new Set(S.intel.map(i => (i.metric||'')+'|'+(i.date||'')+'|'+(i.value||'')));
        const newIntel = intel.filter(i => !existingI.has((i.metric||'')+'|'+(i.date||'')+'|'+(i.value||'')));
        merged.intel = [...S.intel, ...newIntel];
      }
      if (articles.length) merged.articles = articles;
      if (kpis.length) merged.kpis = kpis;
      if (parsed.narr) merged.narr = parsed.narr;
      if (parsed.digest) merged.digest = parsed.digest;
      if (parsed.weekly) merged.weekly = parsed.weekly;

      localStorage.setItem('conduit-cre-v2', JSON.stringify(merged));
      loadState();
      renderDash();
      updateCounts();

      const addedDeals = merged.deals.length - S.deals.length;
      toast('‚úì Import complete ‚Äî ' + merged.deals.length + ' deals, ' + merged.intel.length + ' data points', 'ok');
    } catch(err) {
      toast('Import failed: ' + err.message, 'err');
      console.error('Import error:', err);
    }
    event.target.value = '';
  };
  reader.readAsText(file);
}

// ‚ïê‚ïê INIT ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function isLocal() {
  return location.protocol === 'file:';
}

function init(){
  document.getElementById('mdate').textContent=new Date().toLocaleDateString('en-GB',{weekday:'long',day:'numeric',month:'long',year:'numeric'});
  document.getElementById('artDate').value=todayISO();
  loadState();renderDash();updateKeyBtn();
  if(!getKey()){setTimeout(openKeyModal,700);return;}
  // Auto-fetch on startup when hosted (not local file)
  // Auto-fetch disabled on startup to avoid rate limits
  // Rates and news fetch when you open the Live Data tab
  // Fetch market ticker after short delay
  if (!isLocal()) setTimeout(fetchTicker, 2000);
}
init();

// Enter key on learn input
document.addEventListener('DOMContentLoaded', () => {
  const lq = document.getElementById('learn-q');
  if (lq) lq.addEventListener('keydown', e => { if(e.key==='Enter') learnAsk(); });
});
</script>
</body>
</html>